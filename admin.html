<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - KenyaOnABudget Safaris</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="shortcut icon" href="logo1.png" type="image/x-icon">
    <link rel="stylesheet" href="admin-dashboard.css">
    <style>
        /* 
 * Message Thread Scrolling Fix
 * Add this CSS to your admin-dashboard.css file or include as a separate stylesheet
 */

/* Ensure the message thread container has proper height and scrolling */
/* Tours Management Styles */

/* Main container and actions */
.tour-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}
/* Add these styles */
#refreshThreadBtn {
  margin-right: 10px;
}

#refreshThreadBtn.loading i {
  animation: spin s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.filter-controls {
  display: flex;
  gap: 15px;
}

/* Data table styling */
.table-responsive {
  overflow-x: auto;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
  background-color: white;
}

.data-table th {
  padding: 12px 15px;
  text-align: left;
  background-color: #f8f9fa;
  border-bottom: 2px solid #e9ecef;
  font-weight: 600;
  color: #495057;
}

.data-table td {
  padding: 12px 15px;
  border-bottom: 1px solid #e9ecef;
  vertical-align: middle;
}

.data-table tr:hover {
  background-color: #f8f9fa;
}

/* Tour status badges */
.tour-status {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.8rem;
  font-weight: 500;
}

.status-confirmed {
  background-color: #e6f7ef;
  color: #2ecc71;
}

.status-inprogress {
  background-color: #e8f4fd;
  color: #3498db;
}

.status-completed {
  background-color: #eee;
  color: #555;
}

.status-cancelled {
  background-color: #fde7e6;
  color: #e74c3c;
}

/* Tour client and guide styling */
.tour-client, .tour-guide {
  display: flex;
  align-items: center;
  gap: 8px;
}

.client-avatar, .guide-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
  font-size: 0.8rem;
}

.client-avatar {
  background-color: #3498db;
}

.guide-avatar {
  background-color: #e67e22;
}

/* Action buttons */
.action-buttons {
  display: flex;
  gap: 8px;
}

.action-btn {
  width: 32px;
  height: 32px;
  border-radius: 4px;
  border: none;
  background-color: #f5f5f5;
  color: #555;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background-color 0.2s;
}

.action-btn:hover {
  background-color: #e5e5e5;
}

.action-btn.view {
  background-color: #e8f4fd;
  color: #3498db;
}

.action-btn.view:hover {
  background-color: #d6eafb;
}

.action-btn.edit {
  background-color: #fff5eb;
  color: #e67e22;
}

.action-btn.edit:hover {
  background-color: #fdebd0;
}

/* Modal styling */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal.active {
  display: flex;
}

.modal-content {
  background-color: white;
  border-radius: 10px;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-lg {
  max-width: 800px;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  border-bottom: 1px solid #eee;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  color: #aaa;
  cursor: pointer;
}

.modal-close:hover {
  color: #555;
}

.modal-body {
  padding: 20px;
}

/* Form styling */
.form-row {
  display: flex;
  flex-wrap: wrap;
  margin-right: -10px;
  margin-left: -10px;
  margin-bottom: 15px;
}

.form-group {
  margin-bottom: 15px;
  padding-right: 10px;
  padding-left: 10px;
}

.col-md-6 {
  flex: 0 0 50%;
  max-width: 50%;
}

.form-control {
  display: block;
  width: 100%;
  padding: 8px 12px;
  font-size: 14px;
  line-height: 1.5;
  color: #495057;
  background-color: #fff;
  border: 1px solid #ced4da;
  border-radius: 4px;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus {
  border-color: #80bdff;
  outline: 0;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.form-control[readonly] {
  background-color: #f8f9fa;
  opacity: 0.8;
}

label {
  display: inline-block;
  margin-bottom: 5px;
  font-weight: 500;
  color: #495057;
}

.date-range-wrapper {
  display: flex;
  align-items: center;
  gap: 10px;
}

.date-range-wrapper span {
  color: #666;
}

.tour-metadata {
  background-color: #f8f9fa;
  padding: 10px 15px;
  border-radius: 4px;
  font-size: 0.9rem;
}

.form-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 20px;
}

.btn-primary, .btn-cancel {
  padding: 8px 16px;
  border-radius: 4px;
  border: none;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
}

.btn-primary {
  background-color: #e67e22;
  color: white;
}

.btn-primary:hover {
  background-color: #d35400;
}

.btn-cancel {
  background-color: #f5f5f5;
  color: #555;
}

.btn-cancel:hover {
  background-color: #e5e5e5;
}

/* Tour detail styling */
.tour-detail-header {
  margin-bottom: 20px;
  border-bottom: 1px solid #eee;
  padding-bottom: 15px;
}

.tour-detail-id {
  font-size: 0.9rem;
  color: #777;
  margin-bottom: 8px;
}

.tour-detail-status {
  margin-top: 10px;
}

.tour-detail-section {
  margin-bottom: 20px;
}

.tour-detail-section h4 {
  margin-bottom: 10px;
  font-size: 1.1rem;
  color: #333;
}

.detail-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}

.detail-item {
  display: flex;
  flex-direction: column;
}

.detail-label {
  font-size: 0.8rem;
  color: #777;
  margin-bottom: 3px;
}

.detail-value {
  font-weight: 500;
}

.detail-notes {
  background-color: #f9f9f9;
  padding: 15px;
  border-radius: 5px;
  font-size: 0.95rem;
  color: #333;
  white-space: pre-line;
}

/* Loading state */
.loading-row {
  text-align: center;
  padding: 40px 0;
}

.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 0;
}

.spinner {
  width: 30px;
  height: 30px;
  border: 3px solid rgba(0, 0, 0, 0.1);
  border-radius: 50%;
  border-top-color: #e67e22;
  animation: spin 1s ease-in-out infinite;
  margin-bottom: 10px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Empty state */
.empty-state {
  text-align: center;
  padding: 40px 0;
  color: #777;
}

.empty-state i {
  font-size: 2.5rem;
  margin-bottom: 15px;
  color: #ddd;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .tour-actions {
    flex-direction: column;
    align-items: stretch;
    gap: 15px;
  }
  
  .filter-controls {
    flex-direction: column;
  }
  
  .form-row {
    flex-direction: column;
  }
  
  .col-md-6 {
    flex: 0 0 100%;
    max-width: 100%;
  }
  
  .action-buttons {
    flex-direction: column;
    gap: 5px;
  }
  
  .action-btn {
    width: 100%;
  }
  
  .detail-grid {
    grid-template-columns: 1fr;
  }
}
.message-thread {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 20px;
    max-height: 400px; /* Set a maximum height to enable scrolling */
    min-height: 200px; /* Ensure there's enough space for scrolling to be useful */
}

/* Fix the overall message detail container structure */
.message-detail-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden; /* Prevent double scrollbars */
}

.message-detail {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden; /* Prevent double scrollbars */
}

/* Ensure the message detail content fills available space */
#messageDetailContent {
    display: flex;
    flex-direction: column;
    height: 100%;
}


/* Make sure message reply form doesn't grow too large */
.message-reply-form {
    padding: 20px;
    border-top: 1px solid #eee;
    background-color: #f9f9f9;
}

.message-reply-form textarea {
    max-height: 150px;
    min-height: 80px;
}

/* Fix positioning of message bubbles in thread */
.message-bubble {
    display: flex;
    align-items: flex-start;
    max-width: 80%;
}

.message-bubble.client {
    align-self: flex-start;
}

.message-bubble.support {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.message-bubble-content {
    background-color: #f5f5f5;
    padding: 15px;
    border-radius: 10px;
    position: relative;
    word-wrap: break-word; /* Ensure long text wraps properly */
    max-width: 100%; /* Ensure content doesn't overflow */
}

.message-bubble.support .message-bubble-content {
    background-color: #e8f4fd;
}

/* Adjust message thread layout for better readability */
.messages-container {
    display: flex;
    height: calc(100vh - 180px);
    background-color: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.messages-list-container {
    width: 350px;
    border-right: 1px solid #eee;
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Prevent double scrollbars */
}

.messages-list {
    flex: 1;
    overflow-y: auto;
}

/* Ensure proper scrolling for mobile */
@media (max-width: 768px) {
    .messages-container {
        flex-direction: column;
        height: auto;
    }
    
    .messages-list-container {
        width: 100%;
        max-height: 300px;
        border-right: none;
        border-bottom: 1px solid #eee;
    }
    
    .message-detail-container {
        height: 500px;
    }
    
    .message-thread {
        max-height: 300px;
    }
}
    </style>
</head>
<body>
    <!-- Main Dashboard Container -->
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <img src="logo1.png" alt="KenyaOnABudget Logo">
                    <span>KenyaOnABudget</span>
                </div>
                <p class="admin-title">Admin Dashboard</p>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <p class="nav-section-title">Main</p>
                    <ul class="nav-items">
                        <li class="nav-item active" data-section="dashboard">
                            <i class="fas fa-th-large"></i>
                            <span>Dashboard</span>
                        </li>
                    </ul>
                </div>
                <div class="nav-section">
                    <p class="nav-section-title">Communication</p>
                    <ul class="nav-items">
                        <li class="nav-item" data-section="support-messages">
                            <i class="fas fa-headset"></i>
                            <span>Support Messages</span>
                            <span class="badge" id="supportMessagesBadge">0</span>
                        </li>
                        
                    </ul>
                </div>
                
                <div class="nav-section">
                    <p class="nav-section-title">Guide Management</p>
                    <ul class="nav-items">
                        <li class="nav-item" data-section="guide-assignment">
                            <i class="fas fa-user-plus"></i>
                            <span>Guide Assignment</span>
                        </li>
                        <li class="nav-item" data-section="guides">
                            <i class="fas fa-users"></i>
                            <span>All Guides</span>
                        </li>
                    </ul>
                </div>
                
                <div class="nav-section">
                    <p class="nav-section-title">Bookings & Tours</p>
                    <ul class="nav-items">
                        <li class="nav-item" data-section="bookings">
                            <i class="fas fa-calendar-check"></i>
                            <span>Bookings</span>
                        </li>
                        <li class="nav-item" data-section="tours">
                            <i class="fas fa-map-marked-alt"></i>
                            <span>Tours</span>
                        </li>
                        <li class="nav-item" data-section="reports">
                            <i class="fas fa-file-alt"></i>
                            <span>Tour Reports</span>
                        </li>
                    </ul>
                </div>
                
                
                
                <div class="nav-section">
                    <p class="nav-section-title">System</p>
                    <ul class="nav-items">
                        <li class="nav-item" data-section="settings">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </li>
                        <li class="nav-item" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </li>
                    </ul>
                </div>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="toggle-sidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title">Dashboard</h1>
                </div>
                <div class="header-right">
                    <div class="admin-profile">
                        <div class="admin-info">
                            <p class="admin-name" id="adminName">Admin User</p>
                            <p class="admin-role">Super Admin</p>
                        </div>
                        <div class="admin-avatar">
                            <img id="adminAvatar" src="profile.png" alt="Admin">
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Dashboard Content Wrapper -->
            <div class="content-wrapper">
                <!-- Dashboard Overview Section -->
                <section id="dashboard-section" class="content-section active">
                    <div class="section-header">
                        <h2>Dashboard Overview</h2>
                        <p class="section-description">Welcome to the KenyaOnABudget Safaris Admin Dashboard</p>
                    </div>
                    
                    <!-- Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon bookings-icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="stat-info">
                                <h3 class="stat-title">Active Bookings</h3>
                                <p class="stat-value" id="activeBookingsCount">0</p>
                                <p class="stat-change positive">+5% from last month</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon guides-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h3 class="stat-title">Active Guides</h3>
                                <p class="stat-value" id="activeGuidesCount">0</p>
                                <p class="stat-change neutral">No change</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon messages-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="stat-info">
                                <h3 class="stat-title">Unread Messages</h3>
                                <p class="stat-value" id="unreadMessagesCount">0</p>
                                <p class="stat-change negative">+12% from last week</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon revenue-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-info">
                                <h3 class="stat-title">Monthly Revenue</h3>
                                <p class="stat-value" id="monthlyRevenue">$0</p>
                                <p class="stat-change positive">+8% from last month</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Access Cards -->
                    <div class="quick-access-grid">
                        <div class="quick-access-card" onclick="navigateTo('guide-assignment')">
                            <div class="quick-icon">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <h3>Assign Guides</h3>
                            <p>Assign guides to pending bookings</p>
                        </div>
                        
                        <div class="quick-access-card" onclick="navigateTo('support-messages')">
                            <div class="quick-icon">
                                <i class="fas fa-headset"></i>
                            </div>
                            <h3>Support Messages</h3>
                            <p>View and respond to support requests</p>
                        </div>
                        
                        <div class="quick-access-card" onclick="navigateTo('bookings')">
                            <div class="quick-icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <h3>Bookings</h3>
                            <p>Manage all tour bookings</p>
                        </div>
                        
                        <div class="quick-access-card" onclick="navigateTo('reports')">
                            <div class="quick-icon">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <h3>Reports</h3>
                            <p>View submitted tour reports</p>
                        </div>
                    </div>
                    
                    <!-- Recent Activity -->
                    <div class="recent-activity-section">
                        <div class="section-header">
                            <h3>Recent Activity</h3>
                            <button class="refresh-btn">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        
                        <div class="activity-list" id="recentActivityList">
                            <div class="activity-item">
                                <div class="activity-icon bookings-activity">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                                <div class="activity-content">
                                    <p class="activity-title">New Booking</p>
                                    <p class="activity-description">John Doe booked the Premium Safari Package</p>
                                    <p class="activity-time">10 minutes ago</p>
                                </div>
                            </div>
                            
                            <div class="activity-item">
                                <div class="activity-icon guides-activity">
                                    <i class="fas fa-user-plus"></i>
                                </div>
                                <div class="activity-content">
                                    <p class="activity-title">Guide Assigned</p>
                                    <p class="activity-description">Caroline Wanjiku was assigned to the Smith Family safari</p>
                                    <p class="activity-time">2 hours ago</p>
                                </div>
                            </div>
                            
                            <div class="activity-item">
                                <div class="activity-icon messages-activity">
                                    <i class="fas fa-envelope"></i>
                                </div>
                                <div class="activity-content">
                                    <p class="activity-title">Support Message</p>
                                    <p class="activity-description">New support request from Emma Johnson</p>
                                    <p class="activity-time">4 hours ago</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Guide Assignment Section -->
                <section id="guide-assignment-section" class="content-section">
                    <div class="section-header">
                        <h2>Guide Assignment</h2>
                        <p class="section-description">Assign guides to pending bookings</p>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Pending Bookings</h3>
                            <div class="header-actions">
                                <div class="search-box">
                                    <input type="text" id="bookingSearchInput" placeholder="Search bookings...">
                                    <i class="fas fa-search"></i>
                                </div>
                                <select id="bookingStatusFilter">
                                    <option value="all">All Statuses</option>
                                    <option value="Pending" selected>Guide Pending</option>
                                    <option value="Assigned">Guide Assigned</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <table class="data-table" id="pendingBookingsTable">
                                <thead>
                                    <tr>
                                        <th>Booking ID</th>
                                        <th>Client Name</th>
                                        <th>Package</th>
                                        <th>Booking Date</th>
                                        <th>Guide Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingBookingsList">
                                    <tr>
                                        <td colspan="6" class="loading-row">
                                            <div class="spinner"></div>
                                            <span>Loading bookings...</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Support Messages Section -->
                <section id="support-messages-section" class="content-section">
                    <div class="section-header">
                        <h2>Support Messages</h2>
                        <p class="section-description">Manage and respond to customer support messages</p>
                        
                    </div>
                    
                    <div class="messages-container">
                        <!-- Messages List -->
                        <div class="messages-list-container">
                            <div class="messages-list-header">
                                <h3>Conversations</h3>
                                
                                <div class="message-filters">
                                    <select id="messageStatusFilter">
                                        <option value="all">All Messages</option>
                                        <option value="unread">Unread</option>
                                        <option value="read">Read</option>
                                    </select>
                                    <div class="search-box">
                                        <input type="text" id="messageSearchInput" placeholder="Search messages...">
                                        <i class="fas fa-search"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="messages-list" id="supportMessagesList">
                                <div class="loading-container">
                                    <div class="spinner"></div>
                                    <p>Loading messages...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Message Detail -->
                        <div class="message-detail-container">
                            <div class="message-detail-placeholder" id="messageDetailPlaceholder">
                                <div class="placeholder-icon">
                                    <i class="fas fa-comments"></i>
                                </div>
                                <h3>Select a conversation</h3>
                                <p>Choose a conversation from the list to view messages and respond</p>
                            </div>
                            
                            <div class="message-detail" id="messageDetailContent" style="display: none;">
                                <div class="message-detail-header">
                                    <div class="message-sender-info">
                                        <div class="sender-avatar">
                                            <span id="senderInitials">JD</span>
                                        </div>
                                        <div class="sender-details">
                                            <h3 id="senderName">John Doe</h3>
                                            <p id="messageSubject">Question about safari booking</p>
                                        </div>
                                    </div>
                                    
                                    <div class="message-actions">
                                        
                                        <button class="action-btn" id="markAsReadBtn">
                                            <i class="fas fa-envelope-open"></i>
                                            <span>Mark as Read</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="message-thread" id="messageThread">
                                    <!-- Message bubbles will be populated here -->
                                </div>
                                
                                <div class="message-reply-form">
                                    <form id="supportReplyForm">
                                        <div class="form-group">
                                            <textarea id="replyContent" placeholder="Type your reply here..." required></textarea>
                                        </div>
                                        <div class="form-actions">
                                            <button type="submit" class="btn-primary">
                                                <i class="fas fa-paper-plane"></i>
                                                Send Reply
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Placeholder for other sections -->
                <section id="guides-section" class="content-section">
                    <div class="section-header">
                        <h2>All Guides</h2>
                        <p class="section-description">Manage safari guides</p>
                    </div>
                    <div class="placeholder-content">
                        <i class="fas fa-users"></i>
                        <h3>Guides Management</h3>
                        <p>This section is under development</p>
                    </div>
                </section>
                
                <section id="bookings-section" class="content-section">
                    <div class="section-header">
                        <h2>Bookings</h2>
                        <p class="section-description">Manage all bookings</p>
                    </div>
                    <div class="placeholder-content">
                        <i class="fas fa-calendar-check"></i>
                        <h3>Bookings Management</h3>
                        <p>This section is under development</p>
                    </div>
                </section>
                
                <section id="tours-section" class="content-section">
                    <div class="section-header">
                        <h2>Tours</h2>
                        <p class="section-description">Manage active tours</p>
                    </div>
                    <div class="placeholder-content">
                        <i class="fas fa-map-marked-alt"></i>
                        <h3>Tours Management</h3>
                        <p>This section is under development</p>
                    </div>
                </section>
                
                <section id="reports-section" class="content-section">
                    <div class="section-header">
                        <h2>Tour Reports</h2>
                        <p class="section-description">View and manage tour reports</p>
                    </div>
                    <div class="placeholder-content">
                        <i class="fas fa-file-alt"></i>
                        <h3>Tour Reports</h3>
                        <p>This section is under development</p>
                    </div>
                </section>
                
                <section id="announcements-section" class="content-section">
                    <div class="section-header">
                        <h2>Announcements</h2>
                        <p class="section-description">Create and manage announcements</p>
                    </div>
                    <div class="placeholder-content">
                        <i class="fas fa-bullhorn"></i>
                        <h3>Announcements</h3>
                        <p>This section is under development</p>
                    </div>
                </section>
                
                <section id="settings-section" class="content-section">
                    <div class="section-header">
                        <h2>Settings</h2>
                        <p class="section-description">Manage system settings</p>
                    </div>
                    <div class="placeholder-content">
                        <i class="fas fa-cog"></i>
                        <h3>System Settings</h3>
                        <p>This section is under development</p>
                    </div>
                </section>
            </div>
        </main>
    </div>
    
    <!-- Guide Assignment Modal -->
    <div class="modal" id="guideAssignmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Assign Guide to Booking</h3>
                <button class="modal-close" id="closeAssignmentModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="booking-details">
                    <h4>Booking Details</h4>
                    <p><strong>Booking ID:</strong> <span id="assignmentBookingId">-</span></p>
                    <p><strong>Client:</strong> <span id="assignmentClientName">-</span></p>
                    <p><strong>Package:</strong> <span id="assignmentPackage">-</span></p>
                    <p><strong>Booking Date:</strong> <span id="assignmentBookingDate">-</span></p>
                </div>
                
                <div class="guide-selection-container">
                    <h4>Select Guide</h4>
                    <div class="form-group">
                        <select id="guideSelectDropdown" class="guide-select">
                            <option value="" selected disabled>Select a guide...</option>
                            <!-- Guides will be loaded dynamically -->
                        </select>
                    </div>
                    
                    <div id="selectedGuidePreview" class="selected-guide-preview" style="display: none;">
                        <div class="guide-preview-header">
                            <h4>Selected Guide</h4>
                            <button type="button" id="changeGuideButton" class="text-button">Change</button>
                        </div>
                        <div class="guide-preview-content">
                            <div class="guide-preview-avatar">
                                <img id="previewGuideImage" src="profile.png" alt="Guide">
                            </div>
                            <div class="guide-preview-details">
                                <h5 id="previewGuideName">Guide Name</h5>
                                <p id="previewGuideExperience">Experience</p>
                                <p id="previewGuideLanguages">Languages</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-cancel" id="cancelAssignment">Cancel</button>
                    <button type="button" class="btn-primary" id="confirmAssignment">Assign Guide</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase Scripts -->
    <script>
        // Direct fix for guide assignment
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Installing direct guide assignment fix...");
            
            // Wait for Firebase and other dependencies to load
            setTimeout(function() {
                // Find and replace the assign guide button click handlers
                document.querySelectorAll('.action-btn').forEach(btn => {
                    if (btn.textContent.includes('Assign Guide')) {
                        // Remove original click handler and add our own
                        const originalOnClick = btn.onclick;
                        const bookingId = btn.onclick.toString().match(/openAssignmentModal\(['"]([^'"]+)['"]\)/)?.[1];
                        
                        if (bookingId) {
                            console.log(`Found assign button for booking: ${bookingId}`);
                            btn.onclick = function(e) {
                                e.preventDefault();
                                safeOpenAssignmentModal(bookingId);
                            };
                        }
                    }
                });
                
                // Create our own versions of the guide assignment functions
                window.safeOpenAssignmentModal = function(bookingId) {
                    console.log(`Safe opening assignment modal for booking: ${bookingId}`);
                    
                    // Store the booking ID globally for later use
                    window.safeBookingId = bookingId;
                    
                    // Find the modal
                    const modal = document.getElementById('guideAssignmentModal');
                    if (!modal) {
                        console.error("Assignment modal not found");
                        alert("Assignment modal not found. Please refresh the page and try again.");
                        return;
                    }
                    
                    // Show the modal
                    modal.classList.add('active');
                    
                    // Update booking details in modal (if elements exist)
                    if (document.getElementById('assignmentBookingId')) {
                        document.getElementById('assignmentBookingId').textContent = bookingId.substring(0, 8) + '...';
                    }
                    
                    // Load booking details from Firebase if possible
                    try {
                        const db = firebase.firestore();
                        db.collection("bookings").doc(bookingId).get().then(doc => {
                            if (doc.exists) {
                                const booking = doc.data();
                                if (document.getElementById('assignmentClientName')) {
                                    document.getElementById('assignmentClientName').textContent = booking.clientName || 'Unknown';
                                }
                                if (document.getElementById('assignmentPackage')) {
                                    document.getElementById('assignmentPackage').textContent = booking.packageName || booking.packageType || 'Unknown';
                                }
                                
                                const bookingDate = booking.bookingDate ? 
                                    new Date(booking.bookingDate.seconds * 1000).toLocaleDateString() : 
                                    'Not available';
                                
                                if (document.getElementById('assignmentBookingDate')) {
                                    document.getElementById('assignmentBookingDate').textContent = bookingDate;
                                }
                            }
                        }).catch(err => {
                            console.error("Error loading booking:", err);
                        });
                    } catch (e) {
                        console.error("Error accessing Firebase:", e);
                    }
                    
                    // Add our own confirm button handler
                    const confirmBtn = document.getElementById('confirmAssignment');
                    if (confirmBtn) {
                        confirmBtn.onclick = safeAssignGuide;
                    }
                    
                    // Add our own cancel/close button handlers
                    const closeBtn = document.getElementById('closeAssignmentModal');
                    const cancelBtn = document.getElementById('cancelAssignment');
                    
                    if (closeBtn) {
                        closeBtn.onclick = safeCloseModal;
                    }
                    
                    if (cancelBtn) {
                        cancelBtn.onclick = safeCloseModal;
                    }
                };
                
                window.safeCloseModal = function() {
                    const modal = document.getElementById('guideAssignmentModal');
                    if (modal) {
                        modal.classList.remove('active');
                    }
                    window.safeBookingId = null;
                };
                
                window.safeAssignGuide = function() {
                    const bookingId = window.safeBookingId;
                    const guideSelect = document.getElementById('guideSelectDropdown');
                    const confirmBtn = document.getElementById('confirmAssignment');
                    
                    if (!bookingId) {
                        alert("No booking selected. Please try again.");
                        return;
                    }
                    
                    if (!guideSelect || !guideSelect.value) {
                        alert("Please select a guide");
                        return;
                    }
                    
                    const guideId = guideSelect.value;
                    
                    // Show loading state
                    if (confirmBtn) {
                        confirmBtn.disabled = true;
                        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Assigning...';
                    }
                    
                    try {
                        // Get Firebase references safely
                        const db = firebase.firestore();
                        const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;
                        
                        // Get booking and guide details
                        Promise.all([
                            db.collection("bookings").doc(bookingId).get(),
                            db.collection("guides").doc(guideId).get()
                        ]).then(([bookingDoc, guideDoc]) => {
                            if (!bookingDoc.exists) {
                                throw new Error("Booking not found");
                            }
                            
                            if (!guideDoc.exists) {
                                throw new Error("Guide not found");
                            }
                            
                            const booking = bookingDoc.data();
                            const guide = guideDoc.data();
                            
                            // Create tour with SAFE data (no undefined values)
                            const tourData = {
                                bookingId: bookingId,
                                packageType: booking.packageType || booking.packageName || "Standard Package",
                                clientId: booking.clientId ||  bookingId,
                                clientName: booking.clientName || "Client",
                                guideId: guideId,
                                guideName: guide.fullName || "Guide",
                                status: "Confirmed",
                                createdAt: serverTimestamp(),
                                updatedAt: serverTimestamp()
                            };
                            
                            // Log the data being saved for debugging
                            console.log("Creating tour with data:", tourData);
                            
                            // Create tour document
                            return db.collection("tours").add(tourData).then(tourRef => {
                                // Update booking with guide info
                                return db.collection("bookings").doc(bookingId).update({
                                    guideId: guideId,
                                    guideName: guide.fullName || "Guide",
                                    guideImageUrl: guide.profileImageUrl || null,
                                    guideExperience: `${guide.experienceYears || 0} years`,
                                    guideLanguages: guide.languages || ["English"],
                                    guideStatus: "Assigned",
                                    updatedAt: serverTimestamp()
                                }).then(() => {
                                    // Send welcome message if clientId exists
                                    if (booking.clientId) {
                                        return db.collection("messages").add({
                                            threadId: "welcome_tour_" + Date.now(),
                                            sender: guideId,
                                            senderName: guide.fullName || "Guide",
                                            recipient: booking.clientId,
                                            recipientName: booking.clientName || "Client",
                                            subject: "Welcome to Your KenyaOnABudget Safari!",
                                            content: `Hello ${booking.clientName || "Client"},\n\nMy name is ${guide.fullName || "Guide"} and I'll be your guide for your upcoming safari. I'm excited to show you the beauty of Kenya and make your trip unforgettable!\n\nFeel free to ask me any questions about your trip, and I'll be happy to assist you.\n\nBest regards,\n${guide.fullName || "Guide"}`,
                                            timestamp: serverTimestamp(),
                                            read: false,
                                            isLatest: true
                                        });
                                    }
                                    
                                    return Promise.resolve();
                                });
                            });
                        }).then(() => {
                            // Success!
                            alert("Guide assigned successfully!");
                            safeCloseModal();
                            
                            // Reload the page to reflect changes
                            setTimeout(() => window.location.reload(), 1000);
                        }).catch(error => {
                            console.error("Error in guide assignment:", error);
                            alert("Error assigning guide: " + error.message);
                        }).finally(() => {
                            // Reset button state
                            if (confirmBtn) {
                                confirmBtn.disabled = false;
                                confirmBtn.innerHTML = 'Assign Guide';
                            }
                        });
                    } catch (error) {
                        console.error("Guide assignment error:", error);
                        alert("Error: " + error.message);
                        
                        // Reset button state
                        if (confirmBtn) {
                            confirmBtn.disabled = false;
                            confirmBtn.innerHTML = 'Assign Guide';
                        }
                    }
                };
                
                console.log("Direct guide assignment fix installed!");
                
                // Check if Firebase is accessible globally
                if (typeof firebase === 'undefined') {
                    console.error("Firebase is not accessible globally. The fix may not work properly.");
                    
                    // Add Firebase script if needed
                    const script = document.createElement('script');
                    script.src = "https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js";
                    document.head.appendChild(script);
                    
                    const firestoreScript = document.createElement('script');
                    firestoreScript.src = "https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js";
                    document.head.appendChild(firestoreScript);
                    
                    // Wait and try to initialize Firebase
                    setTimeout(() => {
                        if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                            // Initialize Firebase
                            firebase.initializeApp({
                                apiKey: "AIzaSyAkT263nxI1qdMvgcZqS2M37-C4OwYL2I0",
  authDomain: "kenya-on-a-budget-safaris.firebaseapp.com",
  projectId: "kenya-on-a-budget-safaris",
  storageBucket: "kenya-on-a-budget-safaris.firebasestorage.app",
  messagingSenderId: "857055399633",
  appId: "1:857055399633:web:8531f564a3ffc3d0f1bff0"
                            });
                            console.log("Firebase initialized by fix script");
                        }
                    }, 2000);
                }
                
                // Add a direct fix button for testing
                const fixBtn = document.createElement('button');
                fixBtn.textContent = " Assign";
                fixBtn.style.position = "fixed";
                fixBtn.style.bottom = "20px";
                fixBtn.style.right = "200px";
                fixBtn.style.padding = "12px 20px";
                fixBtn.style.background = "#3498db";
                fixBtn.style.color = "white";
                fixBtn.style.border = "none";
                fixBtn.style.borderRadius = "5px";
                fixBtn.style.cursor = "pointer";
                fixBtn.style.zIndex = "9999";
                fixBtn.onclick = function() {
                    // Get first booking ID from a button on page
                    const assignBtns = Array.from(document.querySelectorAll('.action-btn')).filter(btn => 
                        btn.textContent.includes('Assign Guide'));
                        
                    if (assignBtns.length > 0) {
                        const firstBtn = assignBtns[0];
                        const bookingMatch = firstBtn.onclick.toString().match(/openAssignmentModal\(['"]([^'"]+)['"]\)/);
                        if (bookingMatch && bookingMatch[1]) {
                            safeOpenAssignmentModal(bookingMatch[1]);
                        } else {
                            alert("Could not find a booking ID. Please try clicking an Assign Guide button manually.");
                        }
                    } else {
                        alert("No 'Assign Guide' buttons found on the page. Navigate to Guide Assignment section first.");
                    }
                };
                document.body.appendChild(fixBtn);
            }, 2000);
        });
    </script>
    
    <!-- Emergency Dashboard Fix -->
<script type="module">
    // Import Firebase modules
   // Complete Admin Dashboard Solution
// This script provides full functionality for messages, guide allocation, and client management

// Import all required Firebase modules
import { 
    initializeApp 
} from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { 
    getAuth,
    onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
import { 
    getFirestore, 
    collection, 
    doc,
    getDoc,
    getDocs,
    addDoc,
    updateDoc,
    query,
    where,
    orderBy,
    limit,
    writeBatch,
    serverTimestamp,
    onSnapshot
} from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

console.log(" Admin Dashboard Full Solution Loading...");

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyAkT263nxI1qdMvgcZqS2M37-C4OwYL2I0",
  authDomain: "kenya-on-a-budget-safaris.firebaseapp.com",
  projectId: "kenya-on-a-budget-safaris",
  storageBucket: "kenya-on-a-budget-safaris.firebasestorage.app",
  messagingSenderId: "857055399633",
  appId: "1:857055399633:web:8531f564a3ffc3d0f1bff0"
};

// Initialize Firebase
let app, auth, db;
try {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
    console.log("Firebase initialized successfully");
} catch (e) {
    console.error("Firebase initialization error:", e);
    alert("Firebase initialization error. Check console for details.");
}

// Global state
let currentUser = null;
let currentMessageThreadId = null;
let currentMessageId = null;
let clientsCache = new Map(); // Cache for client information

// ===== MESSAGES FUNCTIONALITY =====

// Enhance the messages section with proper UI and functionality
function enhanceMessagesSection() {
    console.log("Enhancing messages section...");
    
    const messagesSection = document.getElementById('support-messages-section');
    if (!messagesSection) {
        console.error("Messages section not found!");
        return;
    }
    
    // Replace with proper UI
    messagesSection.innerHTML = `
        <div class="section-header">
            <h2>Support Messages</h2>
            <p class="section-description">Manage and respond to customer support messages</p>
        </div>
        
        <div class="messages-container">
            <!-- Messages List -->
            <div class="messages-list-container">
                <div class="messages-list-header">
                    <h3>Conversations</h3>
                    
                    <div class="message-filters">
                        <select id="messageStatusFilter">
                            <option value="all">All Messages</option>
                            <option value="unread">Unread</option>
                            <option value="read">Read</option>
                        </select>
                        <div class="search-box">
                            <input type="text" id="messageSearchInput" placeholder="Search messages...">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>
                </div>
                
                <div class="messages-list" id="supportMessagesList">
                    <div class="loading-container">
                        <div class="spinner"></div>
                        <p>Loading messages...</p>
                    </div>
                </div>
            </div>
            
            <!-- Message Detail -->
            <div class="message-detail-container">
                <div class="message-detail-placeholder" id="messageDetailPlaceholder">
                    <div class="placeholder-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h3>Select a conversation</h3>
                    <p>Choose a conversation from the list to view messages and respond</p>
                </div>
                
                <div class="message-detail" id="messageDetailContent" style="display: none;">
                    <div class="message-detail-header">
                        <div class="message-sender-info">
                            <div class="sender-avatar">
                                <span id="senderInitials">JD</span>
                            </div>
                            <div class="sender-details">
                                <h3 id="senderName">John Doe</h3>
                                <p id="messageSubject">Question about safari booking</p>
                            </div>
                        </div>
                        <div class="message-actions">
                            
                            <button class="action-btn" id="markAsReadBtn">
                                <i class="fas fa-envelope-open"></i>
                                <span>Mark as Read</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="message-thread" id="messageThread">
                        <!-- Message bubbles will be populated here -->
                    </div>
                    
                    <div class="message-reply-form">
                        <form id="supportReplyForm">
                            <div class="form-group">
                                <textarea id="replyContent" placeholder="Type your reply here..." required></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn-primary">
                                    <i class="fas fa-paper-plane"></i>
                                    Send Reply
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add styles if needed (if they're not already in your CSS)
    addStyles(`
        .messages-container {
            display: flex;
            height: calc(100vh - 180px);
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .messages-list-container {
            width: 350px;
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }
        
        .messages-list-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .messages-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .message-detail-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .message-item {
            display: flex;
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .message-item:hover {
            background-color: #f5f5f5;
        }
        
        .message-item.active {
            background-color: #fff5eb;
        }
        
        .message-item.unread {
            border-left: 3px solid #e67e22;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e67e22;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 15px;
        }
        
        .message-thread {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .message-bubble {
            display: flex;
            align-items: flex-start;
            max-width: 80%;
        }
        
        .message-bubble.client {
            align-self: flex-start;
        }
        
        .message-bubble.support {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        
        .message-bubble-content {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            position: relative;
        }
        
        .message-bubble.support .message-bubble-content {
            background-color: #e8f4fd;
        }
    `);
    
    // Set up event listeners
    const messageStatusFilter = document.getElementById('messageStatusFilter');
    if (messageStatusFilter) {
        messageStatusFilter.addEventListener('change', loadMessages);
    }
    
    const messageSearchInput = document.getElementById('messageSearchInput');
    if (messageSearchInput) {
        messageSearchInput.addEventListener('input', filterMessages);
    }
    
    const supportReplyForm = document.getElementById('supportReplyForm');
    if (supportReplyForm) {
        supportReplyForm.addEventListener('submit', handleReplySubmit);
    }
    
    const markAsReadBtn = document.getElementById('markAsReadBtn');
    if (markAsReadBtn) {
        markAsReadBtn.addEventListener('click', markThreadAsRead);
    }
    
    // Load messages
    loadMessages();
}

// Load messages
async function loadMessages() {
    console.log("Loading messages...");
    
    const messagesList = document.getElementById('supportMessagesList');
    if (!messagesList) return;
    
    // Show loading
    messagesList.innerHTML = `
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Loading messages...</p>
        </div>
    `;
    
    try {
        // Get status filter if available
        const statusFilter = document.getElementById('messageStatusFilter')?.value || 'all';
        
        // Fetch ALL messages to ensure we get data
        const messagesRef = collection(db, "messages");
        const allMessagesSnapshot = await getDocs(messagesRef);
        
        console.log(`Found ${allMessagesSnapshot.size} total messages`);
        
        if (allMessagesSnapshot.empty) {
            messagesList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-envelope-open"></i>
                    <p>No messages found</p>
                </div>
            `;
            return;
        }
        
        // Filter messages for support (where recipient is "support")
        let supportMessages = allMessagesSnapshot.docs.filter(doc => {
            const data = doc.data();
            return data.recipient === "support";
        });
        
        console.log(`Found ${supportMessages.length} support messages`);
        
        // Group messages by thread and get latest message in each thread
        const threadMap = new Map();
        
        supportMessages.forEach(doc => {
            const message = doc.data();
            message.id = doc.id;
            
            // Get thread ID (or use message ID if no thread ID)
            const threadId = message.threadId || doc.id;
            
            if (!threadMap.has(threadId) || 
                (message.timestamp && threadMap.get(threadId).timestamp && 
                 message.timestamp.seconds > threadMap.get(threadId).timestamp.seconds)) {
                threadMap.set(threadId, message);
            }
        });
        
        // Convert to array and sort by timestamp (newest first)
        let latestMessages = Array.from(threadMap.values()).sort((a, b) => {
            if (!a.timestamp) return 1;
            if (!b.timestamp) return -1;
            return b.timestamp.seconds - a.timestamp.seconds;
        });
        
        // Apply read/unread filter
        if (statusFilter === 'unread') {
            latestMessages = latestMessages.filter(message => !message.read);
        } else if (statusFilter === 'read') {
            latestMessages = latestMessages.filter(message => message.read);
        }
        
        console.log(`Displaying ${latestMessages.length} message threads`);
        
        // Display messages
        if (latestMessages.length === 0) {
            messagesList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-envelope-open"></i>
                    <p>No ${statusFilter === 'all' ? '' : statusFilter + ' '}messages found</p>
                </div>
            `;
            return;
        }
        
        // Build HTML
        let html = '';
        
        for (const message of latestMessages) {
            // Try to get client name if it's cached or from sender info
            let senderName = message.senderName || 'Unknown Sender';
            if (message.sender && message.sender !== 'support') {
                // Try to get client name from cache or database
                const clientName = await getClientName(message.sender);
                if (clientName && clientName !== message.sender) {
                    senderName = clientName;
                }
            }
            
            // Create initials
            const initials = senderName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            
            // Format time
            const timestamp = message.timestamp ? 
                formatTimeAgo(new Date(message.timestamp.seconds * 1000)) : 
                'Recently';
            
            // Set message preview (truncate if too long)
            const previewText = message.content ? 
                (message.content.length > 60 ? message.content.substring(0, 60) + '...' : message.content) : 
                'No content';
            
            html += `
                <div class="message-item ${message.read ? '' : 'unread'}" 
                    data-thread-id="${message.threadId || message.id}" 
                    data-id="${message.id}" 
                    data-sender="${message.sender}"
                    data-sender-name="${senderName}"
                    onclick="window.viewThread('${message.threadId || message.id}', '${message.id}')">
                    <div class="message-avatar">${initials}</div>
                    <div class="message-preview">
                        <div class="message-name">${senderName}</div>
                        <div class="message-subject">${message.subject || 'No subject'}</div>
                        <div class="message-preview-text">${previewText}</div>
                    </div>
                    <div class="message-meta">
                        <div class="message-time">${timestamp}</div>
                        ${message.read ? '' : '<div class="message-status-dot"></div>'}
                    </div>
                </div>
            `;
        }
        
        messagesList.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading messages:', error);
        messagesList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-circle"></i>
                <p>Error loading messages: ${error.message}</p>
            </div>
        `;
    }
}

// Filter messages based on search
function filterMessages() {
    const searchInput = document.getElementById('messageSearchInput');
    const messageItems = document.querySelectorAll('.message-item');
    
    if (!searchInput || !messageItems.length) return;
    
    const searchText = searchInput.value.toLowerCase().trim();
    
    messageItems.forEach(item => {
        const senderName = item.querySelector('.message-name').textContent.toLowerCase();
        const subject = item.querySelector('.message-subject').textContent.toLowerCase();
        const preview = item.querySelector('.message-preview-text').textContent.toLowerCase();
        
        if (senderName.includes(searchText) || 
            subject.includes(searchText) || 
            preview.includes(searchText)) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
}

// Get client name from ID
async function getClientName(clientId) {
    // Check cache first
    if (clientsCache.has(clientId)) {
        return clientsCache.get(clientId);
    }
    
    try {
        // Try clients collection first
        const clientDoc = await getDoc(doc(db, "clients", clientId));
        
        if (clientDoc.exists()) {
            const clientData = clientDoc.data();
            const clientName = clientData.fullName || clientData.name || clientData.displayName || clientId;
            clientsCache.set(clientId, clientName);
            return clientName;
        }
        
        // If not found, try users collection
        const userDoc = await getDoc(doc(db, "users", clientId));
        
        if (userDoc.exists()) {
            const userData = userDoc.data();
            const userName = userData.fullName || userData.name || userData.displayName || clientId;
            clientsCache.set(clientId, userName);
            return userName;
        }
        
        // If not found in either collection, return the ID
        return clientId;
    } catch (error) {
        console.error(`Error getting client name for ${clientId}:`, error);
        return clientId;
    }
}

// View message thread
async function viewThread(threadId, messageId) {
    console.log(`Viewing thread: ${threadId}, message: ${messageId}`);
    
    // Update global state
    currentMessageThreadId = threadId;
    currentMessageId = messageId;
    
    // Get DOM elements
    const placeholder = document.getElementById('messageDetailPlaceholder');
    const detail = document.getElementById('messageDetailContent');
    const thread = document.getElementById('messageThread');
    const senderInitials = document.getElementById('senderInitials');
    const senderName = document.getElementById('senderName');
    const messageSubject = document.getElementById('messageSubject');
    const markAsReadBtn = document.getElementById('markAsReadBtn');
    
    if (!placeholder || !detail || !thread) {
        console.error("Message detail elements not found!");
        return;
    }
    
    // Hide placeholder, show detail with loading
    placeholder.style.display = 'none';
    detail.style.display = 'block';
    thread.innerHTML = `
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Loading conversation...</p>
        </div>
    `;
    
    // Highlight active message
    document.querySelectorAll('.message-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-thread-id') === threadId) {
            item.classList.add('active');
        }
    });
    
    try {
        // Get all messages in the thread
        const messagesRef = collection(db, "messages");
        const threadQuery = query(
            messagesRef,
            where("threadId", "==", threadId)
        );
        
        const threadSnapshot = await getDocs(threadQuery);
        console.log(`Found ${threadSnapshot.size} messages in thread ${threadId}`);
        
        if (threadSnapshot.empty) {
            thread.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>No messages found in this thread</p>
                </div>
            `;
            return;
        }
        
        // Sort messages by timestamp
        const messages = threadSnapshot.docs.map(doc => {
            return { id: doc.id, ...doc.data() };
        }).sort((a, b) => {
            const timeA = a.timestamp ? a.timestamp.seconds : 0;
            const timeB = b.timestamp ? b.timestamp.seconds : 0;
            return timeA - timeB;
        });
        
        // Get the first message for header info
        const firstMessage = messages[0];
        
        // Update header info
        let displayName = firstMessage.senderName || 'Unknown';
        if (firstMessage.sender && firstMessage.sender !== 'support') {
            const clientName = await getClientName(firstMessage.sender);
            if (clientName && clientName !== firstMessage.sender) {
                displayName = clientName;
            }
        }
        
        if (senderInitials) {
            const initials = displayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            senderInitials.textContent = initials;
        }
        
        if (senderName) senderName.textContent = displayName;
        if (messageSubject) messageSubject.textContent = firstMessage.subject || 'No subject';
        
        // Show/hide mark as read button
        if (markAsReadBtn) {
            const activeItem = document.querySelector('.message-item.active');
            if (activeItem && !activeItem.classList.contains('unread')) {
                markAsReadBtn.style.display = 'none';
            } else {
                markAsReadBtn.style.display = 'inline-flex';
            }
        }
        
        // Build thread HTML
        let threadHTML = '';
        
        for (const message of messages) {
            const isSupport = message.sender === 'support';
            
            // Format timestamp
            const timestamp = message.timestamp ? 
                new Date(message.timestamp.seconds * 1000).toLocaleString() : 
                'Recently';
            
            // Get sender name
            let senderDisplayName = isSupport ? 'Support Team' : (message.senderName || 'Unknown');
            if (!isSupport && message.sender) {
                const clientName = await getClientName(message.sender);
                if (clientName && clientName !== message.sender) {
                    senderDisplayName = clientName;
                }
            }
            
            // Get sender initials
            const bubbleInitials = isSupport ? 'S' : 
                senderDisplayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            
            threadHTML += `
                <div class="message-bubble ${isSupport ? 'support' : 'client'}">
                    <div class="message-bubble-avatar">${bubbleInitials}</div>
                    <div class="message-bubble-content">
                        <div class="message-bubble-header">
                            <div class="message-bubble-name">${senderDisplayName}</div>
                            <div class="message-bubble-time">${timestamp}</div>
                        </div>
                        <div class="message-bubble-text">${message.content || 'No content'}</div>
                    </div>
                </div>
            `;
        }
        
        thread.innerHTML = threadHTML;
        
        // Scroll to bottom of thread
        thread.scrollTop = thread.scrollHeight;
        
        // Mark message as read if unread
        const activeItem = document.querySelector('.message-item.active');
        if (activeItem && activeItem.classList.contains('unread')) {
            markMessageAsRead(messageId);
        }
        
    } catch (error) {
        console.error('Error viewing thread:', error);
        thread.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-circle"></i>
                <p>Error loading thread: ${error.message}</p>
            </div>
        `;
    }
}

// Mark message as read
async function markMessageAsRead(messageId) {
    try {
        await updateDoc(doc(db, "messages", messageId), {
            read: true
        });
        
        // Update UI
        const messageItem = document.querySelector(`.message-item[data-id="${messageId}"]`);
        if (messageItem) {
            messageItem.classList.remove('unread');
            const statusDot = messageItem.querySelector('.message-status-dot');
            if (statusDot) statusDot.remove();
        }
        
        // Hide mark as read button
        const markAsReadBtn = document.getElementById('markAsReadBtn');
        if (markAsReadBtn) {
            markAsReadBtn.style.display = 'none';
        }
        
    } catch (error) {
        console.error('Error marking message as read:', error);
        alert('Failed to mark message as read: ' + error.message);
    }
}

// Mark thread as read
async function markThreadAsRead() {
    if (!currentMessageThreadId) return;
    
    try {
        // Get all messages in thread
        const messagesRef = collection(db, "messages");
        const threadQuery = query(
            messagesRef,
            where("threadId", "==", currentMessageThreadId),
            where("read", "==", false)
        );
        
        const unreadSnapshot = await getDocs(threadQuery);
        
        if (!unreadSnapshot.empty) {
            // Batch update all messages
            const batch = writeBatch(db);
            
            unreadSnapshot.forEach(doc => {
                batch.update(doc.ref, { read: true });
            });
            
            await batch.commit();
            
            // Update UI
            const item = document.querySelector(`.message-item[data-thread-id="${currentMessageThreadId}"]`);
            if (item) {
                item.classList.remove('unread');
                const statusDot = item.querySelector('.message-status-dot');
                if (statusDot) statusDot.remove();
            }
            
            // Hide mark as read button
            const markAsReadBtn = document.getElementById('markAsReadBtn');
            if (markAsReadBtn) {
                markAsReadBtn.style.display = 'none';
            }
        }
    } catch (error) {
        console.error('Error marking thread as read:', error);
        alert('Failed to mark thread as read: ' + error.message);
    }
}

// Handle reply submission
async function handleReplySubmit(event) {
    event.preventDefault();
    
    if (!currentMessageThreadId) {
        alert('No message thread selected!');
        return;
    }
    
    const replyContent = document.getElementById('replyContent')?.value.trim();
    
    if (!replyContent) {
        alert('Please enter a reply message!');
        return;
    }
    
    try {
        // Get original message for recipient info
        const messagesRef = collection(db, "messages");
        const originalQuery = query(
            messagesRef,
            where("threadId", "==", currentMessageThreadId),
            limit(1)
        );
        
        const originalSnapshot = await getDocs(originalQuery);
        
        if (originalSnapshot.empty) {
            alert('Thread information not found!');
            return;
        }
        
        const originalMessage = originalSnapshot.docs[0].data();
        
        // Mark all messages in thread as not the latest
        const threadQuery = query(
            messagesRef,
            where("threadId", "==", currentMessageThreadId)
        );
        
        const threadSnapshot = await getDocs(threadQuery);
        
        const batch = writeBatch(db);
        threadSnapshot.forEach(doc => {
            batch.update(doc.ref, { isLatest: false });
        });
        await batch.commit();
        
        // Add reply
        await addDoc(messagesRef, {
            threadId: currentMessageThreadId,
            sender: 'support',
            senderName: 'Support Team',
            recipient: originalMessage.sender,
            recipientName: originalMessage.senderName,
            subject: originalMessage.subject || 'Re: Support Request',
            content: replyContent,
            timestamp: serverTimestamp(),
            read: false,
            isLatest: true
        });
        
        // Clear form
        document.getElementById('replyContent').value = '';
        
        // Refresh thread view
        viewThread(currentMessageThreadId, currentMessageId);
        
        // Show success message
        alert('Reply sent successfully!');
        
    } catch (error) {
        console.error('Error sending reply:', error);
        alert('Failed to send reply: ' + error.message);
    }
}

// ===== GUIDE ASSIGNMENT FUNCTIONALITY =====

// Enhance guide assignment section
function enhanceGuideAssignment() {
    console.log("Enhancing guide assignment section...");
    
    const assignmentSection = document.getElementById('guide-assignment-section');
    if (!assignmentSection) {
        console.error("Guide assignment section not found!");
        return;
    }
    
    // Replace with proper UI
    assignmentSection.innerHTML = `
        <div class="section-header">
            <h2>Guide Assignment</h2>
            <p class="section-description">Assign guides to pending bookings</p>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3>Pending Bookings</h3>
                <div class="header-actions">
                    <div class="search-box">
                        <input type="text" id="bookingSearchInput" placeholder="Search bookings...">
                        <i class="fas fa-search"></i>
                    </div>
                    <select id="bookingStatusFilter">
                        <option value="all">All Statuses</option>
                        <option value="Pending" selected>Guide Pending</option>
                        <option value="Assigned">Guide Assigned</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <table class="data-table" id="pendingBookingsTable">
                    <thead>
                        <tr>
                            <th>Booking ID</th>
                            <th>Client Name</th>
                            <th>Package</th>
                            <th>Booking Date</th>
                            <th>Guide Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pendingBookingsList">
                        <tr>
                            <td colspan="6" class="loading-row">
                                <div class="spinner"></div>
                                <span>Loading bookings...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Assignment Modal -->
        <div class="modal" id="guideAssignmentModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Assign Guide to Booking</h3>
                    <button class="modal-close" id="closeAssignmentModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="booking-details">
                        <h4>Booking Details</h4>
                        <p><strong>Booking ID:</strong> <span id="assignmentBookingId">-</span></p>
                        <p><strong>Client:</strong> <span id="assignmentClientName">-</span></p>
                        <p><strong>Client ID:</strong> <span id="assignmentClientId">-</span></p>
                        <p><strong>Package:</strong> <span id="assignmentPackage">-</span></p>
                        <p><strong>Booking Date:</strong> <span id="assignmentBookingDate">-</span></p>
                    </div>
                    
                    <div class="guide-selection-container">
                        <h4>Select Guide</h4>
                        <div class="form-group">
                            <select id="guideSelectDropdown" class="guide-select">
                                <option value="" selected disabled>Select a guide...</option>
                                <!-- Guides will be loaded dynamically -->
                            </select>
                        </div>
                        
                        <div id="selectedGuidePreview" class="selected-guide-preview" style="display: none;">
                            <div class="guide-preview-header">
                                <h4>Selected Guide</h4>
                                <button type="button" id="changeGuideButton" class="text-button">Change</button>
                            </div>
                            <div class="guide-preview-content">
                                <div class="guide-preview-avatar">
                                    <img id="previewGuideImage" src="profile.png" alt="Guide">
                                </div>
                                <div class="guide-preview-details">
                                    <h5 id="previewGuideName">Guide Name</h5>
                                    <p id="previewGuideExperience">Experience</p>
                                    <p id="previewGuideLanguages">Languages</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-cancel" id="cancelAssignment">Cancel</button>
                        <button type="button" class="btn-primary" id="confirmAssignment">Assign Guide</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Message Guide Modal -->
        <div class="modal" id="messageGuideModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Message Guide</h3>
                    <button class="modal-close" id="closeMessageGuideModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="guide-info">
                        <h4 id="messageGuideTitle">Message to Guide</h4>
                        <p id="messageGuideDescription">Send a message to the guide about this booking.</p>
                    </div>
                    
                    <form id="messageGuideForm">
                        <input type="hidden" id="messageGuideId">
                        <input type="hidden" id="messageClientId">
                        <div class="form-group">
                            <label for="messageGuideSubject">Subject:</label>
                            <input type="text" id="messageGuideSubject" placeholder="Message subject" required>
                        </div>
                        <div class="form-group">
                            <label for="messageGuideContent">Message:</label>
                            <textarea id="messageGuideContent" rows="6" placeholder="Type your message here" required></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn-cancel" id="cancelMessageGuide">Cancel</button>
                            <button type="submit" class="btn-primary">Send Message</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    // Add styles if needed
    addStyles(`
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .booking-details {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .selected-guide-preview {
            margin-top: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
        }
    `);
    
    // Set up event listeners
    const bookingSearchInput = document.getElementById('bookingSearchInput');
    if (bookingSearchInput) {
        bookingSearchInput.addEventListener('input', filterBookings);
    }
    
    const bookingStatusFilter = document.getElementById('bookingStatusFilter');
    if (bookingStatusFilter) {
        bookingStatusFilter.addEventListener('change', loadBookings);
    }
    
    // Modal event listeners
    const closeAssignmentModal = document.getElementById('closeAssignmentModal');
    const cancelAssignment = document.getElementById('cancelAssignment');
    const confirmAssignment = document.getElementById('confirmAssignment');
    const changeGuideButton = document.getElementById('changeGuideButton');
    const guideSelectDropdown = document.getElementById('guideSelectDropdown');
    
    if (closeAssignmentModal) {
        closeAssignmentModal.addEventListener('click', closeModals);
    }
    
    if (cancelAssignment) {
        cancelAssignment.addEventListener('click', closeModals);
    }
    
    if (confirmAssignment) {
        confirmAssignment.addEventListener('click', assignGuideToBooking);
    }
    
    if (changeGuideButton) {
        changeGuideButton.addEventListener('click', () => {
            const selectedGuidePreview = document.getElementById('selectedGuidePreview');
            if (selectedGuidePreview) {
                selectedGuidePreview.style.display = 'none';
            }
            if (guideSelectDropdown) {
                guideSelectDropdown.style.display = '';
            }
        });
    }
    
    if (guideSelectDropdown) {
        guideSelectDropdown.addEventListener('change', showSelectedGuidePreview);
    }
    
    // Message guide modal events
    const closeMessageGuideModal = document.getElementById('closeMessageGuideModal');
    const cancelMessageGuide = document.getElementById('cancelMessageGuide');
    const messageGuideForm = document.getElementById('messageGuideForm');
    
    if (closeMessageGuideModal) {
        closeMessageGuideModal.addEventListener('click', closeModals);
    }
    
    if (cancelMessageGuide) {
        cancelMessageGuide.addEventListener('click', closeModals);
    }
    
    if (messageGuideForm) {
        messageGuideForm.addEventListener('submit', sendMessageToGuide);
    }
    
    // Load bookings and guides
    loadBookings();
    loadGuides();
}

// Load bookings
async function loadBookings() {
    console.log("Loading bookings...");
    
    const bookingsList = document.getElementById('pendingBookingsList');
    if (!bookingsList) return;
    
    // Show loading
    bookingsList.innerHTML = `
        <tr>
            <td colspan="6" class="loading-row">
                <div class="spinner"></div>
                <span>Loading bookings...</span>
            </td>
        </tr>
    `;
    
    try {
        // Get status filter if available
        const statusFilter = document.getElementById('bookingStatusFilter')?.value || 'all';
        
        // Fetch all bookings
        const bookingsRef = collection(db, "bookings");
        const bookingsSnapshot = await getDocs(bookingsRef);
        
        console.log(`Found ${bookingsSnapshot.size} total bookings`);
        
        if (bookingsSnapshot.empty) {
            bookingsList.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">
                        <div class="empty-state">
                            <i class="fas fa-calendar-times"></i>
                            <p>No bookings found</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Filter by guide status if needed
        let filteredBookings = bookingsSnapshot.docs;
        
        if (statusFilter !== 'all') {
            filteredBookings = filteredBookings.filter(doc => {
                const data = doc.data();
                return statusFilter === 'Assigned' 
                    ? data.guideStatus === 'Assigned' 
                    : !data.guideStatus || data.guideStatus === 'Pending';
            });
        }
        
        console.log(`After filtering by '${statusFilter}': ${filteredBookings.length} bookings`);
        
        if (filteredBookings.length === 0) {
            bookingsList.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">
                        <div class="empty-state">
                            <i class="fas fa-filter"></i>
                            <p>No bookings match the selected filter</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Build HTML
        let html = '';
        
        for (const doc of filteredBookings) {
            const booking = doc.data();
            booking.id = doc.id;
            
            // Get client info
            let clientName = booking.clientName || 'Unknown Client';
            if (booking.clientId && booking.clientId !== clientName) {
                const fetchedName = await getClientName(booking.clientId);
                if (fetchedName !== booking.clientId) {
                    clientName = fetchedName;
                }
            }
            
            // Format booking date
            let bookingDate = 'Not available';
            
            if (booking.bookingDate && booking.bookingDate.seconds) {
                bookingDate = new Date(booking.bookingDate.seconds * 1000).toLocaleDateString();
            } else if (booking.createdAt && booking.createdAt.seconds) {
                bookingDate = new Date(booking.createdAt.seconds * 1000).toLocaleDateString();
            } else if (booking.bookingDate) {
                try {
                    bookingDate = new Date(booking.bookingDate).toLocaleDateString();
                } catch (e) {
                    // Keep default
                }
            }
            
            // Determine guide status
            const guideStatus = booking.guideStatus || 'Pending';
            const statusClass = guideStatus === 'Assigned' ? 'status-assigned' : 'status-pending';
            
            html += `
                <tr data-id="${booking.id}" data-client-id="${booking.clientId || ''}">
                    <td>${booking.id.substring(0, 8)}...</td>
                    <td>${clientName}</td>
                    <td>${booking.packageName || booking.packageType || 'Unknown Package'}</td>
                    <td>${bookingDate}</td>
                    <td><span class="status-badge ${statusClass}">${guideStatus}</span></td>
                    <td>
                        <button class="action-btn view" onclick="window.viewBookingDetails('${booking.id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                        ${guideStatus === 'Assigned' ? 
                            `<button class="action-btn message" onclick="window.messageGuide('${booking.id}', '${booking.guideId}', '${booking.clientId || ''}')">
                                <i class="fas fa-envelope"></i> Message Guide
                            </button>` :
                            `<button class="action-btn" onclick="window.openAssignmentModal('${booking.id}')">
                                <i class="fas fa-user-plus"></i> Assign Guide
                            </button>`
                        }
                    </td>
                </tr>
            `;
        }
        
        bookingsList.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading bookings:', error);
        bookingsList.innerHTML = `
            <tr>
                <td colspan="6" class="text-center">
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading bookings: ${error.message}</p>
                    </div>
                </td>
            </tr>
        `;
    }
}

// Load guides for dropdown
async function loadGuides() {
    console.log("Loading guides for dropdown...");
    
    const guideSelect = document.getElementById('guideSelectDropdown');
    if (!guideSelect) return;
    
    try {
        // Clear previous options except the first one
        while (guideSelect.options.length > 1) {
            guideSelect.remove(1);
        }
        
        // Fetch all guides
        const guidesRef = collection(db, "guides");
        const guidesSnapshot = await getDocs(guidesRef);
        
        console.log(`Found ${guidesSnapshot.size} guides`);
        
        if (guidesSnapshot.empty) {
            guideSelect.innerHTML += `
                <option value="" disabled>No guides available</option>
            `;
            return;
        }
        
        // Add guide options
        guidesSnapshot.forEach(doc => {
            const guide = doc.data();
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = guide.fullName || `Guide ${doc.id.substring(0, 5)}`;
            guideSelect.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading guides:', error);
        guideSelect.innerHTML += `
            <option value="" disabled>Error loading guides</option>
        `;
    }
}

// Filter bookings
function filterBookings() {
    const searchInput = document.getElementById('bookingSearchInput');
    const rows = document.querySelectorAll('#pendingBookingsList tr');
    
    if (!searchInput || !rows.length) return;
    
    const searchText = searchInput.value.toLowerCase().trim();
    
    rows.forEach(row => {
        // Skip placeholder or loading rows
        if (!row.cells || row.cells.length < 4) return;
        
        const bookingId = row.cells[0].textContent.toLowerCase();
        const clientName = row.cells[1].textContent.toLowerCase();
        const packageName = row.cells[2].textContent.toLowerCase();
        
        if (bookingId.includes(searchText) || 
            clientName.includes(searchText) || 
            packageName.includes(searchText)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Open guide assignment modal
async function openAssignmentModal(bookingId) {
    console.log(`Opening assignment modal for booking ${bookingId}`);
    
    const modal = document.getElementById('guideAssignmentModal');
    if (!modal) return;
    
    try {
        // Get booking details
        const bookingRef = doc(db, "bookings", bookingId);
        const bookingDoc = await getDoc(bookingRef);
        
        if (!bookingDoc.exists()) {
            alert('Booking not found!');
            return;
        }
        
        const booking = bookingDoc.data();
        
        // Update modal content
        document.getElementById('assignmentBookingId').textContent = bookingId;
        
        // Get client name
        let clientName = booking.clientName || 'Unknown Client';
        if (booking.clientId && booking.clientId !== clientName) {
            const fetchedName = await getClientName(booking.clientId);
            if (fetchedName !== booking.clientId) {
                clientName = fetchedName;
            }
        }
        
        document.getElementById('assignmentClientName').textContent = clientName;
        document.getElementById('assignmentClientId').textContent = booking.clientId || 'Not specified';
        document.getElementById('assignmentPackage').textContent = booking.packageName || booking.packageType || 'Unknown Package';
        
        // Format booking date
        let bookingDate = 'Not available';
        
        if (booking.bookingDate && booking.bookingDate.seconds) {
            bookingDate = new Date(booking.bookingDate.seconds * 1000).toLocaleDateString();
        } else if (booking.createdAt && booking.createdAt.seconds) {
            bookingDate = new Date(booking.createdAt.seconds * 1000).toLocaleDateString();
        } else if (booking.bookingDate) {
            try {
                bookingDate = new Date(booking.bookingDate).toLocaleDateString();
            } catch (e) {
                // Keep default
            }
        }
        
        document.getElementById('assignmentBookingDate').textContent = bookingDate;
        
        // Reset guide selection
        const guideSelect = document.getElementById('guideSelectDropdown');
        if (guideSelect) {
            guideSelect.value = '';
            guideSelect.style.display = '';
        }
        
        const guidePreview = document.getElementById('selectedGuidePreview');
        if (guidePreview) {
            guidePreview.style.display = 'none';
        }
        
        // Store booking ID for use in assignment
        document.getElementById('guideAssignmentModal').dataset.bookingId = bookingId;
        document.getElementById('guideAssignmentModal').dataset.clientId = booking.clientId || '';
        
        // Show modal
        modal.classList.add('active');
        
    } catch (error) {
        console.error('Error opening assignment modal:', error);
        alert('Error loading booking details: ' + error.message);
    }
}

// Show selected guide preview
async function showSelectedGuidePreview() {
    const guideSelect = document.getElementById('guideSelectDropdown');
    const guidePreview = document.getElementById('selectedGuidePreview');
    
    if (!guideSelect || !guidePreview) return;
    
    const guideId = guideSelect.value;
    
    if (!guideId) {
        guidePreview.style.display = 'none';
        return;
    }
    
    try {
        // Get guide details
        const guideRef = doc(db, "guides", guideId);
        const guideDoc = await getDoc(guideRef);
        
        if (!guideDoc.exists()) {
            alert('Guide not found!');
            return;
        }
        
        const guide = guideDoc.data();
        
        // Update preview
        document.getElementById('previewGuideName').textContent = guide.fullName || `Guide ${guideId.substring(0, 5)}`;
        document.getElementById('previewGuideExperience').textContent = `Experience: ${guide.experienceYears || 0} years`;
        document.getElementById('previewGuideLanguages').textContent = guide.languages && Array.isArray(guide.languages) 
            ? `Languages: ${guide.languages.join(', ')}` 
            : 'Languages: English';
        
        // Set guide image if available
        const imageElement = document.getElementById('previewGuideImage');
        if (imageElement) {
            imageElement.src = guide.profileImageUrl || 'profile.png';
        }
        
        // Hide select, show preview
        guideSelect.style.display = 'none';
        guidePreview.style.display = 'block';
        
    } catch (error) {
        console.error('Error showing guide preview:', error);
        alert('Error loading guide details: ' + error.message);
    }
}

// Assign guide to booking
async function assignGuideToBooking() {
    const modal = document.getElementById('guideAssignmentModal');
    const guideSelect = document.getElementById('guideSelectDropdown');
    const confirmBtn = document.getElementById('confirmAssignment');
    
    if (!modal || !guideSelect || !confirmBtn) return;
    
    const bookingId = modal.dataset.bookingId;
    const clientId = modal.dataset.clientId;
    const guideId = guideSelect.value;
    
    if (!bookingId) {
        alert('Booking ID not found!');
        return;
    }
    
    if (!guideId) {
        alert('Please select a guide to assign!');
        return;
    }
    
    // Disable button and show loading
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Assigning...';
    
    try {
        // Get booking and guide details
        const bookingRef = doc(db, "bookings", bookingId);
        const bookingDoc = await getDoc(bookingRef);
        
        if (!bookingDoc.exists()) {
            throw new Error('Booking not found!');
        }
        
        const booking = bookingDoc.data();
        
        const guideRef = doc(db, "guides", guideId);
        const guideDoc = await getDoc(guideRef);
        
        if (!guideDoc.exists()) {
            throw new Error('Guide not found!');
        }
        
        const guide = guideDoc.data();
        
        // Create a tour record linking the guide to the client
        const tourData = {
            bookingId: bookingId,
            packageType: booking.packageType,
            clientId: clientId,
            clientName: booking.clientName,
            guideId: guideId,
            guideName: guide.fullName,
            status: "Confirmed",
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
        };
        
        const tourRef = await addDoc(collection(db, "tours"), tourData);
        console.log(`Created tour with ID: ${tourRef.id}`);
        
        // Update the booking with the guide information
        await updateDoc(bookingRef, {
            guideId: guideId,
            guideName: guide.fullName,
            guideImageUrl: guide.profileImageUrl || null,
            guideExperience: `${guide.experienceYears || 0} years`,
            guideLanguages: guide.languages || ["English"],
            guideStatus: "Assigned",
            updatedAt: serverTimestamp()
        });
        
        // Send welcome message from guide to client
        if (clientId) {
            await addDoc(collection(db, "messages"), {
                threadId: "welcome_tour_" + Date.now(),
                sender: guideId,
                senderName: guide.fullName,
                recipient: clientId,
                recipientName: booking.clientName,
                subject: "Welcome to Your KenyaOnABudget Safari!",
                content: `Hello ${booking.clientName},\n\nMy name is ${guide.fullName} and I'll be your guide for your upcoming safari. I'm excited to show you the beauty of Kenya and make your trip unforgettable!\n\nFeel free to ask me any questions about your trip, and I'll be happy to assist you.\n\nBest regards,\n${guide.fullName}`,
                timestamp: serverTimestamp(),
                read: false,
                isLatest: true
            });
            
            console.log(`Sent welcome message to client ${clientId}`);
        }
        
        // Close modal
        closeModals();
        
        // Reload bookings
        loadBookings();
        
        // Show success message
        alert('Guide assigned successfully!');
        
    } catch (error) {
        console.error('Error assigning guide:', error);
        alert('Error assigning guide: ' + error.message);
    } finally {
        // Re-enable button
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = 'Assign Guide';
    }
}

// Open message guide modal
async function messageGuide(bookingId, guideId, clientId) {
    console.log(`Opening message guide modal for guide ${guideId}, booking ${bookingId}`);
    
    const modal = document.getElementById('messageGuideModal');
    if (!modal) return;
    
    try {
        // Get guide details
        const guideRef = doc(db, "guides", guideId);
        const guideDoc = await getDoc(guideRef);
        
        if (!guideDoc.exists()) {
            alert('Guide not found!');
            return;
        }
        
        const guide = guideDoc.data();
        
        // Update modal content
        document.getElementById('messageGuideTitle').textContent = `Message to ${guide.fullName}`;
        document.getElementById('messageGuideDescription').textContent = `Send a message to ${guide.fullName} about booking #${bookingId.substring(0, 8)}...`;
        
        // Store IDs for use in message sending
        document.getElementById('messageGuideId').value = guideId;
        document.getElementById('messageClientId').value = clientId;
        
        // Set default subject
        document.getElementById('messageGuideSubject').value = `Regarding Booking #${bookingId.substring(0, 8)}...`;
        
        // Clear previous message
        document.getElementById('messageGuideContent').value = '';
        
        // Show modal
        modal.classList.add('active');
        
    } catch (error) {
        console.error('Error opening message guide modal:', error);
        alert('Error loading guide details: ' + error.message);
    }
}

// Send message to guide
async function sendMessageToGuide(event) {
    event.preventDefault();
    
    const form = document.getElementById('messageGuideForm');
    if (!form) return;
    
    const guideId = document.getElementById('messageGuideId').value;
    const clientId = document.getElementById('messageClientId').value;
    const subject = document.getElementById('messageGuideSubject').value.trim();
    const content = document.getElementById('messageGuideContent').value.trim();
    
    if (!guideId) {
        alert('Guide ID not found!');
        return;
    }
    
    if (!subject || !content) {
        alert('Please enter a subject and message!');
        return;
    }
    
    try {
        // Get guide details
        const guideRef = doc(db, "guides", guideId);
        const guideDoc = await getDoc(guideRef);
        
        if (!guideDoc.exists()) {
            throw new Error('Guide not found!');
        }
        
        const guide = guideDoc.data();
        
        // Create a new message thread
        const threadId = `admin_to_guide_${Date.now()}`;
        
        await addDoc(collection(db, "messages"), {
            threadId: threadId,
            sender: 'support',
            senderName: 'Support Team',
            recipient: guideId,
            recipientName: guide.fullName,
            subject: subject,
            content: content,
            clientId: clientId, // Include client ID for reference
            timestamp: serverTimestamp(),
            read: false,
            isLatest: true
        });
        
        // Close modal
        closeModals();
        
        // Show success message
        alert('Message sent to guide successfully!');
        
    } catch (error) {
        console.error('Error sending message to guide:', error);
        alert('Error sending message: ' + error.message);
    }
}

// ===== GUIDES SECTION FUNCTIONALITY =====

// Enhance guides section
function enhanceGuidesSection() {
    console.log("Enhancing guides section...");
    
    const guidesSection = document.getElementById('guides-section');
    if (!guidesSection) {
        console.error("Guides section not found!");
        return;
    }
    
    // Replace with proper UI
    guidesSection.innerHTML = `
        <div class="section-header">
            <h2>All Guides</h2>
            <p class="section-description">Manage safari guides</p>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3>Safari Guides</h3>
                <div class="header-actions">
                    <div class="search-box">
                        <input type="text" id="guideSearchInput" placeholder="Search guides...">
                        <i class="fas fa-search"></i>
                    </div>
                    <select id="guideStatusFilter">
                        <option value="all">All Statuses</option>
                        <option value="active" selected>Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                    <button class="action-btn" id="addGuideBtn">
                        <i class="fas fa-plus"></i> Add Guide
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="guides-grid" id="guidesList">
                    <div class="loading-container">
                        <div class="spinner"></div>
                        <p>Loading guides...</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add styles
    addStyles(`
        .guides-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .guide-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .guide-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        
        .guide-header {
            position: relative;
            padding-top: 20px;
            text-align: center;
        }
        
        .guide-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            margin: 0 auto 10px;
            border: 4px solid white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .guide-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .guide-status {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-active {
            background-color: #e6f7ef;
            color: #2ecc71;
        }
        
        .status-inactive {
            background-color: #fde7e6;
            color: #e74c3c;
        }
        
        .guide-body {
            padding: 20px;
            text-align: center;
        }
        
        .guide-name {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
        }
        
        .guide-experience {
            color: #777;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .guide-languages {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .language-tag {
            background-color: #f5f5f5;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #555;
        }
        
        .guide-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .guide-btn {
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            background-color: #f5f5f5;
            color: #555;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s;
        }
        
        .guide-btn:hover {
            background-color: #e5e5e5;
        }
        
        .guide-btn.view {
            background-color: #e8f4fd;
            color: #3498db;
        }
        
        .guide-btn.view:hover {
            background-color: #d6eafb;
        }
        
        .guide-btn.edit {
            background-color: #fff5eb;
            color: #e67e22;
        }
        
        .guide-btn.edit:hover {
            background-color: #fdebd0;
        }
        
        .guide-btn.message {
            background-color: #e6f7ef;
            color: #2ecc71;
        }
        
        .guide-btn.message:hover {
            background-color: #d1f2e4;
        }
    `);
    
    // Set up event listeners
    const guideSearchInput = document.getElementById('guideSearchInput');
    if (guideSearchInput) {
        guideSearchInput.addEventListener('input', filterGuides);
    }
    
    const guideStatusFilter = document.getElementById('guideStatusFilter');
    if (guideStatusFilter) {
        guideStatusFilter.addEventListener('change', loadAllGuides);
    }
    
    const addGuideBtn = document.getElementById('addGuideBtn');
    if (addGuideBtn) {
        addGuideBtn.addEventListener('click', () => {
            alert('Add guide functionality will be implemented soon.');
        });
    }
    
    // Load guides
    loadAllGuides();
}

// Load all guides
async function loadAllGuides() {
    console.log("Loading all guides...");
    
    const guidesList = document.getElementById('guidesList');
    if (!guidesList) return;
    
    // Show loading
    guidesList.innerHTML = `
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Loading guides...</p>
        </div>
    `;
    
    try {
        // Get status filter if available
        const statusFilter = document.getElementById('guideStatusFilter')?.value || 'all';
        
        // Fetch all guides
        const guidesRef = collection(db, "guides");
        const guidesSnapshot = await getDocs(guidesRef);
        
        console.log(`Found ${guidesSnapshot.size} guides`);
        
        if (guidesSnapshot.empty) {
            guidesList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-users"></i>
                    <p>No guides found</p>
                </div>
            `;
            return;
        }
        
        // Filter by status if needed
        let filteredGuides = guidesSnapshot.docs;
        
        if (statusFilter !== 'all') {
            filteredGuides = filteredGuides.filter(doc => {
                const data = doc.data();
                return data.status === statusFilter;
            });
        }
        
        console.log(`After filtering by '${statusFilter}': ${filteredGuides.length} guides`);
        
        if (filteredGuides.length === 0) {
            guidesList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-filter"></i>
                    <p>No guides match the selected filter</p>
                </div>
            `;
            return;
        }
        
        // Build HTML
        let html = '';
        
        filteredGuides.forEach(doc => {
            const guide = doc.data();
            guide.id = doc.id;
            
            // Handle guide languages
            const languages = guide.languages && Array.isArray(guide.languages) 
                ? guide.languages.map(lang => `<span class="language-tag">${lang}</span>`).join('')
                : '<span class="language-tag">English</span>';
            
            html += `
                <div class="guide-card">
                    <div class="guide-header">
                        <div class="guide-avatar">
                            <img src="${guide.profileImageUrl || 'profile.png'}" alt="Guide">
                        </div>
                        <div class="guide-status ${guide.status === 'Active' ? 'status-active' : 'status-inactive'}">
                            ${guide.status || 'Active'}
                        </div>
                    </div>
                    <div class="guide-body">
                        <h3 class="guide-name">${guide.fullName || `Guide ${guide.id.substring(0, 5)}`}</h3>
                        <p class="guide-experience">${guide.experienceYears || 0} years experience</p>
                        <div class="guide-languages">
                            ${languages}
                        </div>
                        <div class="guide-actions">
                            <button class="guide-btn view" onclick="window.viewGuideDetails('${guide.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="guide-btn edit" onclick="window.editGuideDetails('${guide.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="guide-btn message" onclick="window.messageGuideDirectly('${guide.id}')">
                                <i class="fas fa-envelope"></i> Message
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        guidesList.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading guides:', error);
        guidesList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Error loading guides: ${error.message}</p>
            </div>
        `;
    }
}

// Filter guides
function filterGuides() {
    const searchInput = document.getElementById('guideSearchInput');
    const guideCards = document.querySelectorAll('.guide-card');
    
    if (!searchInput || !guideCards.length) return;
    
    const searchText = searchInput.value.toLowerCase().trim();
    
    guideCards.forEach(card => {
        const name = card.querySelector('.guide-name').textContent.toLowerCase();
        const experience = card.querySelector('.guide-experience').textContent.toLowerCase();
        const languages = card.querySelector('.guide-languages').textContent.toLowerCase();
        
        if (name.includes(searchText) || 
            experience.includes(searchText) || 
            languages.includes(searchText)) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}

// View guide details
// View guide details functionality
async function viewGuideDetails(guideId) {
    console.log(`Opening guide details modal for guide ${guideId}`);
    
    // Check if modal exists, create it if it doesn't
    let modal = document.getElementById('guideDetailsModal');
    if (!modal) {
        createGuideDetailsModal();
        modal = document.getElementById('guideDetailsModal');
    }
    
    if (!modal) {
        alert("Could not create guide details modal. Please refresh the page and try again.");
        return;
    }
    
    try {
        // Show loading state
        const modalBody = modal.querySelector('.modal-body');
        if (modalBody) {
            modalBody.innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Loading guide details...</p>
                </div>
            `;
        }
        
        // Show the modal
        modal.classList.add('active');
        modal.style.display = 'flex';
        
        // Get guide details from Firestore
        const guideRef = doc(db, "guides", guideId);
        const guideDoc = await getDoc(guideRef);
        
        if (!guideDoc.exists()) {
            throw new Error('Guide not found in database');
        }
        
        const guide = guideDoc.data();
        console.log("Guide data retrieved:", guide);
        
        // Format guide details for display
        let detailsHTML = `
            <div class="guide-details-container">
                <div class="guide-details-header">
                    <div class="guide-details-avatar">
                        <img src="${guide.profileImageUrl || 'profile.png'}" alt="${guide.fullName || 'Guide'}">
                    </div>
                    <div class="guide-details-info">
                        <h2>${guide.fullName || 'Guide'}</h2>
                        <p class="guide-status ${guide.status === 'Active' ? 'status-active' : 'status-inactive'}">
                            ${guide.status || 'Status not set'}
                        </p>
                    </div>
                </div>
                
                <div class="guide-details-content">
                    <div class="details-section">
                        <h3>Basic Information</h3>
                        <div class="details-grid">
                            <div class="detail-item">
                                <span class="detail-label">Full Name</span>
                                <span class="detail-value">${guide.fullName || 'Not provided'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Experience</span>
                                <span class="detail-value">${guide.experienceYears || 0} years</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Languages</span>
                                <span class="detail-value">${formatLanguages(guide.languages)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Email</span>
                                <span class="detail-value">${guide.email || 'Not provided'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Phone</span>
                                <span class="detail-value">${guide.phone || 'Not provided'}</span>
                            </div>
                        </div>
                    </div>`;
        
        // Add certifications section if available
        if (guide.certifications && Array.isArray(guide.certifications) && guide.certifications.length > 0) {
            detailsHTML += `
                <div class="details-section">
                    <h3>Certifications</h3>
                    <ul class="certifications-list">
                        ${guide.certifications.map(cert => `<li>${cert}</li>`).join('')}
                    </ul>
                </div>`;
        }
        
        // Add specialties section if available
        if (guide.specialties && Array.isArray(guide.specialties) && guide.specialties.length > 0) {
            detailsHTML += `
                <div class="details-section">
                    <h3>Specialties</h3>
                    <div class="specialties-list">
                        ${guide.specialties.map(specialty => 
                            `<span class="specialty-tag">${specialty}</span>`).join('')}
                    </div>
                </div>`;
        }
        
        // Add biography if available
        if (guide.biography) {
            detailsHTML += `
                <div class="details-section">
                    <h3>Biography</h3>
                    <p class="guide-biography">${guide.biography}</p>
                </div>`;
        }
        
        // Add additional fields dynamically
        const commonFields = ['fullName', 'experienceYears', 'languages', 'email', 'phone', 'status', 
                             'profileImageUrl', 'certifications', 'specialties', 'biography'];
        
        const additionalFields = Object.keys(guide).filter(key => !commonFields.includes(key));
        
        if (additionalFields.length > 0) {
            detailsHTML += `
                <div class="details-section">
                    <h3>Additional Information</h3>
                    <div class="details-grid">`;
                    
            for (const field of additionalFields) {
                const value = guide[field];
                const displayValue = formatFieldValue(value);
                
                detailsHTML += `
                    <div class="detail-item">
                        <span class="detail-label">${formatFieldName(field)}</span>
                        <span class="detail-value">${displayValue}</span>
                    </div>`;
            }
            
            detailsHTML += `
                    </div>
                </div>`;
        }
        
        // Add tour history section
        detailsHTML += `
                <div class="details-section">
                    <h3>Tour History</h3>
                    <div id="guideToursLoading">
                        <div class="spinner small"></div>
                        <p>Loading tour history...</p>
                    </div>
                    <div id="guideToursList" style="display: none;"></div>
                </div>
            </div>
        </div>
        
        <div class="modal-actions">
            <button class="btn-primary" onclick="messageGuideDirectly('${guideId}')">
                <i class="fas fa-envelope"></i> Message Guide
            </button>
            <button class="btn-cancel" onclick="closeGuideDetailsModal()">
                Close
            </button>
        </div>`;
        
        if (modalBody) {
            modalBody.innerHTML = detailsHTML;
        }
        
        // Load guide's tour history
        loadGuideTourHistory(guideId);
        
    } catch (error) {
        console.error('Error loading guide details:', error);
        
        if (modal) {
            const modalBody = modal.querySelector('.modal-body');
            if (modalBody) {
                modalBody.innerHTML = `
                    <div class="error-container">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #e74c3c;"></i>
                        <h3>Error Loading Guide Details</h3>
                        <p>${error.message}</p>
                    </div>
                    <div class="modal-actions" style="text-align: right; margin-top: 20px;">
                        <button class="btn-cancel" onclick="closeGuideDetailsModal()">Close</button>
                    </div>
                `;
            }
        } else {
            alert('Error loading guide details: ' + error.message);
        }
    }
}

// Create guide details modal
function createGuideDetailsModal() {
    console.log("Creating guide details modal");
    
    const modalHTML = `
        <div class="modal" id="guideDetailsModal" style="display: none;">
            <div class="modal-content guide-details-modal">
                <div class="modal-header">
                    <h3>Guide Details</h3>
                    <button class="modal-close" onclick="closeGuideDetailsModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- Content will be dynamically loaded -->
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Add styles
    const style = document.createElement('style');
    style.textContent = `
        .guide-details-modal {
            width: 90%;
            max-width: 800px;
        }
        
        .guide-details-container {
            padding: 10px 0;
        }
        
        .guide-details-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .guide-details-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 20px;
            border: 4px solid white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .guide-details-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .guide-details-info h2 {
            margin: 0 0 10px 0;
            font-size: 24px;
        }
        
        .guide-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .status-active {
            background-color: #e6f7ef;
            color: #2ecc71;
        }
        
        .status-inactive {
            background-color: #fde7e6;
            color: #e74c3c;
        }
        
        .guide-details-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .details-section {
            margin-bottom: 20px;
        }
        
        .details-section h3 {
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            color: #e67e22;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            font-weight: 500;
            color: #777;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .detail-value {
            font-size: 16px;
        }
        
        .certifications-list {
            padding-left: 20px;
            margin: 0;
        }
        
        .certifications-list li {
            margin-bottom: 5px;
        }
        
        .specialties-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .specialty-tag {
            background-color: #f5f5f5;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            color: #555;
        }
        
        .guide-biography {
            white-space: pre-line;
            line-height: 1.6;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .spinner.small {
            width: 20px;
            height: 20px;
            border-width: 2px;
        }
        
        #guideToursLoading {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tour-item {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .tour-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .tour-title {
            font-weight: 500;
            margin: 0;
        }
        
        .tour-date {
            color: #777;
            font-size: 14px;
        }
        
        .tour-details {
            display: flex;
            justify-content: space-between;
        }
        
        .tour-client {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tour-status {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-confirmed {
            background-color: #e8f4fd;
            color: #3498db;
        }
        
        .status-completed {
            background-color: #e6f7ef;
            color: #2ecc71;
        }
        
        .status-cancelled {
            background-color: #fde7e6;
            color: #e74c3c;
        }
    `;
    document.head.appendChild(style);
    
    console.log("Guide details modal created");
}

// Close guide details modal
function closeGuideDetailsModal() {
    const modal = document.getElementById('guideDetailsModal');
    if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
    }
}

// Load guide's tour history
async function loadGuideTourHistory(guideId) {
    console.log(`Loading tour history for guide ${guideId}`);
    
    const loadingElement = document.getElementById('guideToursLoading');
    const toursListElement = document.getElementById('guideToursList');
    
    if (!loadingElement || !toursListElement) return;
    
    try {
        // Get tours for this guide
        const toursRef = collection(db, "tours");
        const toursQuery = query(
            toursRef,
            where("guideId", "==", guideId),
            orderBy("createdAt", "desc"),
            limit(10)
        );
        
        const toursSnapshot = await getDocs(toursQuery);
        
        // Hide loading indicator
        loadingElement.style.display = 'none';
        toursListElement.style.display = 'block';
        
        if (toursSnapshot.empty) {
            toursListElement.innerHTML = `
                <div class="empty-state" style="text-align: center; padding: 20px;">
                    <i class="fas fa-calendar-times" style="font-size: 30px; color: #ddd; margin-bottom: 10px;"></i>
                    <p>No tours found for this guide</p>
                </div>
            `;
            return;
        }
        
        // Build tours list
        let toursHTML = '';
        
        toursSnapshot.forEach(doc => {
            const tour = doc.data();
            tour.id = doc.id;
            
            // Format date
            let tourDate = 'Date not available';
            if (tour.createdAt && tour.createdAt.seconds) {
                tourDate = new Date(tour.createdAt.seconds * 1000).toLocaleDateString();
            }
            
            // Determine status class
            let statusClass = 'status-confirmed';
            if (tour.status === 'Completed') statusClass = 'status-completed';
            if (tour.status === 'Cancelled') statusClass = 'status-cancelled';
            
            toursHTML += `
                <div class="tour-item">
                    <div class="tour-header">
                        <h4 class="tour-title">${tour.packageType || 'Safari Tour'}</h4>
                        <span class="tour-date">${tourDate}</span>
                    </div>
                    <div class="tour-details">
                        <div class="tour-client">
                            <i class="fas fa-user"></i>
                            <span>${tour.clientName || 'Unknown Client'}</span>
                        </div>
                        <span class="tour-status ${statusClass}">${tour.status || 'Unknown'}</span>
                    </div>
                </div>
            `;
        });
        
        toursListElement.innerHTML = toursHTML;
        
    } catch (error) {
        console.error('Error loading guide tour history:', error);
        
        loadingElement.style.display = 'none';
        toursListElement.style.display = 'block';
        
        toursListElement.innerHTML = `
            <div class="error-container" style="text-align: center; padding: 10px;">
                <i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i>
                <p>Error loading tour history: ${error.message}</p>
            </div>
        `;
    }
}

// Helper functions for formatting
function formatLanguages(languages) {
    if (!languages || !Array.isArray(languages) || languages.length === 0) {
        return 'English';
    }
    return languages.join(', ');
}

function formatFieldName(fieldName) {
    // Convert camelCase or snake_case to Title Case
    return fieldName
        .replace(/([A-Z])/g, ' $1') // Insert space before capital letters
        .replace(/_/g, ' ') // Replace underscores with spaces
        .replace(/^\w/, c => c.toUpperCase()) // Capitalize first letter
        .trim();
}

function formatFieldValue(value) {
    if (value === null || value === undefined) {
        return 'Not provided';
    }
    
    if (typeof value === 'boolean') {
        return value ? 'Yes' : 'No';
    }
    
    if (value instanceof Date) {
        return value.toLocaleDateString();
    }
    
    if (typeof value === 'object') {
        if (value.seconds) { // Firestore timestamp
            return new Date(value.seconds * 1000).toLocaleDateString();
        }
        
        return JSON.stringify(value);
    }
    
    return value.toString();
}

// Make functions available globally
window.viewGuideDetails = viewGuideDetails;
window.closeGuideDetailsModal = closeGuideDetailsModal;

// Edit guide details
function editGuideDetails(guideId) {
    alert(`Edit guide details functionality will be implemented soon. Guide ID: ${guideId}`);
}

// Message guide directly
// Create a completely new modal implementation
function messageGuideDirectly(guideId) {
    console.log(`Opening direct message modal for guide ${guideId}`);
    
    // Remove any existing override modal
    const existingModal = document.getElementById('customMessageModal');
    if (existingModal) {
        document.body.removeChild(existingModal);
    }
    
    // Create a new modal element
    const modalContainer = document.createElement('div');
    modalContainer.id = 'customMessageModal';
    modalContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        font-family: Arial, sans-serif;
    `;
    
    // Fetch guide data and build the modal content
    const loadGuideData = async () => {
        try {
            // Get guide details
            const guideRef = doc(db, "guides", guideId);
            const guideDoc = await getDoc(guideRef);
            
            if (!guideDoc.exists()) {
                alert('Guide not found!');
                return;
            }
            
            const guide = guideDoc.data();
            console.log("Guide data:", guide);
            
            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background-color: white;
                padding: 20px;
                border-radius: 10px;
                width: 90%;
                max-width: 500px;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            `;
            
            // Modal header
            const header = document.createElement('div');
            header.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
                padding-bottom: 15px;
                border-bottom: 1px solid #eee;
            `;
            
            const title = document.createElement('h3');
            title.textContent = 'Message Guide';
            title.style.cssText = `
                margin: 0;
                font-size: 18px;
                color: #333;
            `;
            
            const closeButton = document.createElement('button');
            closeButton.innerHTML = '&times;';
            closeButton.style.cssText = `
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #999;
                padding: 0;
                margin: 0;
            `;
            closeButton.onclick = () => {
                document.body.removeChild(modalContainer);
            };
            
            header.appendChild(title);
            header.appendChild(closeButton);
            
            // Guide info
            const guideInfo = document.createElement('div');
            guideInfo.style.cssText = `margin-bottom: 20px;`;
            
            const guideTitle = document.createElement('h4');
            guideTitle.textContent = `Message to ${guide.fullName || 'Guide'}`;
            guideTitle.style.cssText = `
                margin: 0 0 10px 0;
                font-size: 16px;
                color: #333;
            `;
            
            const guideDesc = document.createElement('p');
            guideDesc.textContent = `Send a direct message to ${guide.fullName || 'the guide'}.`;
            guideDesc.style.cssText = `
                margin: 0;
                color: #666;
                font-size: 14px;
            `;
            
            guideInfo.appendChild(guideTitle);
            guideInfo.appendChild(guideDesc);
            
            // Message form
            const form = document.createElement('form');
            form.style.cssText = `display: block;`;
            
            // Subject field
            const subjectGroup = document.createElement('div');
            subjectGroup.style.cssText = `margin-bottom: 15px;`;
            
            const subjectLabel = document.createElement('label');
            subjectLabel.textContent = 'Subject:';
            subjectLabel.style.cssText = `
                display: block;
                margin-bottom: 5px;
                font-weight: 500;
                font-size: 14px;
            `;
            
            const subjectInput = document.createElement('input');
            subjectInput.type = 'text';
            subjectInput.placeholder = 'Message subject';
            subjectInput.value = `Message from Admin`;
            subjectInput.required = true;
            subjectInput.style.cssText = `
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 14px;
                box-sizing: border-box;
            `;
            
            subjectGroup.appendChild(subjectLabel);
            subjectGroup.appendChild(subjectInput);
            
            // Message field
            const messageGroup = document.createElement('div');
            messageGroup.style.cssText = `margin-bottom: 15px;`;
            
            const messageLabel = document.createElement('label');
            messageLabel.textContent = 'Message:';
            messageLabel.style.cssText = `
                display: block;
                margin-bottom: 5px;
                font-weight: 500;
                font-size: 14px;
            `;
            
            const messageInput = document.createElement('textarea');
            messageInput.rows = 6;
            messageInput.placeholder = 'Type your message here';
            messageInput.required = true;
            messageInput.style.cssText = `
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 14px;
                resize: vertical;
                box-sizing: border-box;
            `;
            
            messageGroup.appendChild(messageLabel);
            messageGroup.appendChild(messageInput);
            
            // Form actions
            const formActions = document.createElement('div');
            formActions.style.cssText = `
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                margin-top: 20px;
            `;
            
            const cancelButton = document.createElement('button');
            cancelButton.type = 'button';
            cancelButton.textContent = 'Cancel';
            cancelButton.style.cssText = `
                padding: 10px 15px;
                background-color: #f5f5f5;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
            `;
            cancelButton.onclick = () => {
                document.body.removeChild(modalContainer);
            };
            
            const submitButton = document.createElement('button');
            submitButton.type = 'submit';
            submitButton.textContent = 'Send Message';
            submitButton.style.cssText = `
                padding: 10px 15px;
                background-color: #e67e22;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
            `;
            
            formActions.appendChild(cancelButton);
            formActions.appendChild(submitButton);
            
            // Assemble form
            form.appendChild(subjectGroup);
            form.appendChild(messageGroup);
            form.appendChild(formActions);
            
            // Handle form submission
            form.onsubmit = async (event) => {
                event.preventDefault();
                
                // Disable submit button to prevent double submission
                submitButton.disabled = true;
                submitButton.textContent = 'Sending...';
                
                try {
                    // Create a new message thread
                    const threadId = `admin_to_guide_${Date.now()}`;
                    
                    await addDoc(collection(db, "messages"), {
                        threadId: threadId,
                        sender: 'support',
                        senderName: 'Support Team',
                        recipient: guideId,
                        recipientName: guide.fullName || 'Guide',
                        subject: subjectInput.value.trim(),
                        content: messageInput.value.trim(),
                        timestamp: serverTimestamp(),
                        read: false,
                        isLatest: true
                    });
                    
                    // Remove modal
                    document.body.removeChild(modalContainer);
                    
                    // Show success message
                    alert('Message sent to guide successfully!');
                    
                } catch (error) {
                    console.error('Error sending message to guide:', error);
                    alert('Error sending message: ' + error.message);
                    submitButton.disabled = false;
                    submitButton.textContent = 'Send Message';
                }
            };
            
            // Assemble modal
            modalContent.appendChild(header);
            modalContent.appendChild(guideInfo);
            modalContent.appendChild(form);
            modalContainer.appendChild(modalContent);
            
            // Add to document
            document.body.appendChild(modalContainer);
        } catch (error) {
            console.error('Error creating modal:', error);
            alert('Error: ' + error.message);
        }
    };
    
    // Load guide data and build modal
    loadGuideData();
}

// Replace the existing function
window.messageGuideDirectly = messageGuideDirectly;
// ===== UTILITY FUNCTIONS =====

// Format time ago string
function formatTimeAgo(date) {
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) {
        return 'Just now';
    }
    
    const diffInMinutes = Math.floor(diffInSeconds / 60);
    if (diffInMinutes < 60) {
        return `${diffInMinutes} minute${diffInMinutes > 1 ? 's' : ''} ago`;
    }
    
    const diffInHours = Math.floor(diffInMinutes / 60);
    if (diffInHours < 24) {
        return `${diffInHours} hour${diffInHours > 1 ? 's' : ''} ago`;
    }
    
    const diffInDays = Math.floor(diffInHours / 24);
    if (diffInDays < 7) {
        return `${diffInDays} day${diffInDays > 1 ? 's' : ''} ago`;
    }
    
    return date.toLocaleDateString();
}

// Add styles to document
function addStyles(css) {
    const styleId = 'admin-dashboard-enhanced-styles';
    
    // Check if styles already exist
    if (!document.getElementById(styleId)) {
        const styleElement = document.createElement('style');
        styleElement.id = styleId;
        styleElement.textContent = css;
        document.head.appendChild(styleElement);
    }
}

// Close all modals
function closeModals() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.remove('active');
    });
}

// View booking details
function viewBookingDetails(bookingId) {
    alert(`View booking details functionality will be implemented soon. Booking ID: ${bookingId}`);
}

// ===== INITIALIZATION =====

// Make functions available globally
window.viewThread = viewThread;
window.viewBookingDetails = viewBookingDetails;
window.openAssignmentModal = openAssignmentModal;
window.messageGuide = messageGuide;
window.viewGuideDetails = viewGuideDetails;
window.editGuideDetails = editGuideDetails;
window.messageGuideDirectly = messageGuideDirectly;

// Initialize the dashboard when the auth state changes
onAuthStateChanged(auth, async (user) => {
    if (user) {
        console.log("User authenticated:", user.uid);
        currentUser = user;
        
        // Enhance sections
        enhanceMessagesSection();
        enhanceGuideAssignment();
        enhanceGuidesSection();
        
        // Add fixed navigation links
        setupNavigation();
    } else {
        console.log("No user authenticated, redirecting to login");
        //window.location.href = 'login.html';
    }
});

// Set up navigation
function setupNavigation() {
    // Add click handlers to navigation items
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function() {
            const sectionId = this.getAttribute('data-section');
            if (!sectionId) return;
            
            // Update active class
            document.querySelectorAll('.nav-item').forEach(navItem => {
                navItem.classList.remove('active');
            });
            this.classList.add('active');
            
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            const targetSection = document.getElementById(`${sectionId}-section`);
            if (targetSection) {
                targetSection.style.display = 'block';
            }
        });
    });
}

console.log(" Admin Dashboard Full Solution Loaded!");
/**
 * Message Thread Scrolling Fix
 * 
 * This script enhances the scrolling behavior for message threads
 * Add this to your JavaScript file or include as a separate script
 */

// Function to scroll to the bottom of a message thread when opened
function scrollMessageThreadToBottom() {
    const messageThread = document.getElementById('messageThread');
    if (messageThread) {
        messageThread.scrollTop = messageThread.scrollHeight;
    }
}

// Enhanced viewThread function with improved scrolling
async function viewThreadWithScroll(threadId, messageId) {
    console.log(`Viewing thread: ${threadId}, message: ${messageId}`);
    
    // Update global state
    currentMessageThreadId = threadId;
    currentMessageId = messageId;
    
    // Get DOM elements
    const placeholder = document.getElementById('messageDetailPlaceholder');
    const detail = document.getElementById('messageDetailContent');
    const thread = document.getElementById('messageThread');
    const senderInitials = document.getElementById('senderInitials');
    const senderName = document.getElementById('senderName');
    const messageSubject = document.getElementById('messageSubject');
    const markAsReadBtn = document.getElementById('markAsReadBtn');
    
    if (!placeholder || !detail || !thread) {
        console.error("Message detail elements not found!");
        return;
    }
    
    // Hide placeholder, show detail with loading
    placeholder.style.display = 'none';
    detail.style.display = 'flex'; // Changed to flex for better layout
    thread.innerHTML = `
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Loading conversation...</p>
        </div>
    `;
    
    // Highlight active message
    document.querySelectorAll('.message-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-thread-id') === threadId) {
            item.classList.add('active');
        }
    });
    
    try {
        // Get all messages in the thread
        const messagesRef = collection(db, "messages");
        const threadQuery = query(
            messagesRef,
            where("threadId", "==", threadId)
        );
        
        const threadSnapshot = await getDocs(threadQuery);
        console.log(`Found ${threadSnapshot.size} messages in thread ${threadId}`);
        
        if (threadSnapshot.empty) {
            thread.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>No messages found in this thread</p>
                </div>
            `;
            return;
        }
        
        // Sort messages by timestamp
        const messages = threadSnapshot.docs.map(doc => {
            return { id: doc.id, ...doc.data() };
        }).sort((a, b) => {
            const timeA = a.timestamp ? a.timestamp.seconds : 0;
            const timeB = b.timestamp ? b.timestamp.seconds : 0;
            return timeA - timeB;
        });
        
        // Get the first message for header info
        const firstMessage = messages[0];
        
        // Update header info
        let displayName = firstMessage.senderName || 'Unknown';
        if (firstMessage.sender && firstMessage.sender !== 'support') {
            const clientName = await getClientName(firstMessage.sender);
            if (clientName && clientName !== firstMessage.sender) {
                displayName = clientName;
            }
        }
        
        if (senderInitials) {
            const initials = displayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            senderInitials.textContent = initials;
        }
        
        if (senderName) senderName.textContent = displayName;
        if (messageSubject) messageSubject.textContent = firstMessage.subject || 'No subject';
        
        // Show/hide mark as read button
        if (markAsReadBtn) {
            const activeItem = document.querySelector('.message-item.active');
            if (activeItem && !activeItem.classList.contains('unread')) {
                markAsReadBtn.style.display = 'none';
            } else {
                markAsReadBtn.style.display = 'inline-flex';
            }
        }
        
        // Build thread HTML
        let threadHTML = '';
        
        for (const message of messages) {
            const isSupport = message.sender === 'support';
            
            // Format timestamp
            const timestamp = message.timestamp ? 
                new Date(message.timestamp.seconds * 1000).toLocaleString() : 
                'Recently';
            
            // Get sender name
            let senderDisplayName = isSupport ? 'Support Team' : (message.senderName || 'Unknown');
            if (!isSupport && message.sender) {
                const clientName = await getClientName(message.sender);
                if (clientName && clientName !== message.sender) {
                    senderDisplayName = clientName;
                }
            }
            
            // Get sender initials
            const bubbleInitials = isSupport ? 'S' : 
                senderDisplayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            
            threadHTML += `
                <div class="message-bubble ${isSupport ? 'support' : 'client'}">
                    <div class="message-bubble-avatar">${bubbleInitials}</div>
                    <div class="message-bubble-content">
                        <div class="message-bubble-header">
                            <div class="message-bubble-name">${senderDisplayName}</div>
                            <div class="message-bubble-time">${timestamp}</div>
                        </div>
                        <div class="message-bubble-text">${message.content || 'No content'}</div>
                    </div>
                </div>
            `;
        }
        
        thread.innerHTML = threadHTML;
        
        // Scroll to bottom of thread after a short delay to ensure content is rendered
        setTimeout(() => {
            scrollMessageThreadToBottom();
        }, 100);
        
        // Mark message as read if unread
        const activeItem = document.querySelector('.message-item.active');
        if (activeItem && activeItem.classList.contains('unread')) {
            markMessageAsRead(messageId);
        }
        
    } catch (error) {
        console.error('Error viewing thread:', error);
        thread.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-circle"></i>
                <p>Error loading thread: ${error.message}</p>
            </div>
        `;
    }
}

// Replace the original viewThread function
// If you can't directly replace it, you can call this function from the original one
// window.viewThread = viewThreadWithScroll;

// Handle reply submission with scroll to bottom
async function handleReplySubmitWithScroll(event) {
    event.preventDefault();
    
    if (!currentMessageThreadId) {
        alert('No message thread selected!');
        return;
    }
    
    const replyContent = document.getElementById('replyContent')?.value.trim();
    
    if (!replyContent) {
        alert('Please enter a reply message!');
        return;
    }
    
    try {
        // Get original message for recipient info
        const messagesRef = collection(db, "messages");
        const originalQuery = query(
            messagesRef,
            where("threadId", "==", currentMessageThreadId),
            limit(1)
        );
        
        const originalSnapshot = await getDocs(originalQuery);
        
        if (originalSnapshot.empty) {
            alert('Thread information not found!');
            return;
        }
        
        const originalMessage = originalSnapshot.docs[0].data();
        
        // Mark all messages in thread as not the latest
        const threadQuery = query(
            messagesRef,
            where("threadId", "==", currentMessageThreadId)
        );
        
        const threadSnapshot = await getDocs(threadQuery);
        
        const batch = writeBatch(db);
        threadSnapshot.forEach(doc => {
            batch.update(doc.ref, { isLatest: false });
        });
        await batch.commit();
        
        // Add reply
        await addDoc(messagesRef, {
            threadId: currentMessageThreadId,
            sender: 'support',
            senderName: 'Support Team',
            recipient: originalMessage.sender,
            recipientName: originalMessage.senderName,
            subject: originalMessage.subject || 'Re: Support Request',
            content: replyContent,
            timestamp: serverTimestamp(),
            read: false,
            isLatest: true
        });
        
        // Clear form
        document.getElementById('replyContent').value = '';
        
        // Refresh thread view
        viewThreadWithScroll(currentMessageThreadId, currentMessageId);
        
        // Show success message
        alert('Reply sent successfully!');
        
    } catch (error) {
        console.error('Error sending reply:', error);
        alert('Failed to send reply: ' + error.message);
    }
}

// Event listener to apply scrolling behavior when needed
document.addEventListener('DOMContentLoaded', function() {
    // Listen for reply form submission
    const supportReplyForm = document.getElementById('supportReplyForm');
    if (supportReplyForm) {
        supportReplyForm.addEventListener('submit', handleReplySubmitWithScroll);
    }
    
    // Add a global event listener to make viewThread function use scrolling
    if (window.viewThread) {
        const originalViewThread = window.viewThread;
        window.viewThread = function(threadId, messageId) {
            viewThreadWithScroll(threadId, messageId);
        };
    }
    
    // Ensure scrolling when switching tabs or sections
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        item.addEventListener('click', function() {
            if (this.getAttribute('data-section') === 'support-messages') {
                // If message thread is already open, scroll to bottom
                setTimeout(scrollMessageThreadToBottom, 300);
            }
        });
    });
});
// Improved Message User Functionality
// - Moves button to Support Messages section
// - Enhanced styling
// - Improved user lookup

// Function to show the message user modal
function showMessageUserModal() {
    console.log("Opening message user modal");
    
    // Check if modal exists, create it if not
    let modal = document.getElementById('messageUserModal');
    if (!modal) {
        createMessageUserModal();
        modal = document.getElementById('messageUserModal');
    }
    
    if (!modal) {
        alert("Could not create message user modal. Please refresh the page and try again.");
        return;
    }
    
    // Show the modal
    modal.classList.add('active');
    modal.style.display = 'flex';
    
    // Clear previous input
    const uidInput = document.getElementById('messageUserUid');
    const subjectInput = document.getElementById('messageUserSubject');
    const contentInput = document.getElementById('messageUserContent');
    const resultDiv = document.getElementById('userLookupResult');
    
    if (uidInput) uidInput.value = '';
    if (subjectInput) subjectInput.value = '';
    if (contentInput) contentInput.value = '';
    if (resultDiv) resultDiv.style.display = 'none';
}

// Create message user modal with enhanced styling
function createMessageUserModal() {
    console.log("Creating message user modal with enhanced styling");
    
    const modalHTML = `
        <div class="modal" id="messageUserModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-envelope"></i> Message User by ID</h3>
                    <button class="modal-close" onclick="closeMessageUserModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="user-info">
                        <p class="message-user-description">Send a direct message to any user by entering their UID.</p>
                    </div>
                    
                    <form id="messageUserForm" class="styled-message-form">
                        <div class="form-group">
                            <label for="messageUserUid">User ID (UID):</label>
                            <div class="input-with-button">
                                <input type="text" id="messageUserUid" placeholder="Enter user ID" required>
                                <button type="button" class="btn-lookup" id="messageUserLookupBtn">
                                    <i class="fas fa-search"></i> Verify
                                </button>
                            </div>
                        </div>
                        
                        <div id="userLookupResult" style="display: none;"></div>
                        
                        <div class="form-group">
                            <label for="messageUserSubject">Subject:</label>
                            <input type="text" id="messageUserSubject" placeholder="Message subject" required>
                        </div>
                        <div class="form-group message-content-group">
                            <label for="messageUserContent">Message:</label>
                            <textarea id="messageUserContent" rows="6" placeholder="Type your message here" required></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn-cancel" onclick="closeMessageUserModal()">Cancel</button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-paper-plane"></i> Send Message
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Add enhanced styles
    const style = document.createElement('style');
    style.textContent = `
        /* Enhanced Message User Modal Styles */
        #messageUserModal .modal-content {
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 650px;
        }
        
        #messageUserModal .modal-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            border-radius: 12px 12px 0 0;
            padding: 18px 24px;
        }
        
        #messageUserModal .modal-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
            color: #e67e22;
            font-size: 20px;
        }
        
        #messageUserModal .modal-body {
            padding: 24px;
        }
        
        .message-user-description {
            color: #555;
            margin-top: 0;
            margin-bottom: 24px;
            font-size: 15px;
        }
        
        .styled-message-form .form-group {
            margin-bottom: 20px;
        }
        
        .styled-message-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #444;
        }
        
        .styled-message-form input,
        .styled-message-form textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .styled-message-form input:focus,
        .styled-message-form textarea:focus {
            border-color: #e67e22;
            box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2);
            outline: none;
        }
        
        .input-with-button {
            display: flex;
            gap: 10px;
        }
        
        .input-with-button input {
            flex: 1;
        }
        
        .btn-lookup {
            padding: 0 16px;
            background-color: #f0f0f0;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            color: #555;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s;
        }
        
        .btn-lookup:hover {
            background-color: #e0e0e0;
        }
        
        .message-content-group textarea {
            resize: vertical;
            min-height: 120px;
        }
        
        #userLookupResult {
            padding: 12px 15px;
            border-radius: 8px;
            margin: 0 0 20px 0;
            font-size: 14px;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-found {
            background-color: #e6f7ef;
            border: 1px solid #2ecc71;
        }
        
        .user-not-found {
            background-color: #fde7e6;
            border: 1px solid #e74c3c;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }
        
        .btn-cancel {
            padding: 12px 24px;
            background-color: #f5f5f5;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: #555;
            transition: background-color 0.2s;
        }
        
        .btn-cancel:hover {
            background-color: #e0e0e0;
        }
        
        .btn-primary {
            padding: 12px 24px;
            background-color: #e67e22;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        
        .btn-primary:hover {
            background-color: #d35400;
        }
        
        .message-user-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background-color: #e67e22;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .message-user-btn:hover {
            background-color: #d35400;
        }
        
        #userLookupResult .status-icon {
            font-size: 18px;
            margin-right: 8px;
        }
        
        #userLookupResult .user-name {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        #userLookupResult .user-type {
            font-size: 13px;
            opacity: 0.8;
        }
        
        .spinner.mini {
            width: 16px;
            height: 16px;
            border-width: 2px;
            margin-right: 8px;
        }
    `;
    document.head.appendChild(style);
    
    // Add event listeners
    const messageUserForm = document.getElementById('messageUserForm');
    if (messageUserForm) {
        messageUserForm.addEventListener('submit', sendMessageToUser);
    }
    
    const lookupBtn = document.getElementById('messageUserLookupBtn');
    if (lookupBtn) {
        lookupBtn.addEventListener('click', lookupUser);
    }
    
    console.log("Message user modal created with enhanced styling");
}

// Close message user modal
function closeMessageUserModal() {
    const modal = document.getElementById('messageUserModal');
    if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
    }
}

// 
//  user lookup with more comprehensive search
async function lookupUser() {
    const uidInput = document.getElementById('messageUserUid');
    const resultDiv = document.getElementById('userLookupResult');
    
    if (!uidInput || !resultDiv) return;
    
    const uid = uidInput.value.trim();
    
    if (!uid) {
        alert('Please enter a user ID');
        return;
    }
    
    try {
        resultDiv.innerHTML = `
            <div style="display: flex; align-items: center;">
                <div class="spinner mini"></div>
                <span>Looking up user ID...</span>
            </div>
        `;
        resultDiv.style.display = 'block';
        resultDiv.className = '';
        
        // Check multiple collections in parallel
        const [clientDoc, userDoc, guideDoc, customerDoc, adminDoc, authUserDoc] = await Promise.all([
            // Standard collections we've been checking
            getDoc(doc(db, "clients", uid)),
            getDoc(doc(db, "users", uid)),
            getDoc(doc(db, "guides", uid)),
            
            // Additional collections to check
            getDoc(doc(db, "customers", uid)),
            getDoc(doc(db, "admins", uid)),
            getDoc(doc(db, "auth_users", uid))
        ]);
        
        // Check if user exists in any collection
        if (clientDoc.exists()) {
            displayFoundUser(resultDiv, clientDoc.data(), "Client", uid);
            return;
        }
        
        if (userDoc.exists()) {
            displayFoundUser(resultDiv, userDoc.data(), "User", uid);
            return;
        }
        
        if (guideDoc.exists()) {
            displayFoundUser(resultDiv, guideDoc.data(), "Guide", uid);
            return;
        }
        
        if (customerDoc.exists()) {
            displayFoundUser(resultDiv, customerDoc.data(), "Customer", uid);
            return;
        }
        
        if (adminDoc.exists()) {
            displayFoundUser(resultDiv, adminDoc.data(), "Admin", uid);
            return;
        }
        
        if (authUserDoc.exists()) {
            displayFoundUser(resultDiv, authUserDoc.data(), "Authenticated User", uid);
            return;
        }
        
        // If we got here, we need to check if user exists in authentication but not in database
        try {
            // This is a client-side approach to check if a user ID might be valid
            // We can only check public user data like displayName
            const authUser = await getAuth().getUser(uid).catch(() => null);
            
            if (authUser) {
                resultDiv.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <i class="fas fa-check-circle status-icon" style="color: #f39c12;"></i>
                        <div>
                            <div class="user-name">Auth User: ${authUser.displayName || uid}</div>
                            <div class="user-type">This user exists in authentication but has no profile data</div>
                        </div>
                    </div>
                `;
                resultDiv.className = 'user-found';
                return;
            }
        } catch (authError) {
            console.log('Auth check error (expected in client app):', authError);
            // This is expected to fail in client-side code
            // We'll continue with the not found message
        }
        
        // User not found in any collection
        resultDiv.innerHTML = `
            <div style="display: flex; align-items: center;">
                <i class="fas fa-exclamation-triangle status-icon" style="color: #e74c3c;"></i>
                <div>
                    <div class="user-name">User not found</div>
                    <div class="user-type">No user with ID "${uid}" was found in any database collection</div>
                </div>
            </div>
        `;
        resultDiv.className = 'user-not-found';
        
    } catch (error) {
        console.error('Error looking up user:', error);
        
        resultDiv.innerHTML = `
            <div style="display: flex; align-items: center;">
                <i class="fas fa-exclamation-triangle status-icon" style="color: #e74c3c;"></i>
                <div>
                    <div class="user-name">Error occurred</div>
                    <div class="user-type">${error.message}</div>
                </div>
            </div>
        `;
        resultDiv.className = 'user-not-found';
    }
}

// Helper function to display found user info
function displayFoundUser(resultDiv, userData, userType, uid) {
    const name = userData.fullName || userData.name || userData.displayName || uid;
    
    resultDiv.innerHTML = `
        <div style="display: flex; align-items: center;">
            <i class="fas fa-check-circle status-icon" style="color: #2ecc71;"></i>
            <div>
                <div class="user-name">${name}</div>
                <div class="user-type">${userType} account</div>
            </div>
        </div>
    `;
    resultDiv.className = 'user-found';
}

// Send message to user
async function sendMessageToUser(event) {
    event.preventDefault();
    
    const uidInput = document.getElementById('messageUserUid');
    const subjectInput = document.getElementById('messageUserSubject');
    const contentInput = document.getElementById('messageUserContent');
    
    if (!uidInput || !subjectInput || !contentInput) return;
    
    const uid = uidInput.value.trim();
    const subject = subjectInput.value.trim();
    const content = contentInput.value.trim();
    
    if (!uid) {
        alert('Please enter a user ID');
        return;
    }
    
    if (!subject) {
        alert('Please enter a subject');
        return;
    }
    
    if (!content) {
        alert('Please enter a message');
        return;
    }
    
    try {
        // Disable the submit button
        const submitBtn = event.target.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
        }
        
        // Look up user name across multiple collections
        let recipientName = uid;
        
        // Check collections in parallel
        const [clientDoc, userDoc, guideDoc, customerDoc, adminDoc, authUserDoc] = await Promise.all([
            getDoc(doc(db, "clients", uid)),
            getDoc(doc(db, "users", uid)),
            getDoc(doc(db, "guides", uid)),
            getDoc(doc(db, "customers", uid)),
            getDoc(doc(db, "admins", uid)),
            getDoc(doc(db, "auth_users", uid))
        ]).catch(err => {
            console.warn('Error checking collections:', err);
            return [null, null, null, null, null, null];
        });
        
        // Find the first collection that has user data
        const userData = 
            (clientDoc && clientDoc.exists() && clientDoc.data()) ||
            (userDoc && userDoc.exists() && userDoc.data()) ||
            (guideDoc && guideDoc.exists() && guideDoc.data()) ||
            (customerDoc && customerDoc.exists() && customerDoc.data()) ||
            (adminDoc && adminDoc.exists() && adminDoc.data()) ||
            (authUserDoc && authUserDoc.exists() && authUserDoc.data());
        
        if (userData) {
            recipientName = userData.fullName || userData.name || userData.displayName || uid;
        }
        
        // Create a new message thread
        const threadId = `admin_to_user_${Date.now()}`;
        
        // Add to messages collection
        await addDoc(collection(db, "messages"), {
            threadId: threadId,
            sender: 'support',
            senderName: 'Support Team',
            recipient: uid,
            recipientName: recipientName,
            subject: subject,
            content: content,
            timestamp: serverTimestamp(),
            read: false,
            isLatest: true
        });
        
        // Close modal
        closeMessageUserModal();
        
        // Show success message
        alert('Message sent to user successfully!');
        
    } catch (error) {
        console.error('Error sending message to user:', error);
        alert('Error sending message: ' + error.message);
    } finally {
        // Re-enable submit button
        const submitBtn = event.target.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Message';
        }
    }
}

// Add "Message User" button to the Support Messages section
function addMessageUserButtonToSupportSection() {
    // Remove any existing button from the header first
    const existingHeaderButton = document.querySelector('.header-action-btn');
    if (existingHeaderButton) {
        existingHeaderButton.remove();
    }
    
    // Add to the support messages section
    const messagesListHeader = document.querySelector('.messages-list-header');
    if (!messagesListHeader) {
        console.error('Messages list header not found');
        
        // Try adding to section header as fallback
        const sectionHeader = document.querySelector('#support-messages-section .section-header');
        if (sectionHeader) {
            addButtonToElement(sectionHeader);
        } else {
            console.error('Support messages section header not found either');
        }
        return;
    }
    
    // Add button to messages list header
    addButtonToElement(messagesListHeader);
}

// Helper to add button to a specific element
function addButtonToElement(element) {
    // Check if button already exists in this element
    if (element.querySelector('.message-user-btn')) {
        return;
    }
    
    // Create button
    const messageUserBtn = document.createElement('button');
    messageUserBtn.className = 'message-user-btn';
    messageUserBtn.innerHTML = '<i class="fas fa-envelope"></i> Message User by ID';
    messageUserBtn.onclick = showMessageUserModal;
    
    // Add button
    element.appendChild(messageUserBtn);
    console.log('Message User button added to support section');
}

// Make functions globally available
window.showMessageUserModal = showMessageUserModal;
window.closeMessageUserModal = closeMessageUserModal;
window.lookupUser = lookupUser;
window.sendMessageToUser = sendMessageToUser;

// Initialize - add button when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit to ensure the support messages section is loaded
    setTimeout(addMessageUserButtonToSupportSection, 1000);
});

// Run immediately in case the page is already loaded
if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(addMessageUserButtonToSupportSection, 1000);
}

// Watch for navigation to support messages section
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', function() {
        const sectionId = this.getAttribute('data-section');
        if (sectionId === 'support-messages') {
            // Wait a moment for section to be displayed
            setTimeout(addMessageUserButtonToSupportSection, 500);
        }
    });
});
// Bookings Section Implementation
/**
 * ENHANCED BOOKINGS IMPLEMENTATION
 * With client authentication data, cost field, and arrival/departure dates
 */

// Direct implementation of bookings functionality
(function() {
    // Explicitly declare global variables and functions
    window.bookingsData = []; // Store all bookings
    window.filteredBookingsData = []; // Store filtered bookings
    window.currentBookingsPage = 1;
    window.bookingsPerPage = 10;
    window.bookingsSortField = 'createdAt';
    window.bookingsSortDir = 'desc';
    window.clientCache = {}; // Cache for client information
    
    // ====== MAIN INITIALIZATION FUNCTION ======
    window.initializeBookingsSection = function() {
        console.log("Initializing bookings section (enhanced implementation)");
        
        // Create the UI
        createBookingsUI();
        
        // Set up event listeners
        setupBookingsEventListeners();
        
        // Load the bookings data
        fetchBookingsData();
    };
    
    // ====== CREATE UI ======
    window.createBookingsUI = function() {
        const bookingsSection = document.getElementById('bookings-section');
        if (!bookingsSection) {
            console.error("Bookings section not found");
            return;
        }
        
        bookingsSection.innerHTML = `
            <div class="section-header">
                <h2>Bookings</h2>
                <p class="section-description">Manage all safari bookings</p>
            </div>
            
            <div class="bookings-actions">
                <div class="bookings-filters">
                    <div class="search-box">
                        <input type="text" id="bookings-search" placeholder="Search bookings...">
                        <i class="fas fa-search"></i>
                    </div>
                    
                    <div class="filter-group">
                        <select id="bookings-status-filter">
                            <option value="all">All Statuses</option>
                            <option value="Confirmed">Confirmed</option>
                            <option value="Pending">Pending</option>
                            <option value="Completed">Completed</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                        
                        <select id="bookings-date-filter">
                            <option value="all">All Dates</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                </div>
                
                <div class="bookings-actions-right">
                    <button id="bookings-refresh-btn" class="action-btn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button id="bookings-export-btn" class="action-btn">
                        <i class="fas fa-file-export"></i> Export
                    </button>
                </div>
            </div>
            
            <div class="card bookings-card">
                <div class="card-body">
                    <table class="data-table" id="bookings-table">
                        <thead>
                            <tr>
                                <th data-sort="id">Booking ID <i class="fas fa-sort"></i></th>
                                <th data-sort="clientName">Client <i class="fas fa-sort"></i></th>
                                <th data-sort="packageName">Package <i class="fas fa-sort"></i></th>
                                <th data-sort="arrivalDate">Arrival <i class="fas fa-sort"></i></th>
                                <th data-sort="departureDate">Departure <i class="fas fa-sort"></i></th>
                                <th data-sort="status">Status <i class="fas fa-sort"></i></th>
                                <th data-sort="guideStatus">Guide <i class="fas fa-sort"></i></th>
                                <th data-sort="cost">Cost <i class="fas fa-sort"></i></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bookings-list">
                            <tr>
                                <td colspan="9" class="loading-row">
                                    <div class="spinner"></div>
                                    <span>Loading bookings...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="table-footer">
                        <div class="pagination">
                            <button id="bookings-prev-page" class="pagination-btn" disabled>
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div id="bookings-pagination-info">Page 1 of 1</div>
                            <button id="bookings-next-page" class="pagination-btn" disabled>
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="items-per-page">
                            <label for="bookings-per-page">Show:</label>
                            <select id="bookings-per-page">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Create modals
        createBookingDetailsModal();
    };
    
    // ====== FETCH DATA ======
    window.fetchBookingsData = function() {
        const bookingsList = document.getElementById('bookings-list');
        if (!bookingsList) return;
        
        bookingsList.innerHTML = `
            <tr>
                <td colspan="9" class="loading-row">
                    <div class="spinner"></div>
                    <span>Loading bookings...</span>
                </td>
            </tr>
        `;
        
        // Check if Firebase is available
        if (typeof firebase === 'undefined') {
            bookingsList.innerHTML = `
                <tr>
                    <td colspan="9" class="error-row">
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 32px; color: #e74c3c; margin-bottom: 10px;"></i>
                            <p>Firebase is not available. Please check your internet connection and refresh the page.</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        try {
            // Get Firestore reference
            const db = firebase.firestore();
            
            // Fetch all bookings
            db.collection("bookings").get().then(function(querySnapshot) {
                // Process the data
                window.bookingsData = [];
                
                querySnapshot.forEach(function(doc) {
                    window.bookingsData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log(`Loaded ${window.bookingsData.length} bookings`);
                
                // Apply filters and display
                filterAndDisplayBookings();
                
                // Start fetching client information
                window.bookingsData.forEach(booking => {
                    if (booking.clientId) {
                        fetchClientInfo(booking.clientId);
                    }
                });
                
            }).catch(function(error) {
                console.error("Error fetching bookings:", error);
                
                bookingsList.innerHTML = `
                    <tr>
                        <td colspan="9" class="error-row">
                            <div style="text-align: center; padding: 20px;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 32px; color: #e74c3c; margin-bottom: 10px;"></i>
                                <p>Error fetching bookings: ${error.message}</p>
                                <button onclick="fetchBookingsData()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; margin-top: 10px; cursor: pointer;">
                                    Try Again
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        } catch (error) {
            console.error("Error in fetchBookingsData:", error);
            
            bookingsList.innerHTML = `
                <tr>
                    <td colspan="9" class="error-row">
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 32px; color: #e74c3c; margin-bottom: 10px;"></i>
                            <p>Error: ${error.message}</p>
                            <button onclick="fetchBookingsData()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; margin-top: 10px; cursor: pointer;">
                                Try Again
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
    };
    
    // ====== FETCH CLIENT INFO ======
    window.fetchClientInfo = async function(clientId) {
    // Skip if already in cache
    if (window.clientCache[clientId]) return;
    
    try {
        // Get client info from users collection
        const db = firebase.firestore();
        const userDoc = await db.collection("users").doc(clientId).get();
        
        if (userDoc.exists) {
            const userData = userDoc.data();
            window.clientCache[clientId] = {
                name: userData.name || "Unknown Client", // Use 'name' field directly
                email: userData.email || "No email provided",
                phone: userData.phone || "Not provided", // Keep phone as optional
                photoURL: userData.photoURL // Keep photoURL as optional
            };
            console.log(`Cached client info for ${clientId}`);
            
            // Refresh display to show updated client info
            displayBookings();
            return;
        } else {
            console.log(`No user data found for client ID: ${clientId}`);
            // Set default/placeholder values in cache
            window.clientCache[clientId] = {
                name: "Unknown Client",
                email: "No email provided",
                phone: "Not provided",
                photoURL: null
            };
        }
    } catch (error) {
        console.error(`Error fetching client info for ${clientId}:`, error);
    }
};

    
    // ====== FILTER AND DISPLAY ======
    window.filterAndDisplayBookings = function() {
        try {
            // Get filter values
            const searchText = document.getElementById('bookings-search')?.value?.toLowerCase() || '';
            const statusFilter = document.getElementById('bookings-status-filter')?.value || 'all';
            const dateFilter = document.getElementById('bookings-date-filter')?.value || 'all';
            
            // Apply filters
            window.filteredBookingsData = window.bookingsData.filter(booking => {
                // Search filter
                if (searchText) {
                    const searchFields = [
                        booking.id,
                        booking.clientName,
                        booking.packageName,
                        booking.packageType,
                        booking.clientEmail,
                        booking.clientPhone,
                        // Include client info from cache if available
                        window.clientCache[booking.clientId]?.name,
                        window.clientCache[booking.clientId]?.email
                    ];
                    
                    // Check if any field contains the search text
                    const matchesSearch = searchFields.some(field => 
                        field && String(field).toLowerCase().includes(searchText)
                    );
                    
                    if (!matchesSearch) return false;
                }
                
                // Status filter
                if (statusFilter !== 'all') {
                    const bookingStatus = booking.bookingStatus || booking.status || 'Pending';
                    if (bookingStatus !== statusFilter) return false;
                }
                
                // Date filter
                if (dateFilter !== 'all') {
                    // Use arrival date for filtering if available, otherwise booking date
                    let bookingDate;
                    
                    if (booking.arrivalDate) {
                        if (booking.arrivalDate.seconds) {
                            bookingDate = new Date(booking.arrivalDate.seconds * 1000);
                        } else {
                            try {
                                bookingDate = new Date(booking.arrivalDate);
                            } catch (e) {
                                // Use fallback date
                                bookingDate = null;
                            }
                        }
                    }
                    
                    // Fallback dates if arrival date doesn't exist
                    if (!bookingDate) {
                        if (booking.bookingDate) {
                            if (booking.bookingDate.seconds) {
                                bookingDate = new Date(booking.bookingDate.seconds * 1000);
                            } else {
                                try {
                                    bookingDate = new Date(booking.bookingDate);
                                } catch (e) {
                                    bookingDate = null;
                                }
                            }
                        } else if (booking.createdAt) {
                            if (booking.createdAt.seconds) {
                                bookingDate = new Date(booking.createdAt.seconds * 1000);
                            } else {
                                try {
                                    bookingDate = new Date(booking.createdAt);
                                } catch (e) {
                                    bookingDate = null;
                                }
                            }
                        }
                    }
                    
                    // Skip date filtering if no valid date was found
                    if (!bookingDate) return true;
                    
                    // Compare with filter dates
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    
                    if (dateFilter === 'today') {
                        const bookingDay = new Date(bookingDate.getFullYear(), bookingDate.getMonth(), bookingDate.getDate());
                        if (bookingDay.getTime() !== today.getTime()) return false;
                    }
                    else if (dateFilter === 'week') {
                        const weekStart = new Date(today);
                        weekStart.setDate(today.getDate() - today.getDay());
                        if (bookingDate < weekStart) return false;
                    }
                    else if (dateFilter === 'month') {
                        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                        if (bookingDate < monthStart) return false;
                    }
                    else if (dateFilter === 'year') {
                        const yearStart = new Date(now.getFullYear(), 0, 1);
                        if (bookingDate < yearStart) return false;
                    }
                }
                
                // Passed all filters
                return true;
            });
            
            // Sort filtered data
            sortBookingsData();
            
            // Display the filtered and sorted bookings
            displayBookings();
            
        } catch (error) {
            console.error("Error in filterAndDisplayBookings:", error);
            
            const bookingsList = document.getElementById('bookings-list');
            if (bookingsList) {
                bookingsList.innerHTML = `
                    <tr>
                        <td colspan="9" class="error-row">
                            <div style="text-align: center; padding: 20px;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 32px; color: #e74c3c; margin-bottom: 10px;"></i>
                                <p>Error filtering bookings: ${error.message}</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
    };
    
    // ====== SORT DATA ======
    window.sortBookingsData = function() {
        try {
            window.filteredBookingsData.sort((a, b) => {
                let valueA, valueB;
                
                // Get values to compare based on sort field
                switch (window.bookingsSortField) {
                    case 'id':
                        valueA = a.id || '';
                        valueB = b.id || '';
                        break;
                    case 'clientName':
                        // Use client info from cache if available
                        valueA = window.clientCache[a.clientId]?.name || a.clientName || '';
                        valueB = window.clientCache[b.clientId]?.name || b.clientName || '';
                        break;
                    case 'packageName':
                        valueA = a.packageName || a.packageType || '';
                        valueB = b.packageName || b.packageType || '';
                        break;
                    case 'arrivalDate':
                        valueA = getDateTimestamp(a.arrivalDate);
                        valueB = getDateTimestamp(b.arrivalDate);
                        break;
                    case 'departureDate':
                        valueA = getDateTimestamp(a.departureDate);
                        valueB = getDateTimestamp(b.departureDate);
                        break;
                    case 'status':
                        valueA = a.bookingStatus || a.status || '';
                        valueB = b.bookingStatus || b.status || '';
                        break;
                    case 'guideStatus':
                        valueA = a.guideId ? 'Assigned' : 'Unassigned';
                        valueB = b.guideId ? 'Assigned' : 'Unassigned';
                        break;
                    case 'cost':
                        valueA = a.cost || a.totalAmount || 0;
                        valueB = b.cost || b.totalAmount || 0;
                        break;
                    case 'createdAt':
                    default:
                        valueA = getDateTimestamp(a.createdAt);
                        valueB = getDateTimestamp(b.createdAt);
                }
                
                // Compare based on data type
                let comparison;
                if (typeof valueA === 'string' && typeof valueB === 'string') {
                    comparison = valueA.localeCompare(valueB);
                } else {
                    comparison = valueA < valueB ? -1 : (valueA > valueB ? 1 : 0);
                }
                
                // Apply sort direction
                return window.bookingsSortDir === 'asc' ? comparison : -comparison;
            });
        } catch (error) {
            console.error("Error sorting bookings:", error);
        }
    };
    
    // ====== DISPLAY BOOKINGS ======
    window.displayBookings = function() {
        const bookingsList = document.getElementById('bookings-list');
        if (!bookingsList) return;
        
        try {
            // Check if we have any bookings to display
            if (window.filteredBookingsData.length === 0) {
                bookingsList.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-row">
                            <div style="text-align: center; padding: 30px;">
                                <i class="fas fa-calendar-times" style="font-size: 48px; color: #ddd; margin-bottom: 15px;"></i>
                                <p style="margin: 0; color: #888; font-size: 16px;">No bookings found</p>
                                <p style="margin-top: 10px; font-size: 14px; color: #888;">Try adjusting your filters or search criteria.</p>
                            </div>
                        </td>
                    </tr>
                `;
                
                // Update pagination
                updatePagination();
                return;
            }
            
            // Calculate pagination
            const startIndex = (window.currentBookingsPage - 1) * window.bookingsPerPage;
            const endIndex = Math.min(startIndex + window.bookingsPerPage, window.filteredBookingsData.length);
            const pageBookings = window.filteredBookingsData.slice(startIndex, endIndex);
            
            // Generate HTML
            let html = '';
            
            pageBookings.forEach(booking => {
                // Format booking ID
                const shortId = booking.id.substring(0, 8);
                
                // Format client name - check client cache first
                let clientName = 'Unknown Client';
                if (booking.clientId && window.clientCache[booking.clientId]?.name) {
                    clientName = window.clientCache[booking.clientId].name;
                } else if (booking.clientName) {
                    clientName = booking.clientName;
                }
                
                // Format package name
                const packageName = booking.packageName || booking.packageType || 'Standard Package';
                
                // Format arrival date
                let arrivalDate = 'Not set';
                if (booking.arrivalDate) {
                    if (booking.arrivalDate.seconds) {
                        try {
                            arrivalDate = new Date(booking.arrivalDate.seconds * 1000).toLocaleDateString();
                        } catch (e) {
                            console.warn('Invalid date conversion:', e);
                        }
                    } else {
                        try {
                            arrivalDate = new Date(booking.arrivalDate).toLocaleDateString();
                        } catch (e) {
                            console.warn('Invalid date conversion:', e);
                        }
                    }
                }
                
                // Format departure date
                let departureDate = 'Not set';
                if (booking.departureDate) {
                    if (booking.departureDate.seconds) {
                        try {
                            departureDate = new Date(booking.departureDate.seconds * 1000).toLocaleDateString();
                        } catch (e) {
                            console.warn('Invalid date conversion:', e);
                        }
                    } else {
                        try {
                            departureDate = new Date(booking.departureDate).toLocaleDateString();
                        } catch (e) {
                            console.warn('Invalid date conversion:', e);
                        }
                    }
                }
                
                // Format status
                const status = booking.bookingStatus || booking.status || 'Pending';
                const statusClass = `status-${status.toLowerCase()}`;
                
                // Format guide status
                const guideStatus = booking.guideId ? 'Assigned' : 'Unassigned';
                const guideStatusClass = `status-${guideStatus.toLowerCase()}`;
                
                // Format cost
                let cost = 'Not set';
                if (booking.cost) {
                    try {
                        cost = '$' + parseFloat(booking.cost).toLocaleString(undefined, {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                    } catch (e) {
                        console.warn('Invalid cost format:', e);
                        cost = String(booking.cost);
                    }
                } else if (booking.totalAmount) {
                    try {
                        cost = '' + parseFloat(booking.totalAmount).toLocaleString(undefined, {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                    } catch (e) {
                        console.warn('Invalid amount format:', e);
                        cost = String(booking.totalAmount);
                    }
                }
                
                html += `
                    <tr data-id="${booking.id}">
                        <td>${shortId}...</td>
                        <td>${clientName}</td>
                        <td>${packageName}</td>
                        <td>${arrivalDate}</td>
                        <td>${departureDate}</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                        <td><span class="status-badge ${guideStatusClass}">${guideStatus}</span></td>
                        <td>${cost}</td>
                        <td>
                            <div class="action-btns">
                                <button class="action-btn view" onclick="showBookingDetails('${booking.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn edit" onclick="editBookingData('${booking.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${status !== 'Cancelled' ? `
                                    <button class="action-btn delete" onclick="cancelBookingData('${booking.id}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            bookingsList.innerHTML = html;
            
            // Update pagination
            updatePagination();
            
            // Update sort indicators
            updateSortIndicators();
            
        } catch (error) {
            console.error("Error displaying bookings:", error);
            
            bookingsList.innerHTML = `
                <tr>
                    <td colspan="9" class="error-row">
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 32px; color: #e74c3c; margin-bottom: 10px;"></i>
                            <p>Error displaying bookings: ${error.message}</p>
                        </div>
                    </td>
                </tr>
            `;
        }
    };
    
    // ====== UPDATE PAGINATION ======
    window.updatePagination = function() {
        try {
            const totalPages = Math.ceil(window.filteredBookingsData.length / window.bookingsPerPage) || 1;
            const paginationInfo = document.getElementById('bookings-pagination-info');
            const prevBtn = document.getElementById('bookings-prev-page');
            const nextBtn = document.getElementById('bookings-next-page');
            
            if (paginationInfo) {
                paginationInfo.textContent = `Page ${window.currentBookingsPage} of ${totalPages}`;
            }
            
            if (prevBtn) {
                prevBtn.disabled = window.currentBookingsPage <= 1;
            }
            
            if (nextBtn) {
                nextBtn.disabled = window.currentBookingsPage >= totalPages;
            }
        } catch (error) {
            console.error("Error updating pagination:", error);
        }
    };
    
    // ====== UPDATE SORT INDICATORS ======
    window.updateSortIndicators = function() {
        try {
            // Remove active class from all headers
            document.querySelectorAll('#bookings-table th[data-sort]').forEach(header => {
                header.classList.remove('active', 'asc', 'desc');
            });
            
            // Add active class to current sort header
            const currentHeader = document.querySelector(`#bookings-table th[data-sort="${window.bookingsSortField}"]`);
            if (currentHeader) {
                currentHeader.classList.add('active', window.bookingsSortDir);
            }
        } catch (error) {
            console.error("Error updating sort indicators:", error);
        }
    };
    
    // ====== NAVIGATION FUNCTIONS ======
    window.goToPrevBookingsPage = function() {
        if (window.currentBookingsPage > 1) {
            window.currentBookingsPage--;
            displayBookings();
        }
    };
    
    window.goToNextBookingsPage = function() {
        const totalPages = Math.ceil(window.filteredBookingsData.length / window.bookingsPerPage) || 1;
        if (window.currentBookingsPage < totalPages) {
            window.currentBookingsPage++;
            displayBookings();
        }
    };
    
    // ====== SORTING FUNCTION ======
    window.sortBookingsBy = function(field) {
        if (field === window.bookingsSortField) {
            // Toggle sort direction
            window.bookingsSortDir = window.bookingsSortDir === 'asc' ? 'desc' : 'asc';
        } else {
            // Set new sort field
            window.bookingsSortField = field;
            window.bookingsSortDir = 'asc';
        }
        
        // Apply sort and update display
        sortBookingsData();
        displayBookings();
    };
    
    // ====== VIEW BOOKING DETAILS ======
    // This is a complete replacement for your showBookingDetails function
window.showBookingDetails = function(bookingId) {
    console.log("Showing details for booking:", bookingId);
    
    // Find booking by ID
    const booking = window.bookingsData.find(b => b.id === bookingId);
    if (!booking) {
        alert("Booking not found!");
        return;
    }
    
    // Get modal element
    const detailsModal = document.getElementById('booking-details-modal');
    const modalContent = document.getElementById('booking-details-content');
    
    if (!detailsModal || !modalContent) {
        console.error("Booking details modal not found");
        return;
    }
    
    // Format client name - check client cache first
    let clientName = 'Unknown Client';
    let clientEmail = 'Not provided';
    let clientPhone = 'Not provided';

    if (booking.clientId && window.clientCache[booking.clientId]) {
        const clientInfo = window.clientCache[booking.clientId];
        clientName = clientInfo.name;
        clientEmail = clientInfo.email;
        if (clientInfo.phone) clientPhone = clientInfo.phone;
    } else if (booking.clientName) {
        clientName = booking.clientName;
        if (booking.clientEmail) clientEmail = booking.clientEmail;
        if (booking.clientPhone) clientPhone = booking.clientPhone;
    }
    
    const packageName = booking.packageName || booking.packageType || 'Standard Package';
    const status = booking.bookingStatus || booking.status || 'Pending';
    
    // Format ARRIVAL date - handle nested structure
    let arrivalDate = 'Not set';
    let arrivalTime = '';
    
    if (booking.dates && booking.dates.arrival) {
        // Get arrival date
        if (booking.dates.arrival.date) {
            if (booking.dates.arrival.date.seconds) {
                arrivalDate = new Date(booking.dates.arrival.date.seconds * 1000).toLocaleDateString();
            } else if (typeof booking.dates.arrival.date === 'string') {
                arrivalDate = new Date(booking.dates.arrival.date).toLocaleDateString();
            }
        }
        
        // Get arrival time
        if (booking.dates.arrival.time) {
            arrivalTime = booking.dates.arrival.time;
        }
    }
    
    // Format DEPARTURE date - handle nested structure
    let departureDate = 'Not set';
    let departureTime = '';
    
    if (booking.dates && booking.dates.departure) {
        // Get departure date
        if (booking.dates.departure.date) {
            if (booking.dates.departure.date.seconds) {
                departureDate = new Date(booking.dates.departure.date.seconds * 1000).toLocaleDateString();
            } else if (typeof booking.dates.departure.date === 'string') {
                departureDate = new Date(booking.dates.departure.date).toLocaleDateString();
            }
        }
        
        // Get departure time
        if (booking.dates.departure.time) {
            departureTime = booking.dates.departure.time;
        }
    }
    
    // Format booking date
    let bookingDate = 'Not set';
    if (booking.bookingDate) {
        if (booking.bookingDate.seconds) {
            bookingDate = new Date(booking.bookingDate.seconds * 1000).toLocaleString();
        } else {
            try {
                bookingDate = new Date(booking.bookingDate).toLocaleString();
            } catch (e) {
                console.warn('Invalid booking date format:', booking.bookingDate);
            }
        }
    }
    
    // Format creation date
    let createdAt = 'Not available';
    if (booking.createdAt) {
        if (booking.createdAt.seconds) {
            createdAt = new Date(booking.createdAt.seconds * 1000).toLocaleString();
        } else {
            try {
                createdAt = new Date(booking.createdAt).toLocaleString();
            } catch (e) {
                console.warn('Invalid creation date format:', booking.createdAt);
            }
        }
    }
    
    // Format cost - use cost field first, then totalAmount as fallback
    let cost = 'Not set';
    if (booking.cost) {
        try {
            cost = '$' + parseFloat(booking.cost).toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        } catch (e) {
            cost = booking.cost;
        }
    } else if (booking.totalAmount) {
        try {
            cost = '$' + parseFloat(booking.totalAmount).toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        } catch (e) {
            cost = booking.totalAmount;
        }
    }
    
    // Build HTML content for the modal
    let html = `
        <div class="booking-details-container">
            <div class="booking-details-left">
                <div class="booking-details-section">
                    <h4>Booking Information</h4>
                    <div class="detail-item">
                        <div class="detail-label">Booking ID:</div>
                        <div class="detail-value">${booking.id}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Status:</div>
                        <div class="detail-value">
                            <span class="status-badge status-${status.toLowerCase()}">
                                ${status}
                            </span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Booking Date:</div>
                        <div class="detail-value">${bookingDate}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Created On:</div>
                        <div class="detail-value">${createdAt}</div>
                    </div>
                </div>
                
                <div class="booking-details-section">
                    <h4>Client Information</h4>
                    <div class="detail-item">
                        <div class="detail-label">Client Name:</div>
                        <div class="detail-value">${clientName}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Email:</div>
                        <div class="detail-value">${clientEmail}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Phone:</div>
                        <div class="detail-value">${clientPhone}</div>
                    </div>
                    ${booking.clientId ? `
                        <div class="detail-item">
                            <div class="detail-label">Client ID:</div>
                            <div class="detail-value">${booking.clientId}</div>
                        </div>
                    ` : ''}
                </div>
                
                <div class="booking-details-section">
                    <h4>Trip Details</h4>
                    <div class="detail-item">
                        <div class="detail-label">Arrival:</div>
                        <div class="detail-value">${arrivalDate} ${arrivalTime ? `at ${arrivalTime}` : ''}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Departure:</div>
                        <div class="detail-value">${departureDate} ${departureTime ? `at ${departureTime}` : ''}</div>
                    </div>
                    ${booking.duration ? `
                        <div class="detail-item">
                            <div class="detail-label">Duration:</div>
                            <div class="detail-value">${booking.duration} ${parseInt(booking.duration) === 1 ? 'day' : 'days'}</div>
                        </div>
                    ` : ''}
                    ${booking.participants ? `
                        <div class="detail-item">
                            <div class="detail-label">Participants:</div>
                            <div class="detail-value">${booking.participants}</div>
                        </div>
                    ` : ''}
                </div>
                
                <div class="booking-details-section">
                    <h4>Package Details</h4>
                    <div class="package-details">
                        <div class="package-item">
                            <span>Package:</span>
                            <span>${packageName}</span>
                        </div>
                        ${booking.packageDuration ? `
                            <div class="package-item">
                                <span>Duration:</span>
                                <span>${booking.packageDuration}</span>
                            </div>
                        ` : ''}
                        ${booking.adults ? `
                            <div class="package-item">
                                <span>Adults:</span>
                                <span>${booking.adults}</span>
                            </div>
                        ` : ''}
                        ${booking.children ? `
                            <div class="package-item">
                                <span>Children:</span>
                                <span>${booking.children}</span>
                            </div>
                        ` : ''}
                        <div class="package-total">
                            <span>Total Cost:</span>
                            <span>${cost}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="booking-details-right">
                <div class="booking-details-section">
                    <h4>Guide Information</h4>
                    ${booking.guideId && booking.guideName ? `
                        <div class="detail-item">
                            <div class="detail-label">Guide Name:</div>
                            <div class="detail-value">${booking.guideName}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Experience:</div>
                            <div class="detail-value">${booking.guideExperience || 'Not specified'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Assignment Status:</div>
                            <div class="detail-value">
                                <span class="status-badge status-assigned">Assigned</span>
                            </div>
                        </div>
                    ` : `
                        <div class="detail-item">
                            <div class="detail-label">Guide Status:</div>
                            <div class="detail-value">
                                <span class="status-badge status-unassigned">Unassigned</span>
                            </div>
                        </div>
                        <div class="booking-notes">
                            <p>No guide has been assigned to this booking yet.</p>
                            <p>You can assign a guide from the Guide Assignment section.</p>
                        </div>
                    `}
                </div>
                
                ${booking.notes || booking.specialRequests ? `
                    <div class="booking-details-section">
                        <h4>Notes & Special Requests</h4>
                        <div class="booking-notes">
                            ${booking.notes || booking.specialRequests}
                        </div>
                    </div>
                ` : ''}
                
                <div class="booking-details-actions">
                    <button class="action-btn edit" onclick="editBookingData('${booking.id}')">
                        <i class="fas fa-edit"></i> Edit Booking
                    </button>
                    ${status !== 'Cancelled' ? `
                        <button class="action-btn delete" onclick="cancelBookingData('${booking.id}')">
                            <i class="fas fa-times"></i> Cancel Booking
                        </button>
                    ` : ''}
                    ${!booking.guideId ? `
                        <button class="action-btn view" onclick="assignGuideToBooking('${booking.id}')">
                            <i class="fas fa-user-plus"></i> Assign Guide
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    
    // Set modal content and show modal
    modalContent.innerHTML = html;
    detailsModal.style.display = 'flex';
};
    
    // ====== EDIT BOOKING ======
    window.editBookingData = function(bookingId) {
        alert(`Edit booking function for ID: ${bookingId} - This functionality is not yet implemented.`);
    };
    
    // ====== CANCEL BOOKING ======
    window.cancelBookingData = function(bookingId) {
        if (confirm(`Are you sure you want to cancel booking ${bookingId}?`)) {
            try {
                const db = firebase.firestore();
                
                // Get reason for cancellation
                const reason = prompt("Please enter a reason for cancellation (optional):", "");
                
                db.collection("bookings").doc(bookingId).update({
                    bookingStatus: "Cancelled",
                    status: "Cancelled",
                    cancellationReason: reason || "Cancelled by admin",
                    cancelledAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert("Booking cancelled successfully!");
                    
                    // Update local data
                    const booking = window.bookingsData.find(b => b.id === bookingId);
                    if (booking) {
                        booking.bookingStatus = "Cancelled";
                        booking.status = "Cancelled";
                        booking.cancellationReason = reason || "Cancelled by admin";
                    }
                    
                    // Refresh display
                    filterAndDisplayBookings();
                    
                    // Close modal if open
                    const modal = document.getElementById('booking-details-modal');
                    if (modal && modal.style.display === 'flex') {
                        modal.style.display = 'none';
                    }
                    
                }).catch(error => {
                    console.error("Error cancelling booking:", error);
                    alert(`Error cancelling booking: ${error.message}`);
                });
                
            } catch (error) {
                console.error("Error in cancelBookingData:", error);
                alert(`Error: ${error.message}`);
            }
        }
    };
    
    // ====== ASSIGN GUIDE ======
    window.assignGuideToBooking = function(bookingId) {
        alert(`Guide assignment for booking ID: ${bookingId} - This functionality is not yet implemented.`);
    };
    
    // ====== CREATE MODALS ======
    // Create booking details modal
    function createBookingDetailsModal() {
        // Check if modal already exists
        if (document.getElementById('booking-details-modal')) {
            return;
        }
        
        // Create modal element
        const modal = document.createElement('div');
        modal.id = 'booking-details-modal';
        modal.className = 'modal';
        modal.style.cssText = `
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        `;
        
        modal.innerHTML = `
            <div class="modal-content booking-details-modal" style="
                background-color: white;
                border-radius: 10px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
                width: 90%;
                max-width: 900px;
                max-height: 90vh;
                overflow-y: auto;
            ">
                <div class="modal-header" style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 15px 20px;
                    border-bottom: 1px solid #eee;
                ">
                    <h3 style="margin: 0;">Booking Details</h3>
                    <button class="modal-close" onclick="closeBookingDetailsModal()" style="
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                        color: #999;
                    ">&times;</button>
                </div>
                <div class="modal-body" id="booking-details-content" style="
                    padding: 20px;
                ">
                    <div class="loading-container" style="
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        padding: 30px;
                    ">
                        <div class="spinner" style="
                            width: 40px;
                            height: 40px;
                            border: 4px solid #f3f3f3;
                            border-top: 4px solid #e67e22;
                            border-radius: 50%;
                            animation: spin 1s linear infinite;
                            margin-bottom: 15px;
                        "></div>
                        <span>Loading booking details...</span>
                    </div>
                </div>
            </div>
        `;
        
        // Add to document
        document.body.appendChild(modal);
        
        // Add styles
        const style = document.createElement('style');
        style.id = 'booking-modal-styles';
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            .booking-details-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
            }
            
            @media (max-width: 768px) {
                .booking-details-container {
                    grid-template-columns: 1fr;
                }
            }
            
            .booking-details-section {
                margin-bottom: 20px;
            }
            
            .booking-details-section h4 {
                margin-top: 0;
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 1px solid #eee;
                color: #e67e22;
            }
            
            .detail-item {
                display: flex;
                margin-bottom: 10px;
            }
            
            .detail-label {
                width: 140px;
                font-weight: 500;
                color: #555;
            }
            
            .detail-value {
                flex: 1;
            }
            
            .booking-notes {
                background-color: #f9f9f9;
                padding: 15px;
                border-radius: 5px;
                margin-top: 10px;
            }
            
            .package-details {
                padding: 15px;
                background-color: #f9f9f9;
                border-radius: 5px;
                margin-bottom: 15px;
            }
            
            .package-item {
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
                font-size: 14px;
            }
            
            .package-total {
                margin-top: 10px;
                padding-top: 10px;
                border-top: 1px dashed #ddd;
                font-weight: 600;
                display: flex;
                justify-content: space-between;
            }
            
            .booking-details-actions {
                display: flex;
                gap: 10px;
                margin-top: 20px;
                flex-wrap: wrap;
            }
            
            .action-btn {
                display:inline-block;
                align-items: center;
                gap: 5px;
                padding: 8px 12px;
                border-radius: 5px;
                border: none;
                cursor: pointer;
                font-size: 14px;
                background-color: #f0f0f0;
                color: #555;
            }
            
            .action-btn.view {
                background-color: #e8f4fd;
                color: #3498db;
            }
            
            .action-btn.edit {
                background-color: #fff5eb;
                color: #e67e22;
                margin-left: 20px
            }
            
            .action-btn.delete {
                background-color: #fde7e6;
                color: #e74c3c;
            }
            
            .status-badge {
                display: inline-block;
                padding: 5px 10px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 500;
            }
            
            .status-confirmed {
                background-color: #e8f4fd;
                color: #3498db;
            }
            
            .status-pending {
                background-color: #fff5eb;
                color: #e67e22;
            }
            
            .status-completed {
                background-color: #e6f7ef;
                color: #2ecc71;
            }
            
            .status-cancelled {
                background-color: #fde7e6;
                color: #e74c3c;
            }
            
            .status-assigned {
                background-color: #e6f7ef;
                color: #2ecc71;
            }
            
            .status-unassigned {
                background-color: #f0f0f0;
                color: #777;
            }
            
            .data-table th.active i {
                color: #e67e22;
            }
            
            .data-table th.asc i:before {
                content: "\\f0de"; /* fa-sort-up */
            }
            
            .data-table th.desc i:before {
                content: "\\f0dd"; /* fa-sort-down */
            }
        `;
        
        document.head.appendChild(style);
    }
    
    // ====== CLOSE MODALS ======
    window.closeBookingDetailsModal = function() {
        const modal = document.getElementById('booking-details-modal');
        if (modal) {
            modal.style.display = 'none';
        }
    };
    
    // ====== SETUP EVENT LISTENERS ======
    function setupBookingsEventListeners() {
        // Search input
        const searchInput = document.getElementById('bookings-search');
        if (searchInput) {
            searchInput.addEventListener('input', () => {
                filterAndDisplayBookings();
            });
        }
        
        // Status filter
        const statusFilter = document.getElementById('bookings-status-filter');
        if (statusFilter) {
            statusFilter.addEventListener('change', () => {
                filterAndDisplayBookings();
            });
        }
        
        // Date filter
        const dateFilter = document.getElementById('bookings-date-filter');
        if (dateFilter) {
            dateFilter.addEventListener('change', () => {
                filterAndDisplayBookings();
            });
        }
        
        // Refresh button
        const refreshBtn = document.getElementById('bookings-refresh-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                fetchBookingsData();
            });
        }
        
        // Export button
        const exportBtn = document.getElementById('bookings-export-btn');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => {
                exportBookingsToCSV();
            });
        }
        
        // Pagination buttons
        const prevBtn = document.getElementById('bookings-prev-page');
        if (prevBtn) {
            prevBtn.addEventListener('click', () => {
                goToPrevBookingsPage();
            });
        }
        
        const nextBtn = document.getElementById('bookings-next-page');
        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                goToNextBookingsPage();
            });
        }
        
        // Items per page
        const itemsPerPage = document.getElementById('bookings-per-page');
        if (itemsPerPage) {
            itemsPerPage.addEventListener('change', () => {
                window.bookingsPerPage = parseInt(itemsPerPage.value);
                window.currentBookingsPage = 1; // Reset to first page
                displayBookings();
            });
        }
        
        // Table header sorting
        const tableHeaders = document.querySelectorAll('#bookings-table th[data-sort]');
        tableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const field = header.getAttribute('data-sort');
                sortBookingsBy(field);
            });
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', event => {
            const modal = document.getElementById('booking-details-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
        
        // Close modal with Escape key
        window.addEventListener('keydown', event => {
            if (event.key === 'Escape') {
                const modal = document.getElementById('booking-details-modal');
                if (modal && modal.style.display === 'flex') {
                    modal.style.display = 'none';
                }
            }
        });
    }
    
    // ====== EXPORT TO CSV ======
    window.exportBookingsToCSV = function() {
        try {
            // Create CSV content
            const headers = [
                'Booking ID',
                'Client Name',
                'Email',
                'Phone',
                'Package',
                'Arrival Date',
                'Departure Date',
                'Status',
                'Guide Status',
                'Cost',
                'Created Date'
            ];
            
            // Start with headers
            let csvContent = headers.join(',') + '\n';
            
            // Add each booking
            window.filteredBookingsData.forEach(booking => {
                // Get client info
                let clientName = booking.clientName || '';
                let clientEmail = booking.clientEmail || '';
                let clientPhone = booking.clientPhone || '';
                
                if (booking.clientId && window.clientCache[booking.clientId]) {
                    const clientInfo = window.clientCache[booking.clientId];
                    if (clientInfo.name) clientName = clientInfo.name;
                    if (clientInfo.email) clientEmail = clientInfo.email;
                    if (clientInfo.phone) clientPhone = clientInfo.phone;
                }
                
                const row = [
                    `"${booking.id}"`,
                    `"${clientName}"`,
                    `"${clientEmail}"`,
                    `"${clientPhone}"`,
                    `"${booking.packageName || booking.packageType || ''}"`,
                    `"${formatDateForCSV(booking.arrivalDate)}"`,
                    `"${formatDateForCSV(booking.departureDate)}"`,
                    `"${booking.bookingStatus || booking.status || ''}"`,
                    `"${booking.guideId ? 'Assigned' : 'Unassigned'}"`,
                    `"${booking.cost || booking.totalAmount || ''}"`,
                    `"${formatDateForCSV(booking.createdAt)}"`
                ];
                
                csvContent += row.join(',') + '\n';
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `bookings_export_${formatDateForFilename(new Date())}.csv`);
            link.style.visibility = 'hidden';
            
            // Append, click, and remove
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
        } catch (error) {
            console.error("Error exporting to CSV:", error);
            alert(`Error exporting bookings: ${error.message}`);
        }
    };
    
    // ====== HELPER FUNCTIONS ======
    // Get timestamp from Firestore date
    function getDateTimestamp(firestoreDate) {
        if (!firestoreDate) return 0;
        
        try {
            if (firestoreDate.seconds) {
                return firestoreDate.seconds * 1000;
            }
            
            if (typeof firestoreDate === 'string') {
                return new Date(firestoreDate).getTime();
            }
        } catch (error) {
            console.warn('Error converting date:', error);
        }
        
        return 0;
    }
    
    // Format date for CSV
    function formatDateForCSV(firestoreDate) {
        if (!firestoreDate) return '';
        
        try {
            if (firestoreDate.seconds) {
                return new Date(firestoreDate.seconds * 1000).toISOString();
            }
            
            if (typeof firestoreDate === 'string') {
                return new Date(firestoreDate).toISOString();
            }
        } catch (error) {
            console.warn('Error formatting date for CSV:', error);
        }
        
        return '';
    }
    
    // Format date for filename
    function formatDateForFilename(date) {
        return date.toISOString().split('T')[0];
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Look for bookings section
        const bookingsSection = document.getElementById('bookings-section');
        
        if (bookingsSection) {
            console.log("Bookings section found, initializing");
            initializeBookingsSection();
        }
        
        // Set up navigation event listener
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                const sectionId = this.getAttribute('data-section');
                if (sectionId === 'bookings') {
                    console.log("Navigated to bookings section, initializing");
                    initializeBookingsSection();
                }
            });
        });
    });
    
})();
// ====== EDIT BOOKING FUNCTIONALITY ======

// Main function to edit booking data - called from the edit buttons
window.editBookingData = function(bookingId) {
    console.log("Editing booking:", bookingId);
    
    // Find booking by ID
    const booking = window.bookingsData.find(b => b.id === bookingId);
    if (!booking) {
        alert("Booking not found!");
        return;
    }
    
    // Create modal if it doesn't exist
    createEditBookingModal();
    
    // Get modal element
    const editModal = document.getElementById('edit-booking-modal');
    if (!editModal) {
        console.error("Edit booking modal not found");
        return;
    }
    
    // Populate the form with booking data
    populateEditBookingForm(booking);
    
    // Show the modal
    editModal.style.display = 'flex';
};

// Function to create the edit booking modal
function createEditBookingModal() {
    // Check if modal already exists
    if (document.getElementById('edit-booking-modal')) {
        return;
    }
    
    // Create modal element
    const modal = document.createElement('div');
    modal.id = 'edit-booking-modal';
    modal.className = 'modal';
    modal.style.cssText = `
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    `;
    
    modal.innerHTML = `
        <div class="modal-content edit-booking-modal" style="
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        ">
            <div class="modal-header" style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 20px;
                border-bottom: 1px solid #eee;
            ">
                <h3 style="margin: 0;">Edit Booking</h3>
                <button class="modal-close" onclick="closeEditBookingModal()" style="
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: #999;
                ">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <form id="edit-booking-form">
                    <input type="hidden" id="edit-booking-id">
                    
                    <div class="form-tabs">
                        <div class="tab-controls">
                            <button type="button" class="tab-control active" data-tab="booking-info">Booking Info</button>
                            <button type="button" class="tab-control" data-tab="trip-details">Trip Details</button>
                            <button type="button" class="tab-control" data-tab="package-info">Package Info</button>
                            <button type="button" class="tab-control" data-tab="guide-info">Guide & Notes</button>
                        </div>
                        
                        <div class="tab-content">
                            <!-- Booking Info Tab -->
                            <div class="tab-pane active" id="booking-info-tab">
                                <div class="edit-section">
                                    <h4>Booking Status</h4>
                                    <div class="form-group">
                                        <label for="edit-status">Booking Status:</label>
                                        <select id="edit-status" required>
                                            <option value="Pending">Pending</option>
                                            <option value="Confirmed">Confirmed</option>
                                            <option value="Completed">Completed</option>
                                            <option value="Cancelled">Cancelled</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="edit-section">
                                    <h4>Client Information</h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="edit-client-name">Client Name:</label>
                                            <input type="text" id="edit-client-name" placeholder="Client Name">
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-client-email">Email:</label>
                                            <input type="email" id="edit-client-email" placeholder="Client Email">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="edit-client-phone">Phone:</label>
                                            <input type="text" id="edit-client-phone" placeholder="Client Phone">
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-client-id">Client ID:</label>
                                            <input type="text" id="edit-client-id" placeholder="Client ID" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Trip Details Tab -->
                            <div class="tab-pane" id="trip-details-tab">
                                <div class="edit-section">
                                    <h4>Trip Dates</h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="edit-arrival-date">Arrival Date:</label>
                                            <input type="date" id="edit-arrival-date">
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-arrival-time">Arrival Time:</label>
                                            <input type="time" id="edit-arrival-time">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="edit-departure-date">Departure Date:</label>
                                            <input type="date" id="edit-departure-date">
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-departure-time">Departure Time:</label>
                                            <input type="time" id="edit-departure-time">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="edit-duration">Duration (days):</label>
                                            <input type="number" id="edit-duration" min="1">
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-participants">Total Participants:</label>
                                            <input type="number" id="edit-participants" min="1">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Package Info Tab -->
                            <div class="tab-pane" id="package-info-tab">
                                <div class="edit-section">
                                    <h4>Package Details</h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="edit-package-name">Package Name:</label>
                                            <input type="text" id="edit-package-name" placeholder="Package Name">
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-package-type">Package Type:</label>
                                            <select id="edit-package-type">
                                                <option value="Standard">Standard</option>
                                                <option value="Premium">Premium</option>
                                                <option value="Deluxe">Deluxe</option>
                                                <option value="Custom">Custom</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="edit-adults">Number of Adults:</label>
                                            <input type="number" id="edit-adults" min="0">
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-children">Number of Children:</label>
                                            <input type="number" id="edit-children" min="0">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="edit-cost">Total Cost ($):</label>
                                            <input type="number" id="edit-cost" min="0" step="0.01">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Guide & Notes Tab -->
                            <div class="tab-pane" id="guide-info-tab">
                                <div class="edit-section">
                                    <h4>Guide Assignment</h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="edit-guide-id">Guide ID:</label>
                                            <input type="text" id="edit-guide-id" placeholder="Guide ID">
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-guide-name">Guide Name:</label>
                                            <input type="text" id="edit-guide-name" placeholder="Guide Name">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="edit-section">
                                    <h4>Special Requests & Notes</h4>
                                    <div class="form-group">
                                        <label for="edit-notes">Notes & Special Requests:</label>
                                        <textarea id="edit-notes" rows="5" placeholder="Enter any special requests or notes"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <div class="action-buttons">
                            <button type="button" class="btn-cancel" onclick="closeEditBookingModal()">Cancel</button>
                            <button type="submit" class="btn-save">Save Changes</button>
                        </div>
                        <div id="edit-booking-status"></div>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    // Add to document
    document.body.appendChild(modal);
    
    // Add styles
    const style = document.createElement('style');
    style.id = 'edit-booking-modal-styles';
    style.textContent = `
        .edit-booking-modal .form-tabs {
            margin-bottom: 20px;
        }
        
        .edit-booking-modal .tab-controls {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .edit-booking-modal .tab-control {
            padding: 10px 15px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #555;
            margin-right: 5px;
        }
        
        .edit-booking-modal .tab-control.active {
            border-bottom-color: #e67e22;
            color: #e67e22;
        }
        
        .edit-booking-modal .tab-pane {
            display: none;
        }
        
        .edit-booking-modal .tab-pane.active {
            display: block;
        }
        
        .edit-booking-modal .edit-section {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .edit-booking-modal .edit-section h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }
        
        .edit-booking-modal .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .edit-booking-modal .form-group {
            flex: 1;
            margin-bottom: 15px;
        }
        
        .edit-booking-modal label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }
        
        .edit-booking-modal input,
        .edit-booking-modal select,
        .edit-booking-modal textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .edit-booking-modal textarea {
            resize: vertical;
        }
        
        .edit-booking-modal input:focus,
        .edit-booking-modal select:focus,
        .edit-booking-modal textarea:focus {
            border-color: #e67e22;
            outline: none;
            box-shadow: 0 0 0 2px rgba(230, 126, 34, 0.2);
        }
        
        .edit-booking-modal input[readonly] {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }
        
        .edit-booking-modal .form-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .edit-booking-modal .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .edit-booking-modal .btn-cancel {
            padding: 10px 20px;
            background-color: #f5f5f5;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            color: #555;
        }
        
        .edit-booking-modal .btn-save {
            padding: 10px 20px;
            background-color: #e67e22;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .edit-booking-modal #edit-booking-status {
            font-size: 14px;
        }
        
        .edit-booking-modal .status-success {
            color: #2ecc71;
        }
        
        .edit-booking-modal .status-error {
            color: #e74c3c;
        }
        
        @media (max-width: 768px) {
            .edit-booking-modal .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .edit-booking-modal .tab-controls {
                flex-wrap: wrap;
            }
        }
    `;
    
    document.head.appendChild(style);
    
    // Set up event listeners
    setupEditBookingEventListeners();
}

// Function to set up event listeners for the edit booking modal
function setupEditBookingEventListeners() {
    // Tab switching
    document.querySelectorAll('.tab-control').forEach(tab => {
        tab.addEventListener('click', function() {
            // Remove active class from all tabs
            document.querySelectorAll('.tab-control').forEach(t => {
                t.classList.remove('active');
            });
            
            // Add active class to clicked tab
            this.classList.add('active');
            
            // Hide all tab panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            
            // Show the selected tab pane
            const tabId = this.getAttribute('data-tab') + '-tab';
            document.getElementById(tabId).classList.add('active');
        });
    });
    
    // Form submission
    const form = document.getElementById('edit-booking-form');
    if (form) {
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            saveBookingChanges();
        });
    }
    
    // Automatic duration calculation
    const arrivalDateInput = document.getElementById('edit-arrival-date');
    const departureDateInput = document.getElementById('edit-departure-date');
    const durationInput = document.getElementById('edit-duration');
    
    if (arrivalDateInput && departureDateInput && durationInput) {
        const updateDuration = function() {
            const arrivalDate = new Date(arrivalDateInput.value);
            const departureDate = new Date(departureDateInput.value);
            
            if (!isNaN(arrivalDate.getTime()) && !isNaN(departureDate.getTime())) {
                // Calculate the difference in days
                const diffTime = Math.abs(departureDate - arrivalDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                // Update the duration field
                durationInput.value = diffDays;
            }
        };
        
        arrivalDateInput.addEventListener('change', updateDuration);
        departureDateInput.addEventListener('change', updateDuration);
    }
}

// Function to populate the edit form with booking data
function populateEditBookingForm(booking) {
    // Set booking ID
    document.getElementById('edit-booking-id').value = booking.id;
    
    // Booking Info Tab
    const statusSelect = document.getElementById('edit-status');
    if (statusSelect) {
        const status = booking.bookingStatus || booking.status || 'Pending';
        statusSelect.value = status;
    }
    
    // Client information
    let clientName = '';
    let clientEmail = '';
    let clientPhone = '';
    
    // Try to get client info from cache
    if (window.clientCache && window.clientCache[booking.id]) {
        const clientInfo = window.clientCache[booking.id];
        clientName = clientInfo.name || '';
        clientEmail = clientInfo.email || '';
        clientPhone = clientInfo.phone || '';
    } else {
        // Fallback to booking data
        clientName = booking.clientName || '';
        clientEmail = booking.clientEmail || '';
        clientPhone = booking.clientPhone || '';
    }
    
    document.getElementById('edit-client-name').value = clientName;
    document.getElementById('edit-client-email').value = clientEmail;
    document.getElementById('edit-client-phone').value = clientPhone;
    document.getElementById('edit-client-id').value = booking.id;
    
    // Trip Details Tab
    // Handle arrival date
    if (booking.arrivalDate) {
        const arrivalDateInput = document.getElementById('edit-arrival-date');
        if (arrivalDateInput) {
            let arrivalDate;
            if (booking.arrivalDate.seconds) {
                arrivalDate = new Date(booking.arrivalDate.seconds * 1000);
            } else {
                try {
                    arrivalDate = new Date(booking.arrivalDate);
                } catch (e) {
                    console.warn('Invalid arrival date format:', booking.arrivalDate);
                    arrivalDate = null;
                }
            }
            
            if (arrivalDate) {
                arrivalDateInput.value = formatDateForInput(arrivalDate);
            }
        }
    }
    
    // Handle nested arrival date structure
    if (booking.dates && booking.dates.arrival) {
        if (booking.dates.arrival.date) {
            const arrivalDateInput = document.getElementById('edit-arrival-date');
            if (arrivalDateInput) {
                let arrivalDate;
                if (booking.dates.arrival.date.seconds) {
                    arrivalDate = new Date(booking.dates.arrival.date.seconds * 1000);
                } else {
                    try {
                        arrivalDate = new Date(booking.dates.arrival.date);
                    } catch (e) {
                        console.warn('Invalid nested arrival date format:', booking.dates.arrival.date);
                        arrivalDate = null;
                    }
                }
                
                if (arrivalDate) {
                    arrivalDateInput.value = formatDateForInput(arrivalDate);
                }
            }
        }
        
        if (booking.dates.arrival.time) {
            const arrivalTimeInput = document.getElementById('edit-arrival-time');
            if (arrivalTimeInput) {
                arrivalTimeInput.value = booking.dates.arrival.time;
            }
        }
    }
    
    // Handle departure date
    if (booking.departureDate) {
        const departureDateInput = document.getElementById('edit-departure-date');
        if (departureDateInput) {
            let departureDate;
            if (booking.departureDate.seconds) {
                departureDate = new Date(booking.departureDate.seconds * 1000);
            } else {
                try {
                    departureDate = new Date(booking.departureDate);
                } catch (e) {
                    console.warn('Invalid departure date format:', booking.departureDate);
                    departureDate = null;
                }
            }
            
            if (departureDate) {
                departureDateInput.value = formatDateForInput(departureDate);
            }
        }
    }
    
    // Handle nested departure date structure
    if (booking.dates && booking.dates.departure) {
        if (booking.dates.departure.date) {
            const departureDateInput = document.getElementById('edit-departure-date');
            if (departureDateInput) {
                let departureDate;
                if (booking.dates.departure.date.seconds) {
                    departureDate = new Date(booking.dates.departure.date.seconds * 1000);
                } else {
                    try {
                        departureDate = new Date(booking.dates.departure.date);
                    } catch (e) {
                        console.warn('Invalid nested departure date format:', booking.dates.departure.date);
                        departureDate = null;
                    }
                }
                
                if (departureDate) {
                    departureDateInput.value = formatDateForInput(departureDate);
                }
            }
        }
        
        if (booking.dates.departure.time) {
            const departureTimeInput = document.getElementById('edit-departure-time');
            if (departureTimeInput) {
                departureTimeInput.value = booking.dates.departure.time;
            }
        }
    }
    
    // Set duration and participants
    if (booking.duration) {
        document.getElementById('edit-duration').value = booking.duration;
    }
    
    if (booking.participants) {
        document.getElementById('edit-participants').value = booking.participants;
    }
    
    // Package Info Tab
    // Set package name
    const packageNameInput = document.getElementById('edit-package-name');
    if (packageNameInput) {
        packageNameInput.value = booking.packageName || booking.packageType || '';
    }
    
    // Set package type
    const packageTypeSelect = document.getElementById('edit-package-type');
    if (packageTypeSelect) {
        packageTypeSelect.value = booking.packageType || 'Standard';
    }
    
    // Set adults and children
    if (booking.adults !== undefined) {
        document.getElementById('edit-adults').value = booking.adults;
    }
    
    if (booking.children !== undefined) {
        document.getElementById('edit-children').value = booking.children;
    }
    
    // Set cost
    const costInput = document.getElementById('edit-cost');
    if (costInput) {
        if (booking.cost !== undefined) {
            costInput.value = booking.cost;
        } else if (booking.totalAmount !== undefined) {
            costInput.value = booking.totalAmount;
        }
    }
    
    // Guide & Notes Tab
    // Set guide info
    if (booking.guideId) {
        document.getElementById('edit-guide-id').value = booking.guideId;
    }
    
    if (booking.guideName) {
        document.getElementById('edit-guide-name').value = booking.guideName;
    }
    
    // Set notes
    const notesTextarea = document.getElementById('edit-notes');
    if (notesTextarea) {
        if (booking.notes) {
            notesTextarea.value = booking.notes;
        } else if (booking.specialRequests) {
            notesTextarea.value = booking.specialRequests;
        }
    }
}

// Function to save booking changes
function saveBookingChanges() {
    const bookingId = document.getElementById('edit-booking-id').value;
    if (!bookingId) {
        showEditStatus('Booking ID not found', 'error');
        return;
    }
    
    // Disable save button and show loading
    const saveButton = document.querySelector('.edit-booking-modal .btn-save');
    if (saveButton) {
        saveButton.disabled = true;
        saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    }
    
    // Collect form data
    const updateData = {
        // Booking info
        bookingStatus: document.getElementById('edit-status').value,
        status: document.getElementById('edit-status').value, // Duplicate for compatibility
        
        // Client info - update in users collection separately
        clientName: document.getElementById('edit-client-name').value,
        clientEmail: document.getElementById('edit-client-email').value,
        clientPhone: document.getElementById('edit-client-phone').value,
        
        // Package details
        packageName: document.getElementById('edit-package-name').value,
        packageType: document.getElementById('edit-package-type').value,
        adults: parseInt(document.getElementById('edit-adults').value) || 0,
        children: parseInt(document.getElementById('edit-children').value) || 0,
        cost: parseFloat(document.getElementById('edit-cost').value) || 0,
        totalAmount: parseFloat(document.getElementById('edit-cost').value) || 0, // Duplicate for compatibility
        
        // Trip details
        duration: parseInt(document.getElementById('edit-duration').value) || 0,
        participants: parseInt(document.getElementById('edit-participants').value) || 0,
        
        // Guide info
        guideId: document.getElementById('edit-guide-id').value,
        guideName: document.getElementById('edit-guide-name').value,
        
        // Notes
        notes: document.getElementById('edit-notes').value,
        specialRequests: document.getElementById('edit-notes').value, // Duplicate for compatibility
        
        // Update metadata
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: 'admin'
    };
    
    // Prepare date objects
    const arrivalDate = document.getElementById('edit-arrival-date').value;
    const arrivalTime = document.getElementById('edit-arrival-time').value;
    const departureDate = document.getElementById('edit-departure-date').value;
    const departureTime = document.getElementById('edit-departure-time').value;
    
    // Add dates in both formats for compatibility
    if (arrivalDate) {
        // Simple format
        updateData.arrivalDate = new Date(arrivalDate);
        
        // Nested format
        updateData.dates = updateData.dates || {};
        updateData.dates.arrival = {
            date: new Date(arrivalDate),
            time: arrivalTime
        };
    }
    
    if (departureDate) {
        // Simple format
        updateData.departureDate = new Date(departureDate);
        
        // Nested format
        updateData.dates = updateData.dates || {};
        updateData.dates.departure = {
            date: new Date(departureDate),
            time: departureTime
        };
    }
    
    try {
        // Get Firestore reference
        const db = firebase.firestore();
        
        // Update booking in Firestore
        db.collection("bookings").doc(bookingId).update(updateData)
            .then(() => {
                // Update client info in users collection if client data changed
                updateClientInfoIfNeeded(bookingId, updateData);
                
                // Show success message
                showEditStatus('Booking updated successfully!', 'success');
                
                // Update local data
                updateLocalBookingData(bookingId, updateData);
                
                // Re-enable save button
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.innerHTML = 'Save Changes';
                }
                
                // Close modal after a short delay
                setTimeout(() => {
                    closeEditBookingModal();
                }, 1500);
            })
            .catch((error) => {
                console.error("Error updating booking:", error);
                showEditStatus(`Error updating booking: ${error.message}`, 'error');
                
                // Re-enable save button
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.innerHTML = 'Save Changes';
                }
            });
    } catch (error) {
        console.error("Error in saveBookingChanges:", error);
        showEditStatus(`Error: ${error.message}`, 'error');
        
        // Re-enable save button
        if (saveButton) {
            saveButton.disabled = false;
            saveButton.innerHTML = 'Save Changes';
        }
    }
}

// Function to update client info in users collection if needed
function updateClientInfoIfNeeded(clientId, bookingData) {
    // Check if we need to update client info
    if (!window.clientCache[clientId]) return;
    
    const clientName = bookingData.clientName;
    const clientEmail = bookingData.clientEmail;
    
    const cachedName = window.clientCache[clientId].name;
    const cachedEmail = window.clientCache[clientId].email;
    
    // Skip if no changes
    if (clientName === cachedName && clientEmail === cachedEmail) return;
    
    try {
        // Get Firestore reference
        const db = firebase.firestore();
        
        // Only update fields that have changed
        const updateData = {};
        if (clientName !== cachedName) updateData.name = clientName;
        if (clientEmail !== cachedEmail) updateData.email = clientEmail;
        
        // Update user in users collection
        db.collection("users").doc(clientId).update(updateData)
            .then(() => {
                console.log(`Updated client info for ${clientId}`);
                
                // Update cache
                window.clientCache[clientId] = {
                    ...window.clientCache[clientId],
                    name: clientName,
                    email: clientEmail
                };
            })
            .catch((error) => {
                console.error(`Error updating client info for ${clientId}:`, error);
            });
    } catch (error) {
        console.error(`Error in updateClientInfoIfNeeded for ${clientId}:`, error);
    }
}

// Function to update local booking data after successful save
function updateLocalBookingData(bookingId, updateData) {
    // Find booking in bookingsData array
    const bookingIndex = window.bookingsData.findIndex(b => b.id === bookingId);
    if (bookingIndex !== -1) {
        // Update booking data
        window.bookingsData[bookingIndex] = {
            ...window.bookingsData[bookingIndex],
            ...updateData
        };
        
        // Refresh display
        filterAndDisplayBookings();
    }
}

// Function to show status message in edit form
function showEditStatus(message, type) {
    const statusDiv = document.getElementById('edit-booking-status');
    if (statusDiv) {
        statusDiv.className = `status-${type}`;
        statusDiv.textContent = message;
    }
}

// Function to close the edit booking modal
window.closeEditBookingModal = function() {
    const modal = document.getElementById('edit-booking-modal');
    if (modal) {
        modal.style.display = 'none';
    }
};

// Helper function to format date for input fields
function formatDateForInput(date) {
    if (!date) return '';
    
    try {
        return date.toISOString().split('T')[0];
    } catch (e) {
        console.warn('Error formatting date for input:', e);
        return '';
    }
}
// Tour Reports Implementation

// Function to enhance the tour reports section
function enhanceTourReportsSection() {
  console.log("Enhancing tour reports section...");
  
  const reportsSection = document.getElementById('reports-section');
  if (!reportsSection) {
    console.error("Reports section not found!");
    return;
  }
  
  // Replace with proper UI
  reportsSection.innerHTML = `
    <div class="section-header">
      <h2>Tour Reports</h2>
      <p class="section-description">View and manage tour reports submitted by guides</p>
    </div>
    
    <div class="card">
      <div class="card-header">
        <h3>Safari Tour Reports</h3>
        <div class="header-actions">
          <div class="search-box">
            <input type="text" id="reportSearchInput" placeholder="Search reports...">
            <i class="fas fa-search"></i>
          </div>
          <select id="reportDateFilter">
            <option value="all">All Dates</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
          </select>
        </div>
      </div>
      <div class="card-body">
        <div class="reports-list" id="tourReportsList">
          <div class="loading-container">
            <div class="spinner"></div>
            <p>Loading reports...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Report Detail Modal -->
    <div class="modal" id="reportDetailModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Tour Report Details</h3>
          <button class="modal-close" id="closeReportDetailModal">&times;</button>
        </div>
        <div class="modal-body" id="reportDetailContent">
          <!-- Report details will be populated here -->
        </div>
      </div>
    </div>
  `;
  
  // Add styles
  addStyles(`
    .reports-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .report-card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .report-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }
    
    .report-header {
      padding: 15px;
      background-color: #f8f9fa;
      border-bottom: 1px solid #eee;
    }
    
    .report-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 5px;
      color: #333;
    }
    
    .report-tour-name {
      font-size: 0.9rem;
      color: #666;
    }
    
    .report-body {
      padding: 15px;
    }
    
    .report-metadata {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    
    .report-guide {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .guide-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: #e67e22;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .report-guide-name {
      font-size: 0.9rem;
    }
    
    .report-date {
      font-size: 0.85rem;
      color: #666;
    }
    
    .report-summary {
      font-size: 0.9rem;
      color: #444;
      margin-bottom: 15px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .report-highlights {
      margin-bottom: 15px;
    }
    
    .highlight-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      color: #666;
      margin-bottom: 5px;
    }
    
    .highlight-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    
    .highlight-tag {
      background-color: #e6f7ef;
      color: #2ecc71;
      padding: 3px 8px;
      border-radius: 15px;
      font-size: 0.8rem;
    }
    
    .wildlife-tag {
      background-color: #e8f4fd;
      color: #3498db;
    }
    
    .challenge-tag {
      background-color: #fff5eb;
      color: #e67e22;
    }
    
    .report-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .report-btn {
      padding: 8px 15px;
      border-radius: 5px;
      border: none;
      background-color: #f5f5f5;
      color: #555;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: background-color 0.2s;
    }
    
    .report-btn:hover {
      background-color: #e5e5e5;
    }
    
    .report-btn.view {
      background-color: #e8f4fd;
      color: #3498db;
    }
    
    .report-btn.view:hover {
      background-color: #d6eafb;
    }
    
    .report-detail-section {
      margin-bottom: 20px;
    }
    
    .report-detail-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 10px;
      text-transform: uppercase;
      color: #666;
    }
    
    .report-detail-content {
      background-color: #f9f9f9;
      padding: 15px;
      border-radius: 5px;
      font-size: 0.95rem;
      color: #333;
    }
    
    .report-detail-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
  `);
  
  // Set up event listeners
  const reportSearchInput = document.getElementById('reportSearchInput');
  if (reportSearchInput) {
    reportSearchInput.addEventListener('input', filterReports);
  }
  
  const reportDateFilter = document.getElementById('reportDateFilter');
  if (reportDateFilter) {
    reportDateFilter.addEventListener('change', loadReports);
  }
  
  const closeReportDetailModal = document.getElementById('closeReportDetailModal');
  if (closeReportDetailModal) {
    closeReportDetailModal.addEventListener('click', closeModals);
  }
  
  // Load reports
  loadReports();
}

// Load reports from Firestore
async function loadReports() {
  console.log("Loading tour reports...");
  
  const reportsList = document.getElementById('tourReportsList');
  if (!reportsList) return;
  
  // Show loading
  reportsList.innerHTML = `
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Loading reports...</p>
    </div>
  `;
  
  try {
    // Get date filter if available
    const dateFilter = document.getElementById('reportDateFilter')?.value || 'all';
    
    // Fetch all reports
    const reportsRef = collection(db, "reports");
    const reportsSnapshot = await getDocs(reportsRef);
    
    console.log(`Found ${reportsSnapshot.size} total reports`);
    
    if (reportsSnapshot.empty) {
      reportsList.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-file-alt"></i>
          <p>No tour reports found</p>
        </div>
      `;
      return;
    }
    
    // Filter by date if needed
    let filteredReports = reportsSnapshot.docs;
    
    if (dateFilter !== 'all') {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
      const weekAgo = today - (7 * 24 * 60 * 60 * 1000);
      const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate()).getTime();
      
      filteredReports = filteredReports.filter(doc => {
        const data = doc.data();
        const reportDate = data.date?.seconds ? data.date.seconds * 1000 : 
                          data.createdAt?.seconds ? data.createdAt.seconds * 1000 : 0;
        
        if (dateFilter === 'today') {
          return reportDate >= today;
        } else if (dateFilter === 'week') {
          return reportDate >= weekAgo;
        } else if (dateFilter === 'month') {
          return reportDate >= monthAgo;
        }
        
        return true;
      });
    }
    
    if (filteredReports.length === 0) {
      reportsList.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-filter"></i>
          <p>No reports match the selected date filter</p>
        </div>
      `;
      return;
    }
    
    // Build HTML
    let html = '';
    
    for (const doc of filteredReports) {
      const report = doc.data();
      report.id = doc.id;
      
      // Format date
      let formattedDate = 'No date';
      if (report.date && report.date.seconds) {
        formattedDate = new Date(report.date.seconds * 1000).toLocaleDateString();
      } else if (report.createdAt && report.createdAt.seconds) {
        formattedDate = new Date(report.createdAt.seconds * 1000).toLocaleDateString();
      }
      
      // Get guide initials
      const guideName = report.guideName || 'Unknown Guide';
      const guideInitials = guideName.split(' ').map(n => n[0]).join('').toUpperCase();
      
      // Process highlights, wildlife, and challenges
      const highlights = typeof report.highlights === 'string' ? report.highlights.split(',') : 
                        Array.isArray(report.highlights) ? report.highlights : [];
      
      const wildlife = typeof report.wildlifeSightings === 'string' ? report.wildlifeSightings.split(',') : 
                      Array.isArray(report.wildlifeSightings) ? report.wildlifeSightings : [];
      
      const challenges = typeof report.challenges === 'string' ? report.challenges.split(',') : 
                        Array.isArray(report.challenges) ? report.challenges : [];
      
      // Create report card
      html += `
        <div class="report-card" data-id="${report.id}">
          <div class="report-header">
            <div class="report-title">${report.title || 'Untitled Report'}</div>
            <div class="report-tour-name">${report.tourName || 'Unnamed Tour'}</div>
          </div>
          <div class="report-body">
            <div class="report-metadata">
              <div class="report-guide">
                <div class="guide-avatar">${guideInitials}</div>
                <div class="report-guide-name">${guideName}</div>
              </div>
              <div class="report-date">${formattedDate}</div>
            </div>
            
            <div class="report-summary">${report.summary || 'No summary provided.'}</div>
            
            <div class="report-highlights">
              <div class="highlight-label">Highlights</div>
              <div class="highlight-tags">
                ${highlights.slice(0, 3).map(tag => 
                  `<span class="highlight-tag">${tag.trim()}</span>`
                ).join('')}
                ${highlights.length > 3 ? `<span class="highlight-tag">+${highlights.length - 3} more</span>` : ''}
              </div>
            </div>
            
            <div class="report-actions">
              <button class="report-btn view" onclick="window.viewReportDetail('${report.id}')">
                <i class="fas fa-eye"></i> View Details
              </button>
            </div>
          </div>
        </div>
      `;
    }
    
    reportsList.innerHTML = html;
    
  } catch (error) {
    console.error('Error loading reports:', error);
    reportsList.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-exclamation-triangle"></i>
        <p>Error loading reports: ${error.message}</p>
      </div>
    `;
  }
}

// Filter reports based on search input
function filterReports() {
  const searchInput = document.getElementById('reportSearchInput');
  const reportCards = document.querySelectorAll('.report-card');
  
  if (!searchInput || !reportCards.length) return;
  
  const searchText = searchInput.value.toLowerCase().trim();
  
  reportCards.forEach(card => {
    const title = card.querySelector('.report-title')?.textContent.toLowerCase() || '';
    const tourName = card.querySelector('.report-tour-name')?.textContent.toLowerCase() || '';
    const guideName = card.querySelector('.report-guide-name')?.textContent.toLowerCase() || '';
    const summary = card.querySelector('.report-summary')?.textContent.toLowerCase() || '';
    
    if (title.includes(searchText) || 
        tourName.includes(searchText) || 
        guideName.includes(searchText) || 
        summary.includes(searchText)) {
      card.style.display = '';
    } else {
      card.style.display = 'none';
    }
  });
}

// View report details
async function viewReportDetail(reportId) {
  console.log(`Viewing report details for ${reportId}`);
  
  const modal = document.getElementById('reportDetailModal');
  const contentDiv = document.getElementById('reportDetailContent');
  
  if (!modal || !contentDiv) return;
  
  // Show loading
  contentDiv.innerHTML = `
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Loading report details...</p>
    </div>
  `;
  
  modal.classList.add('active');
  
  try {
    // Fetch report from Firestore
    const reportRef = doc(db, "reports", reportId);
    const reportDoc = await getDoc(reportRef);
    
    if (!reportDoc.exists()) {
      contentDiv.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-circle"></i>
          <p>Report not found</p>
        </div>
      `;
      return;
    }
    
    const report = reportDoc.data();
    
    // Format date
    let formattedDate = 'No date';
    if (report.date && report.date.seconds) {
      formattedDate = new Date(report.date.seconds * 1000).toLocaleDateString();
    } else if (report.createdAt && report.createdAt.seconds) {
      formattedDate = new Date(report.createdAt.seconds * 1000).toLocaleDateString();
    }
    
    // Process highlights, wildlife, and challenges
    const highlights = typeof report.highlights === 'string' ? report.highlights.split(',') : 
                      Array.isArray(report.highlights) ? report.highlights : [];
    
    const wildlife = typeof report.wildlifeSightings === 'string' ? report.wildlifeSightings.split(',') : 
                    Array.isArray(report.wildlifeSightings) ? report.wildlifeSightings : [];
    
    const challenges = typeof report.challenges === 'string' ? report.challenges.split(',') : 
                      Array.isArray(report.challenges) ? report.challenges : [];
    
    // Build HTML
    let html = `
      <div class="report-detail-header">
        <h3>${report.title || 'Untitled Report'}</h3>
        <p>${report.tourName || 'Unnamed Tour'} - ${formattedDate}</p>
        <div class="report-guide-info">
          <p><strong>Guide:</strong> ${report.guideName || 'Unknown Guide'}</p>
        </div>
      </div>
      
      <div class="report-detail-section">
        <div class="report-detail-title">Summary</div>
        <div class="report-detail-content">${report.summary || 'No summary provided.'}</div>
      </div>
      
      <div class="report-detail-section">
        <div class="report-detail-title">Highlights</div>
        <div class="report-detail-tags">
          ${highlights.length > 0 ? 
            highlights.map(tag => `<span class="highlight-tag">${tag.trim()}</span>`).join('') : 
            '<p>No highlights recorded</p>'}
        </div>
      </div>
      
      <div class="report-detail-section">
        <div class="report-detail-title">Wildlife Sightings</div>
        <div class="report-detail-tags">
          ${wildlife.length > 0 ? 
            wildlife.map(animal => `<span class="highlight-tag wildlife-tag">${animal.trim()}</span>`).join('') : 
            '<p>No wildlife sightings recorded</p>'}
        </div>
      </div>
      
      <div class="report-detail-section">
        <div class="report-detail-title">Challenges Encountered</div>
        <div class="report-detail-tags">
          ${challenges.length > 0 ? 
            challenges.map(challenge => `<span class="highlight-tag challenge-tag">${challenge.trim()}</span>`).join('') : 
            '<p>No challenges recorded</p>'}
        </div>
      </div>
      
      <div class="report-detail-section">
        <div class="report-detail-title">Recommendations</div>
        <div class="report-detail-content">${report.recommendations || 'No recommendations provided.'}</div>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn-primary" onclick="window.closeModals()">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    `;
    
    contentDiv.innerHTML = html;
    
  } catch (error) {
    console.error('Error loading report details:', error);
    contentDiv.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-exclamation-triangle"></i>
        <p>Error loading report details: ${error.message}</p>
      </div>
    `;
  }
}

// Make functions available globally
window.viewReportDetail = viewReportDetail;
window.closeModals = closeModals;

// Initialize when the page loads
document.addEventListener('DOMContentLoaded', function() {
  // Check if we're on the reports section or should initialize for all sections
  enhanceTourReportsSection();
  
  // Add click handler for the reports nav item
  const reportsNavItem = document.querySelector('.nav-item[data-section="reports"]');
  if (reportsNavItem) {
    reportsNavItem.addEventListener('click', function() {
      // Reload reports when navigating to the section
      setTimeout(loadReports, 100);
    });
  }
});
// Tours Management Implementation

// Function to enhance the tours section
function enhanceToursSection() {
  console.log("Enhancing tours section...");
  
  const toursSection = document.getElementById('tours-section');
  if (!toursSection) {
    console.error("Tours section not found!");
    return;
  }
  
  // Replace with proper UI
  toursSection.innerHTML = `
    <div class="section-header">
      <h2>Tours</h2>
      <p class="section-description">Manage all active and upcoming safari tours</p>
    </div>
    
    <div class="tour-actions">
      <button class="btn-primary" id="addTourBtn">
        <i class="fas fa-plus"></i> Add New Tour
      </button>
      
      <div class="filter-controls">
        <div class="search-box">
          <input type="text" id="tourSearchInput" placeholder="Search tours...">
          <i class="fas fa-search"></i>
        </div>
        
        <select id="tourStatusFilter">
          <option value="all">All Statuses</option>
          <option value="Confirmed" selected>Confirmed</option>
          <option value="In Progress">In Progress</option>
          <option value="Completed">Completed</option>
          <option value="Cancelled">Cancelled</option>
        </select>
      </div>
    </div>
    
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="data-table" id="toursTable">
            <thead>
              <tr>
                <th>Tour ID</th>
                <th>Tour Name</th>
                <th>Client</th>
                <th>Guide</th>
                <th>Package</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="toursList">
              <tr>
                <td colspan="8" class="loading-row">
                  <div class="spinner"></div>
                  <span>Loading tours...</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Tour Edit Modal -->
    <div class="modal" id="tourEditModal">
      <div class="modal-content modal-lg">
        <div class="modal-header">
          <h3 id="tourModalTitle">Edit Tour</h3>
          <button class="modal-close" id="closeTourEditModal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="tourEditForm">
            <input type="hidden" id="tourId">
            
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="tourName">Tour Name/Title</label>
                <input type="text" id="tourName" class="form-control" placeholder="Enter a title for this tour">
              </div>
              
              <div class="form-group col-md-6">
                <label for="tourStatus">Status</label>
                <select id="tourStatus" class="form-control">
                  <option value="Confirmed">Confirmed</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Completed">Completed</option>
                  <option value="Cancelled">Cancelled</option>
                </select>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="tourClientName">Client Name</label>
                <input type="text" id="tourClientName" class="form-control">
              </div>
              
              <div class="form-group col-md-6">
                <label for="tourClientId">Client ID</label>
                <input type="text" id="tourClientId" class="form-control" readonly>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="tourGuideName">Guide Name</label>
                <input type="text" id="tourGuideName" class="form-control">
              </div>
              
              <div class="form-group col-md-6">
                <label for="tourGuideId">Guide ID</label>
                <input type="text" id="tourGuideId" class="form-control" readonly>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="tourPackageType">Package Type</label>
                <select id="tourPackageType" class="form-control">
                  <option value="Standard Package">Standard Package</option>
                  <option value="Premium Package">Premium Package</option>
                  <option value="Family Package">Family Package</option>
                  <option value="Saver Package">Saver Package</option>
                  <option value="Luxury Package">Luxury Package</option>
                </select>
              </div>
              
              <div class="form-group col-md-6">
                <label for="tourBookingId">Booking ID</label>
                <input type="text" id="tourBookingId" class="form-control" readonly>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="tourNotes">Tour Notes</label>
                <textarea id="tourNotes" class="form-control" rows="3" placeholder="Add any notes about this tour"></textarea>
              </div>
              
              <div class="form-group col-md-6">
                <label for="tourDates">Tour Dates</label>
                <div class="date-range-wrapper">
                  <input type="date" id="tourStartDate" class="form-control">
                  <span>to</span>
                  <input type="date" id="tourEndDate" class="form-control">
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label>Additional Information</label>
              <div class="tour-metadata">
                <p><strong>Created:</strong> <span id="tourCreatedAt">-</span></p>
                <p><strong>Last Updated:</strong> <span id="tourUpdatedAt">-</span></p>
              </div>
            </div>
            
            <div class="form-actions">
              <button type="button" class="btn-cancel" id="cancelTourEdit">Cancel</button>
              <button type="submit" class="btn-primary" id="saveTourBtn">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <!-- Tour Detail Modal -->
    <div class="modal" id="tourDetailModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="tourDetailTitle">Tour Details</h3>
          <button class="modal-close" id="closeTourDetailModal">&times;</button>
        </div>
        <div class="modal-body" id="tourDetailContent">
          <!-- Tour details will be populated here -->
        </div>
      </div>
    </div>
  `;
  
  // Add styles
  addStyles(`
    .tour-actions {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    
    .filter-controls {
      display: flex;
      gap: 15px;
    }
    
    .modal-lg {
      max-width: 800px;
      width: 90%;
    }
    
    .form-row {
      display: flex;
      flex-wrap: wrap;
      margin-right: -10px;
      margin-left: -10px;
      margin-bottom: 15px;
    }
    
    .form-group {
      margin-bottom: 15px;
      padding-right: 10px;
      padding-left: 10px;
    }
    
    .col-md-6 {
      flex: 0 0 50%;
      max-width: 50%;
    }
    
    .form-control {
      display: block;
      width: 100%;
      padding: 8px 12px;
      font-size: 14px;
      line-height: 1.5;
      color: #495057;
      background-color: #fff;
      border: 1px solid #ced4da;
      border-radius: 4px;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .form-control:focus {
      border-color: #80bdff;
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .date-range-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .date-range-wrapper span {
      color: #666;
    }
    
    .tour-metadata {
      background-color: #f8f9fa;
      padding: 10px 15px;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    .tour-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .status-confirmed {
      background-color: #e6f7ef;
      color: #2ecc71;
    }
    
    .status-inprogress {
      background-color: #e8f4fd;
      color: #3498db;
    }
    
    .status-completed {
      background-color: #eee;
      color: #555;
    }
    
    .status-cancelled {
      background-color: #fde7e6;
      color: #e74c3c;
    }
    
    .tour-client, .tour-guide {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .client-avatar, .guide-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.8rem;
    }
    
    .client-avatar {
      background-color: #3498db;
    }
    
    .guide-avatar {
      background-color: #e67e22;
    }
  `);
  
  // Set up event listeners
  const tourSearchInput = document.getElementById('tourSearchInput');
  if (tourSearchInput) {
    tourSearchInput.addEventListener('input', filterTours);
  }
  
  const tourStatusFilter = document.getElementById('tourStatusFilter');
  if (tourStatusFilter) {
    tourStatusFilter.addEventListener('change', loadTours);
  }
  
  const addTourBtn = document.getElementById('addTourBtn');
  if (addTourBtn) {
    addTourBtn.addEventListener('click', openAddTourModal);
  }
  
  const closeTourEditModal = document.getElementById('closeTourEditModal');
  if (closeTourEditModal) {
    closeTourEditModal.addEventListener('click', closeModals);
  }
  
  const cancelTourEdit = document.getElementById('cancelTourEdit');
  if (cancelTourEdit) {
    cancelTourEdit.addEventListener('click', closeModals);
  }
  
  const tourEditForm = document.getElementById('tourEditForm');
  if (tourEditForm) {
    tourEditForm.addEventListener('submit', saveTourChanges);
  }
  
  const closeTourDetailModal = document.getElementById('closeTourDetailModal');
  if (closeTourDetailModal) {
    closeTourDetailModal.addEventListener('click', closeModals);
  }
  
  // Load tours
  loadTours();
}

// Load tours from Firestore
async function loadTours() {
  console.log("Loading tours...");
  
  const toursList = document.getElementById('toursList');
  if (!toursList) return;
  
  // Show loading
  toursList.innerHTML = `
    <tr>
      <td colspan="8" class="loading-row">
        <div class="spinner"></div>
        <span>Loading tours...</span>
      </td>
    </tr>
  `;
  
  try {
    // Get status filter if available
    const statusFilter = document.getElementById('tourStatusFilter')?.value || 'all';
    
    // Fetch all tours
    const toursRef = collection(db, "tours");
    let toursQuery = toursRef;
    
    // Apply status filter if selected
    if (statusFilter !== 'all') {
      toursQuery = query(toursRef, where("status", "==", statusFilter));
    }
    
    const toursSnapshot = await getDocs(toursQuery);
    
    console.log(`Found ${toursSnapshot.size} tours with filter: ${statusFilter}`);
    
    if (toursSnapshot.empty) {
      toursList.innerHTML = `
        <tr>
          <td colspan="8" class="text-center">
            <div class="empty-state">
              <i class="fas fa-map-marked-alt"></i>
              <p>No tours found</p>
            </div>
          </td>
        </tr>
      `;
      return;
    }
    
    // Sort tours by creation date (newest first)
    const tours = toursSnapshot.docs.map(doc => {
      return { id: doc.id, ...doc.data() };
    }).sort((a, b) => {
      const timeA = a.createdAt?.seconds || 0;
      const timeB = b.createdAt?.seconds || 0;
      return timeB - timeA;
    });
    
    // Build HTML
    let html = '';
    
    for (const tour of tours) {
      // Format dates
      const createdDate = tour.createdAt?.seconds ? 
        new Date(tour.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
      
      // Get status class
      const statusClass = getStatusClass(tour.status);
      
      // Get initials for client and guide
      const clientInitials = getInitials(tour.clientName || 'Client');
      const guideInitials = getInitials(tour.guideName || 'Guide');
      
      html += `
        <tr data-id="${tour.id}">
          <td>${tour.id.substring(0, 8)}...</td>
          <td>${tour.tourName || 'Unnamed Tour'}</td>
          <td>
            <div class="tour-client">
              <div class="client-avatar">${clientInitials}</div>
              <span>${tour.clientName || 'Unknown Client'}</span>
            </div>
          </td>
          <td>
            <div class="tour-guide">
              <div class="guide-avatar">${guideInitials}</div>
              <span>${tour.guideName || 'Unknown Guide'}</span>
            </div>
          </td>
          <td>${tour.packageType || 'Standard Package'}</td>
          <td><span class="tour-status ${statusClass}">${tour.status || 'Confirmed'}</span></td>
          <td>${createdDate}</td>
          <td>
            <div class="action-buttons">
              <button class="action-btn view" onclick="window.viewTourDetails('${tour.id}')">
                <i class="fas fa-eye"></i>
              </button>
              <button class="action-btn edit" onclick="window.editTour('${tour.id}')">
                <i class="fas fa-edit"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    }
    
    toursList.innerHTML = html;
    
  } catch (error) {
    console.error('Error loading tours:', error);
    toursList.innerHTML = `
      <tr>
        <td colspan="8" class="text-center">
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Error loading tours: ${error.message}</p>
          </div>
        </td>
      </tr>
    `;
  }
}

// Filter tours based on search
function filterTours() {
  const searchInput = document.getElementById('tourSearchInput');
  const rows = document.querySelectorAll('#toursList tr');
  
  if (!searchInput || !rows.length) return;
  
  const searchText = searchInput.value.toLowerCase().trim();
  
  rows.forEach(row => {
    // Skip placeholder or loading rows
    if (!row.cells || row.cells.length < 4) return;
    
    const tourId = row.cells[0].textContent.toLowerCase();
    const tourName = row.cells[1].textContent.toLowerCase();
    const clientName = row.cells[2].textContent.toLowerCase();
    const guideName = row.cells[3].textContent.toLowerCase();
    const packageType = row.cells[4].textContent.toLowerCase();
    
    if (tourId.includes(searchText) || 
        tourName.includes(searchText) || 
        clientName.includes(searchText) ||
        guideName.includes(searchText) ||
        packageType.includes(searchText)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

// Open add tour modal
function openAddTourModal() {
  const modal = document.getElementById('tourEditModal');
  if (!modal) return;
  
  // Set modal title for adding
  document.getElementById('tourModalTitle').textContent = 'Add New Tour';
  
  // Clear form fields
  document.getElementById('tourId').value = '';
  document.getElementById('tourName').value = '';
  document.getElementById('tourStatus').value = 'Confirmed';
  document.getElementById('tourClientName').value = '';
  document.getElementById('tourClientId').value = '';
  document.getElementById('tourGuideName').value = '';
  document.getElementById('tourGuideId').value = '';
  document.getElementById('tourPackageType').value = 'Standard Package';
  document.getElementById('tourBookingId').value = '';
  document.getElementById('tourNotes').value = '';
  
  // Set dates to current dates
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('tourStartDate').value = today;
  document.getElementById('tourEndDate').value = '';
  
  // Set timestamps to show as new
  document.getElementById('tourCreatedAt').textContent = 'Will be created now';
  document.getElementById('tourUpdatedAt').textContent = 'Will be created now';
  
  // Show modal
  modal.classList.add('active');
  
  // Focus on first field
  document.getElementById('tourName').focus();
}

// View tour details
async function viewTourDetails(tourId) {
  console.log(`Viewing tour details for ${tourId}`);
  
  const modal = document.getElementById('tourDetailModal');
  const contentDiv = document.getElementById('tourDetailContent');
  
  if (!modal || !contentDiv) return;
  
  // Show loading
  contentDiv.innerHTML = `
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Loading tour details...</p>
    </div>
  `;
  
  modal.classList.add('active');
  
  try {
    // Fetch tour from Firestore
    const tourRef = doc(db, "tours", tourId);
    const tourDoc = await getDoc(tourRef);
    
    if (!tourDoc.exists()) {
      contentDiv.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-circle"></i>
          <p>Tour not found</p>
        </div>
      `;
      return;
    }
    
    const tour = tourDoc.data();
    
    // Format dates
    const createdDate = tour.createdAt?.seconds ? 
      new Date(tour.createdAt.seconds * 1000).toLocaleString() : 'Not available';
    
    const updatedDate = tour.updatedAt?.seconds ? 
      new Date(tour.updatedAt.seconds * 1000).toLocaleString() : 'Not available';
    
    // Get status class
    const statusClass = getStatusClass(tour.status);
    
    // Build HTML
    let html = `
      <div class="tour-detail-header">
        <h3>${tour.tourName || 'Unnamed Tour'}</h3>
        <div class="tour-detail-id">ID: ${tourId}</div>
        <div class="tour-detail-status">
          <span class="tour-status ${statusClass}">${tour.status || 'Confirmed'}</span>
        </div>
      </div>
      
      <div class="tour-detail-section">
        <h4>Tour Information</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">Package Type:</span>
            <span class="detail-value">${tour.packageType || 'Standard Package'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Booking ID:</span>
            <span class="detail-value">${tour.bookingId || 'Not linked'}</span>
          </div>
          ${tour.startDate ? `
          <div class="detail-item">
            <span class="detail-label">Start Date:</span>
            <span class="detail-value">${formatDate(tour.startDate)}</span>
          </div>` : ''}
          ${tour.endDate ? `
          <div class="detail-item">
            <span class="detail-label">End Date:</span>
            <span class="detail-value">${formatDate(tour.endDate)}</span>
          </div>` : ''}
        </div>
      </div>
      
      <div class="tour-detail-section">
        <h4>Client Information</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">Client Name:</span>
            <span class="detail-value">${tour.clientName || 'Unknown Client'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Client ID:</span>
            <span class="detail-value">${tour.clientId || 'Not available'}</span>
          </div>
        </div>
      </div>
      
      <div class="tour-detail-section">
        <h4>Guide Information</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">Guide Name:</span>
            <span class="detail-value">${tour.guideName || 'Unknown Guide'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Guide ID:</span>
            <span class="detail-value">${tour.guideId || 'Not available'}</span>
          </div>
        </div>
      </div>
      
      ${tour.notes ? `
      <div class="tour-detail-section">
        <h4>Notes</h4>
        <div class="detail-notes">${tour.notes}</div>
      </div>` : ''}
      
      <div class="tour-detail-section">
        <h4>Metadata</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">Created:</span>
            <span class="detail-value">${createdDate}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Last Updated:</span>
            <span class="detail-value">${updatedDate}</span>
          </div>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn-primary" onclick="window.editTour('${tourId}')">
          <i class="fas fa-edit"></i> Edit Tour
        </button>
        <button type="button" class="btn-cancel" onclick="window.closeModals()">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    `;
    
    contentDiv.innerHTML = html;
    
  } catch (error) {
    console.error('Error loading tour details:', error);
    contentDiv.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-exclamation-triangle"></i>
        <p>Error loading tour details: ${error.message}</p>
      </div>
    `;
  }
}

// Edit tour
async function editTour(tourId) {
  console.log(`Editing tour ${tourId}`);
  
  const modal = document.getElementById('tourEditModal');
  if (!modal) return;
  
  try {
    // Fetch tour from Firestore
    const tourRef = doc(db, "tours", tourId);
    const tourDoc = await getDoc(tourRef);
    
    if (!tourDoc.exists()) {
      alert('Tour not found!');
      return;
    }
    
    const tour = tourDoc.data();
    
    // Set modal title for editing
    document.getElementById('tourModalTitle').textContent = 'Edit Tour';
    
    // Fill form fields
    document.getElementById('tourId').value = tourId;
    document.getElementById('tourName').value = tour.tourName || '';
    document.getElementById('tourStatus').value = tour.status || 'Confirmed';
    document.getElementById('tourClientName').value = tour.clientName || '';
    document.getElementById('tourClientId').value = tour.clientId || '';
    document.getElementById('tourGuideName').value = tour.guideName || '';
    document.getElementById('tourGuideId').value = tour.guideId || '';
    document.getElementById('tourPackageType').value = tour.packageType || 'Standard Package';
    document.getElementById('tourBookingId').value = tour.bookingId || '';
    document.getElementById('tourNotes').value = tour.notes || '';
    
    // Format dates if available
    if (tour.startDate && tour.startDate.seconds) {
      const startDate = new Date(tour.startDate.seconds * 1000);
      document.getElementById('tourStartDate').value = startDate.toISOString().split('T')[0];
    } else {
      document.getElementById('tourStartDate').value = '';
    }
    
    if (tour.endDate && tour.endDate.seconds) {
      const endDate = new Date(tour.endDate.seconds * 1000);
      document.getElementById('tourEndDate').value = endDate.toISOString().split('T')[0];
    } else {
      document.getElementById('tourEndDate').value = '';
    }
    
    // Format timestamps
    document.getElementById('tourCreatedAt').textContent = tour.createdAt?.seconds ? 
      new Date(tour.createdAt.seconds * 1000).toLocaleString() : 'Not available';
    
    document.getElementById('tourUpdatedAt').textContent = tour.updatedAt?.seconds ? 
      new Date(tour.updatedAt.seconds * 1000).toLocaleString() : 'Not available';
    
    // Show modal
    modal.classList.add('active');
    
    // Focus on first field
    document.getElementById('tourName').focus();
    
  } catch (error) {
    console.error('Error loading tour for editing:', error);
    alert('Error loading tour: ' + error.message);
  }
}

// Save tour changes
async function saveTourChanges(event) {
  event.preventDefault();
  
  const saveBtn = document.getElementById('saveTourBtn');
  const tourId = document.getElementById('tourId').value;
  const isNewTour = !tourId;
  
  try {
    // Disable save button
    if (saveBtn) {
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    }
    
    // Get form values
    const tourData = {
      tourName: document.getElementById('tourName').value.trim() || 'Unnamed Tour',
      status: document.getElementById('tourStatus').value,
      clientName: document.getElementById('tourClientName').value.trim(),
      clientId: document.getElementById('tourClientId').value.trim(),
      guideName: document.getElementById('tourGuideName').value.trim(),
      guideId: document.getElementById('tourGuideId').value.trim(),
      packageType: document.getElementById('tourPackageType').value,
      bookingId: document.getElementById('tourBookingId').value.trim(),
      notes: document.getElementById('tourNotes').value.trim(),
      updatedAt: serverTimestamp()
    };
    
    // Add dates if provided
    const startDateInput = document.getElementById('tourStartDate').value;
    if (startDateInput) {
      tourData.startDate = new Date(startDateInput);
    }
    
    const endDateInput = document.getElementById('tourEndDate').value;
    if (endDateInput) {
      tourData.endDate = new Date(endDateInput);
    }
    
    // For new tours, add createdAt
    if (isNewTour) {
      tourData.createdAt = serverTimestamp();
    }
    
    if (isNewTour) {
      // Create new tour
      const tourRef = await addDoc(collection(db, "tours"), tourData);
      console.log(`Created new tour with ID: ${tourRef.id}`);
    } else {
      // Update existing tour
      await updateDoc(doc(db, "tours", tourId), tourData);
      console.log(`Updated tour with ID: ${tourId}`);
    }
    
    // Close modal
    closeModals();
    
    // Reload tours
    loadTours();
    
    // Show success message
    alert(`Tour ${isNewTour ? 'created' : 'updated'} successfully!`);
    
  } catch (error) {
    console.error('Error saving tour:', error);
    alert('Error saving tour: ' + error.message);
  } finally {
    // Re-enable save button
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.innerHTML = 'Save Changes';
    }
  }
}

// Helper functions
function getStatusClass(status) {
  if (!status) return 'status-confirmed';
  
  const statusLower = status.toLowerCase();
  
  if (statusLower === 'confirmed') {
    return 'status-confirmed';
  } else if (statusLower === 'in progress') {
    return 'status-inprogress';
  } else if (statusLower === 'completed') {
    return 'status-completed';
  } else if (statusLower === 'cancelled') {
    return 'status-cancelled';
  }
  
  return 'status-confirmed';
}

function getInitials(name) {
  if (!name) return 'NA';
  
  return name.split(' ')
    .map(part => part[0])
    .join('')
    .toUpperCase()
    .substring(0, 2);
}

function formatDate(dateObj) {
  if (!dateObj) return 'N/A';
  
  if (dateObj.seconds) {
    return new Date(dateObj.seconds * 1000).toLocaleDateString();
  }
  
  if (dateObj instanceof Date) {
    return dateObj.toLocaleDateString();
  }
  
  return 'N/A';
}

// Make functions available globally
window.viewTourDetails = viewTourDetails;
window.editTour = editTour;
window.openAddTourModal = openAddTourModal;
window.closeModals = closeModals;

// Initialize when the page loads
document.addEventListener('DOMContentLoaded', function() {
  // Check if we're on the tours section or should initialize for all sections
  enhanceToursSection();
  
  // Add click handler for the tours nav item
  const toursNavItem = document.querySelector('.nav-item[data-section="tours"]');
  if (toursNavItem) {
    toursNavItem.addEventListener('click', function() {
      // Reload tours when navigating to the section
      setTimeout(loadTours, 100);
    });
  }
});
// Real-time message updates for KenyaOnABudget Safari Admin Dashboard
// Add this code to your existing admin-dashboard.js or include as a separate script

// Global variables to track listeners and state
let messagesUnsubscribe = null;
let currentThreadUnsubscribe = null;
let lastMessageUpdate = Date.now();

// Function to setup real-time message listeners
function setupMessageListeners() {
    console.log("Setting up real-time message listeners...");
    
    // Unsubscribe from any existing listeners
    if (messagesUnsubscribe) {
        messagesUnsubscribe();
        messagesUnsubscribe = null;
    }
    
    try {
        // Get status filter if available
        const statusFilter = document.getElementById('messageStatusFilter')?.value || 'all';
        
        // Set up a listener for all messages
        const messagesRef = collection(db, "messages");
        
        // We want to listen to messages where recipient is "support"
        messagesUnsubscribe = onSnapshot(messagesRef, async (snapshot) => {
            // Avoid unnecessary updates during initial load
            if (Date.now() - lastMessageUpdate < 1000) {
                return;
            }
            
            console.log("Messages collection changed, processing updates...");
            
            if (snapshot.empty) return;
            
            // Track if we need to refresh the entire list
            let fullRefreshNeeded = false;
            let newMessageReceived = false;
            
            // Process changes
            snapshot.docChanges().forEach(async (change) => {
                const message = change.doc.data();
                message.id = change.doc.id;
                
                // Only care about support messages
                if (message.recipient !== "support") return;
                
                // Check if this is relevant based on our filter
                const isRelevant = statusFilter === 'all' || 
                    (statusFilter === 'unread' && !message.read) ||
                    (statusFilter === 'read' && message.read);
                
                if (!isRelevant) return;
                
                // Handle different types of changes
                if (change.type === "added") {
                    // New message added
                    newMessageReceived = !message.read;
                    await processNewMessage(message);
                    
                } else if (change.type === "modified") {
                    // Message updated (e.g., marked as read)
                    await processUpdatedMessage(message);
                    
                } else if (change.type === "removed") {
                    // Message deleted
                    fullRefreshNeeded = true;
                }
            });
            
            // Update unread counter if a new message was received
            if (newMessageReceived) {
                updateUnreadMessageCounter();
                
                // Play notification sound if enabled
                playNotificationSound();
            }
            
            // If major changes occurred, do a full refresh
            if (fullRefreshNeeded) {
                loadMessages();
            }
            
            // Update timestamp
            lastMessageUpdate = Date.now();
        }, 
        (error) => {
            console.error("Error listening for message updates:", error);
        });
        
        console.log("Real-time message listeners set up successfully");
    } catch (error) {
        console.error("Error setting up message listeners:", error);
    }
}

// Process a new message that's been added
async function processNewMessage(message) {
    // Check if this is a new thread or part of an existing thread
    const threadId = message.threadId || message.id;
    const messagesList = document.getElementById('supportMessagesList');
    
    if (!messagesList) return;
    
    // Check if this thread already exists in the list
    const existingThread = document.querySelector(`.message-item[data-thread-id="${threadId}"]`);
    
    if (existingThread) {
        // This is a new message in an existing thread
        // Update the existing thread item
        await updateExistingThreadItem(existingThread, message);
        
        // If this thread is currently open, update it
        if (currentMessageThreadId === threadId) {
            await appendNewMessageToThread(message);
        }
    } else {
        // This is a new thread - we may need to add it to the top of the list
        await addNewThreadItem(message);
    }
}

// Update an existing thread item with a new message
async function updateExistingThreadItem(threadItem, message) {
    // Get sender name
    let senderName = message.senderName || 'Unknown Sender';
    if (message.sender && message.sender !== 'support') {
        const clientName = await getClientName(message.sender);
        if (clientName && clientName !== message.sender) {
            senderName = clientName;
        }
    }
    
    // Update preview
    const previewText = message.content ? 
        (message.content.length > 60 ? message.content.substring(0, 60) + '...' : message.content) : 
        'No content';
    
    // Format time
    const timestamp = message.timestamp ? 
        formatTimeAgo(new Date(message.timestamp.seconds * 1000)) : 
        'Just now';
    
    // Update the thread item
    threadItem.setAttribute('data-id', message.id);
    threadItem.setAttribute('data-sender', message.sender || '');
    threadItem.setAttribute('data-sender-name', senderName);
    
    // Add unread indicator if not already present
    if (!message.read && !threadItem.classList.contains('unread')) {
        threadItem.classList.add('unread');
        
        // Add the unread indicator dot if not present
        if (!threadItem.querySelector('.message-status-dot')) {
            const metaDiv = threadItem.querySelector('.message-meta');
            if (metaDiv) {
                const dot = document.createElement('div');
                dot.className = 'message-status-dot';
                metaDiv.appendChild(dot);
            }
        }
    }
    
    // Update preview text
    const previewElement = threadItem.querySelector('.message-preview-text');
    if (previewElement) previewElement.textContent = previewText;
    
    // Update time
    const timeElement = threadItem.querySelector('.message-time');
    if (timeElement) timeElement.textContent = timestamp;
    
    // Move to top of the list (if not already there)
    const parent = threadItem.parentElement;
    if (parent && parent.firstChild !== threadItem) {
        parent.insertBefore(threadItem, parent.firstChild);
    }
}

// Add a new thread item to the list
async function addNewThreadItem(message) {
    const messagesList = document.getElementById('supportMessagesList');
    if (!messagesList) return;
    
    // Get sender name
    let senderName = message.senderName || 'Unknown Sender';
    if (message.sender && message.sender !== 'support') {
        const clientName = await getClientName(message.sender);
        if (clientName && clientName !== message.sender) {
            senderName = clientName;
        }
    }
    
    // Create initials
    const initials = senderName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
    
    // Format time
    const timestamp = message.timestamp ? 
        formatTimeAgo(new Date(message.timestamp.seconds * 1000)) : 
        'Just now';
    
    // Set message preview (truncate if too long)
    const previewText = message.content ? 
        (message.content.length > 60 ? message.content.substring(0, 60) + '...' : message.content) : 
        'No content';
    
    // Create a new thread item
    const threadItem = document.createElement('div');
    threadItem.className = `message-item ${message.read ? '' : 'unread'}`;
    threadItem.setAttribute('data-thread-id', message.threadId || message.id);
    threadItem.setAttribute('data-id', message.id);
    threadItem.setAttribute('data-sender', message.sender || '');
    threadItem.setAttribute('data-sender-name', senderName);
    threadItem.onclick = function() {
        window.viewThread(message.threadId || message.id, message.id);
    };
    
    threadItem.innerHTML = `
        <div class="message-avatar">${initials}</div>
        <div class="message-preview">
            <div class="message-name">${senderName}</div>
            <div class="message-subject">${message.subject || 'No subject'}</div>
            <div class="message-preview-text">${previewText}</div>
        </div>
        <div class="message-meta">
            <div class="message-time">${timestamp}</div>
            ${message.read ? '' : '<div class="message-status-dot"></div>'}
        </div>
    `;
    
    // Add to the top of the list
    if (messagesList.firstChild) {
        messagesList.insertBefore(threadItem, messagesList.firstChild);
    } else {
        messagesList.appendChild(threadItem);
    }
    
    // Remove empty state if present
    const emptyState = messagesList.querySelector('.empty-state');
    if (emptyState) {
        emptyState.remove();
    }
}

// Process an updated message
async function processUpdatedMessage(message) {
    // Find the message thread item
    const threadId = message.threadId || message.id;
    const threadItem = document.querySelector(`.message-item[data-thread-id="${threadId}"]`);
    
    if (!threadItem) return;
    
    // Update read status
    if (message.read) {
        threadItem.classList.remove('unread');
        const statusDot = threadItem.querySelector('.message-status-dot');
        if (statusDot) statusDot.remove();
    } else {
        threadItem.classList.add('unread');
        
        // Add the unread indicator dot if not present
        if (!threadItem.querySelector('.message-status-dot')) {
            const metaDiv = threadItem.querySelector('.message-meta');
            if (metaDiv) {
                const dot = document.createElement('div');
                dot.className = 'message-status-dot';
                metaDiv.appendChild(dot);
            }
        }
    }
    
    // If this message is currently open, update the 'mark as read' button
    if (currentMessageThreadId === threadId) {
        const markAsReadBtn = document.getElementById('markAsReadBtn');
        if (markAsReadBtn) {
            markAsReadBtn.style.display = message.read ? 'none' : 'inline-flex';
        }
    }
}

// Append a new message to the current thread view
async function appendNewMessageToThread(message) {
    if (!currentMessageThreadId) return;
    
    const thread = document.getElementById('messageThread');
    if (!thread) return;
    
    const isSupport = message.sender === 'support';
    
    // Format timestamp
    const timestamp = message.timestamp ? 
        new Date(message.timestamp.seconds * 1000).toLocaleString() : 
        'Just now';
    
    // Get sender name
    let senderDisplayName = isSupport ? 'Support Team' : (message.senderName || 'Unknown');
    if (!isSupport && message.sender) {
        const clientName = await getClientName(message.sender);
        if (clientName && clientName !== message.sender) {
            senderDisplayName = clientName;
        }
    }
    
    // Get sender initials
    const bubbleInitials = isSupport ? 'S' : 
        senderDisplayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
    
    // Create new message bubble
    const messageBubble = document.createElement('div');
    messageBubble.className = `message-bubble ${isSupport ? 'support' : 'client'}`;
    messageBubble.innerHTML = `
        <div class="message-bubble-avatar">${bubbleInitials}</div>
        <div class="message-bubble-content">
            <div class="message-bubble-header">
                <div class="message-bubble-name">${senderDisplayName}</div>
                <div class="message-bubble-time">${timestamp}</div>
            </div>
            <div class="message-bubble-text">${message.content || 'No content'}</div>
        </div>
    `;
    
    // Add to thread
    thread.appendChild(messageBubble);
    
    // Scroll to bottom
    thread.scrollTop = thread.scrollHeight;
}

// Set up real-time listener for current thread
function setupThreadListener(threadId) {
    console.log(`Setting up real-time listener for thread: ${threadId}`);
    
    // Unsubscribe from any existing thread listener
    if (currentThreadUnsubscribe) {
        currentThreadUnsubscribe();
        currentThreadUnsubscribe = null;
    }
    
    if (!threadId) return;
    
    try {
        // Set up listener for this thread
        const messagesRef = collection(db, "messages");
        const threadQuery = query(
            messagesRef,
            where("threadId", "==", threadId)
        );
        
        currentThreadUnsubscribe = onSnapshot(threadQuery, (snapshot) => {
            if (snapshot.empty) return;
            
            // Process changes
            snapshot.docChanges().forEach(async (change) => {
                const message = change.doc.data();
                message.id = change.doc.id;
                
                if (change.type === "added") {
                    // Check if this is actually a new message or just initial load
                    // We can check if the message element already exists in the DOM
                    const existingBubbles = document.querySelectorAll('.message-bubble');
                    let isNewMessage = true;
                    
                    if (message.timestamp) {
                        const messageTime = message.timestamp.seconds * 1000;
                        
                        // If message is older than 5 seconds, it's probably not new
                        if (Date.now() - messageTime > 5000) {
                            isNewMessage = false;
                        }
                    }
                    
                    if (isNewMessage) {
                        await appendNewMessageToThread(message);
                    }
                }
            });
        });
        
    } catch (error) {
        console.error(`Error setting up thread listener for ${threadId}:`, error);
    }
}

// Update the unread message counter in the dashboard
async function updateUnreadMessageCounter() {
    try {
        // Get count of unread messages
        const messagesRef = collection(db, "messages");
        const unreadQuery = query(
            messagesRef,
            where("recipient", "==", "support"),
            where("read", "==", false)
        );
        
        const unreadSnapshot = await getDocs(unreadQuery);
        const unreadCount = unreadSnapshot.size;
        
        // Update UI
        const unreadMessagesCount = document.getElementById('unreadMessagesCount');
        const supportMessagesBadge = document.getElementById('supportMessagesBadge');
        
        if (unreadMessagesCount) {
            unreadMessagesCount.textContent = unreadCount;
        }
        
        if (supportMessagesBadge) {
            supportMessagesBadge.textContent = unreadCount;
            supportMessagesBadge.style.display = unreadCount > 0 ? 'inline' : 'none';
        }
        
    } catch (error) {
        console.error('Error updating unread message counter:', error);
    }
}

// Play a notification sound for new messages
function playNotificationSound() {
    try {
        // Check if sound is enabled in settings (if you have settings)
        const soundEnabled = localStorage.getItem('notificationSound') !== 'disabled';
        
        if (!soundEnabled) return;
        
        // Create an audio element if it doesn't exist
        let notificationSound = document.getElementById('notificationSound');
        
        if (!notificationSound) {
            notificationSound = document.createElement('audio');
            notificationSound.id = 'notificationSound';
            notificationSound.src = 'notification.mp3'; // Replace with your sound file
            notificationSound.volume = 0.5;
            document.body.appendChild(notificationSound);
        }
        
        // Play the sound
        notificationSound.play().catch(error => {
            console.warn('Could not play notification sound:', error);
        });
        
    } catch (error) {
        console.warn('Error playing notification sound:', error);
    }
}

// Enhanced viewThread function with real-time updates
async function enhancedViewThread(threadId, messageId) {
    // Call the original viewThread function first
    if (typeof viewThreadWithScroll === 'function') {
        await viewThreadWithScroll(threadId, messageId);
    } else if (typeof window.viewThread === 'function' && window.viewThread !== enhancedViewThread) {
        const originalViewThread = window.viewThread;
        await originalViewThread(threadId, messageId);
    }
    
    // Set up real-time listener for this thread
    setupThreadListener(threadId);
}

// Initialize real-time functionality
function initializeRealTimeUpdates() {
    console.log("Initializing real-time updates...");
    
    // Set up message listeners
    setupMessageListeners();
    
    // Replace the original viewThread function with enhanced version
    if (window.viewThread && window.viewThread !== enhancedViewThread) {
        console.log("Enhancing viewThread with real-time updates");
        window.originalViewThread = window.viewThread;
        window.viewThread = enhancedViewThread;
    }
    
    // Update the unread counter on load
    updateUnreadMessageCounter();
    
    // Listen for filter changes and update listeners
    const messageStatusFilter = document.getElementById('messageStatusFilter');
    if (messageStatusFilter) {
        messageStatusFilter.addEventListener('change', () => {
            // Refresh listeners with new filter
            setupMessageListeners();
        });
    }
    
    console.log("Real-time updates initialized successfully");
}

// Call this function when the dashboard is initialized
document.addEventListener('DOMContentLoaded', function() {
    // Wait for Firebase to be fully initialized before setting up listeners
    let checkInterval = setInterval(function() {
        if (typeof db !== 'undefined' && typeof collection !== 'undefined' && typeof onSnapshot !== 'undefined') {
            clearInterval(checkInterval);
            console.log("Firebase detected, initializing real-time updates");
            initializeRealTimeUpdates();
        }
    }, 500);
    
    // Timeout after 10 seconds if Firebase isn't initialized
    setTimeout(function() {
        clearInterval(checkInterval);
    }, 10000);
});
// Function to mark all unread messages as read
async function markAllMessagesAsRead() {
    console.log("Marking all messages as read...");
    
    // Disable the button to prevent multiple clicks
    const markAllBtn = document.getElementById('markAllAsReadBtn');
    if (markAllBtn) {
        markAllBtn.disabled = true;
        markAllBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    }
    
    try {
        // Get all unread messages where the recipient is "support"
        const messagesRef = collection(db, "messages");
        const unreadQuery = query(
            messagesRef,
            where("recipient", "==", "support"),
            where("read", "==", false)
        );
        
        const unreadSnapshot = await getDocs(unreadQuery);
        
        console.log(`Found ${unreadSnapshot.size} unread messages`);
        
        if (unreadSnapshot.empty) {
            alert('No unread messages found!');
            return;
        }
        
        // Create a batch update
        const batch = writeBatch(db);
        
        // Add each document to the batch
        unreadSnapshot.forEach(doc => {
            batch.update(doc.ref, { read: true });
        });
        
        // Commit the batch
        await batch.commit();
        
        console.log('All messages marked as read');
        
        // Update UI
        document.querySelectorAll('.message-item.unread').forEach(item => {
            item.classList.remove('unread');
            const statusDot = item.querySelector('.message-status-dot');
            if (statusDot) statusDot.remove();
        });
        
        // Update unread count badges if they exist
        const supportMessagesBadge = document.getElementById('supportMessagesBadge');
        if (supportMessagesBadge) {
            supportMessagesBadge.textContent = '0';
        }
        
        const unreadMessagesCount = document.getElementById('unreadMessagesCount');
        if (unreadMessagesCount) {
            unreadMessagesCount.textContent = '0';
        }
        
        // Hide all "Mark as Read" buttons in open message threads
        const markAsReadBtn = document.getElementById('markAsReadBtn');
        if (markAsReadBtn) {
            markAsReadBtn.style.display = 'none';
        }
        
        // Show success message
        alert('All messages have been marked as read.');
        
    } catch (error) {
        console.error('Error marking all messages as read:', error);
        alert('Error: ' + error.message);
    } finally {
        // Re-enable the button
        if (markAllBtn) {
            markAllBtn.disabled = false;
            markAllBtn.innerHTML = '<i class="fas fa-check-double"></i> Mark All as Read';
        }
    }
}

// Function to add the "Mark All as Read" button to the messages section
function addMarkAllAsReadButton() {
    console.log("Adding Mark All as Read button...");
    
    // Find the messages list header
    const messagesListHeader = document.querySelector('.messages-list-header');
    if (!messagesListHeader) {
        console.error("Messages list header not found!");
        return;
    }
    
    // Check if the button already exists to avoid duplicates
    if (document.getElementById('markAllAsReadBtn')) {
        return;
    }
    
    // Create the button
    const markAllBtn = document.createElement('button');
    markAllBtn.id = 'markAllAsReadBtn';
    markAllBtn.className = 'mark-all-btn';
    markAllBtn.innerHTML = '<i class="fas fa-check-double"></i> Mark All as Read';
    markAllBtn.addEventListener('click', markAllMessagesAsRead);
    
    // Add styles for the button
    const style = document.createElement('style');
    style.textContent = `
        .mark-all-btn {
            background-color: #e67e22;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            transition: background-color 0.2s;
        }
        
        .mark-all-btn:hover {
            background-color: #d35400;
        }
        
        .mark-all-btn:disabled {
            background-color: #f0ad4e;
            cursor: not-allowed;
        }
        
        .messages-list-header {
            display: flex;
            flex-direction: column;
        }
        
        .messages-header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
    `;
    document.head.appendChild(style);
    
    // Modify the header structure to include the button
    const headerTitle = messagesListHeader.querySelector('h3');
    const messageFilters = messagesListHeader.querySelector('.message-filters');
    
    // Create a container for the header title and the new button
    const headerActions = document.createElement('div');
    headerActions.className = 'messages-header-actions';
    
    // Move existing elements and add new button
    if (headerTitle) messagesListHeader.removeChild(headerTitle);
    if (messageFilters) messagesListHeader.removeChild(messageFilters);
    
    headerActions.appendChild(headerTitle || document.createElement('h3'));
    headerActions.appendChild(markAllBtn);
    
    messagesListHeader.prepend(headerActions);
    if (messageFilters) messagesListHeader.appendChild(messageFilters);
    
    console.log("Mark All as Read button added successfully");
}

// Call the function when the messages section is loaded or when navigating to it
document.addEventListener('DOMContentLoaded', function() {
    // Add the button when the page loads
    setTimeout(addMarkAllAsReadButton, 1000);  // Slight delay to ensure the section is loaded
    
    // Also add it when navigating to the messages section
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function() {
            if (this.getAttribute('data-section') === 'support-messages') {
                setTimeout(addMarkAllAsReadButton, 500);
            }
        });
    });
    
    // For the quick access card to messages
    document.querySelectorAll('.quick-access-card').forEach(card => {
        card.addEventListener('click', function() {
            if (this.querySelector('h3')?.textContent.includes('Support Messages')) {
                setTimeout(addMarkAllAsReadButton, 500);
            }
        });
    });
});

// Make sure the function is available globally
window.markAllMessagesAsRead = markAllMessagesAsRead;

</script>
<script src="guide-section.js"></script>

<script type="module" src="admin-debug.js"></script>
    <script type="module" src="admin-dashboard.js"></script>
   
    
</body>
</html>